<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dundee Property Factor Map | Compare Factors Scotland</title>
    <meta name="description" content="Interactive map showing which property factors dominate each Dundee postcode district">
    
    <meta property="og:title" content="Dundee Property Factor Map">
    <meta property="og:description" content="See which property management companies dominate each area of Dundee">
    <meta property="og:type" content="website">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        #top-bar {
            position: fixed; top: 0; left: 0; right: 0;
            background: white; padding: 12px 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; align-items: center; gap: 16px;
        }
        #top-bar h1 {
            font-size: 18px; font-weight: 600; color: #1a1a1a;
        }
        #top-bar .subtitle {
            font-size: 13px; color: #666; margin-left: auto;
        }
        
        #search-box {
            padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; width: 200px;
        }
        #search-box:focus { outline: 2px solid #2563eb; border-color: transparent; }
        
        #search-results {
            position: fixed; top: 56px; left: 20px; width: 200px;
            background: white; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            max-height: 240px; overflow-y: auto; display: none; z-index: 1001;
        }
        .search-result {
            padding: 10px 14px; cursor: pointer; font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }
        .search-result:hover { background: #f5f5f5; }
        
        #hover-panel {
            position: fixed; top: 70px; left: 20px; width: 300px;
            background: white; border-radius: 12px; padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12); z-index: 1000;
            display: none; border-left: 5px solid #2563eb;
        }
        #hover-panel.visible { display: block; }
        #hover-panel.locked { border-left-width: 8px; }
        #hover-panel h3 { font-size: 22px; margin-bottom: 4px; color: #1a1a1a; }
        #hover-panel .lock-hint { font-size: 11px; color: #888; margin-bottom: 10px; display: none; }
        #hover-panel.locked .lock-hint { display: block; }
        #hover-panel .total { font-size: 13px; color: #666; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        
        .factor-row { display: flex; align-items: center; margin: 8px 0; font-size: 13px; }
        .factor-rank {
            width: 22px; height: 22px; border-radius: 50%; background: #e5e7eb;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 600; color: #374151; margin-right: 10px;
        }
        .factor-rank.rank-1 { background: #fbbf24; color: #1a1a1a; }
        .factor-color { width: 14px; height: 14px; border-radius: 4px; margin-right: 10px; }
        .factor-name { flex-grow: 1; color: #333; }
        .factor-stats { text-align: right; color: #666; font-size: 12px; }
        .factor-share { font-weight: 600; color: #1a1a1a; }
        
        #legend-panel {
            position: fixed; bottom: 20px; right: 20px; width: 280px;
            background: white; border-radius: 12px; padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12); z-index: 1000;
            max-height: calc(100vh - 100px); overflow-y: auto;
        }
        #legend-panel h2 { font-size: 15px; font-weight: 600; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .stats-row { display: flex; gap: 12px; margin-bottom: 14px; }
        .stat { text-align: center; flex: 1; padding: 10px; background: #f5f5f5; border-radius: 8px; }
        .stat-value { font-size: 18px; font-weight: 700; color: #1a1a1a; }
        .stat-label { font-size: 10px; color: #666; margin-top: 2px; }
        
        #legend-items { margin-top: 12px; }
        .legend-item {
            display: flex; align-items: center; margin: 8px 0; font-size: 12px;
        }
        .legend-color {
            width: 16px; height: 16px; border-radius: 4px; margin-right: 10px;
            flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1);
        }
        .legend-label { flex-grow: 1; color: #333; }
        .legend-count { color: #666; font-size: 11px; }
        
        .panel-drag-handle, .panel-close { display: none; }

        .loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; z-index: 2000;
            background: white; padding: 30px 40px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .loading.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb; border-top-color: #2563eb;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 640px) {
            #top-bar {
                flex-wrap: wrap; padding: 8px 12px; gap: 8px;
            }
            #top-bar h1 { font-size: 15px; }
            #top-bar .subtitle { display: none; }
            #search-box { width: 100%; order: 3; }
            #search-results { left: 12px; right: 12px; width: auto; top: 80px; }

            #hover-panel {
                position: fixed; top: auto; bottom: 0; left: 0; right: 0;
                width: 100%; border-radius: 16px 16px 0 0; padding: 14px 16px;
                max-height: 45vh; overflow-y: auto;
                border-left: none; border-top: 4px solid #2563eb;
            }
            #hover-panel.locked { border-left: none; border-top-width: 6px; }
            #hover-panel h3 { font-size: 18px; }
            .panel-drag-handle, .panel-close { display: block; }
            .panel-drag-handle {
                width: 36px; height: 4px; background: #ccc; border-radius: 2px;
                margin: 0 auto 10px;
            }
            .panel-close {
                position: absolute; top: 12px; right: 14px;
                background: none; border: none; font-size: 22px; color: #999;
                cursor: pointer; line-height: 1; padding: 4px;
            }

            #legend-panel {
                position: fixed; bottom: 0; left: 0; right: 0;
                width: 100%; border-radius: 16px 16px 0 0;
                max-height: 40vh; padding: 12px 16px;
                transform: translateY(calc(100% - 48px));
                transition: transform 0.3s ease;
            }
            #legend-panel.expanded { transform: translateY(0); }
            #legend-panel h2:first-child {
                cursor: pointer; position: relative; padding-right: 24px;
            }
            #legend-panel h2:first-child::after {
                content: '\25B2'; position: absolute; right: 0; top: 0;
                font-size: 12px; color: #666;
                transition: transform 0.3s ease;
            }
            #legend-panel.expanded h2:first-child::after {
                transform: rotate(180deg);
            }

            /* Hide legend when hover panel is open */
            #hover-panel.visible ~ #legend-panel { display: none; }
        }
    </style>
</head>
<body>
    <div id="top-bar">
        <h1>üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø Dundee Property Factor Map</h1>
        <input type="text" id="search-box" placeholder="Search postcode...">
        <div id="search-results"></div>
        <div class="subtitle">Click any district for details</div>
    </div>
    
    <div id="map"></div>
    
    <div id="hover-panel">
        <div class="panel-drag-handle"></div>
        <button class="panel-close" onclick="unlockDistrict()" aria-label="Close">&times;</button>
        <h3 id="district-name"></h3>
        <div class="lock-hint">Tap elsewhere or press Esc to close</div>
        <div class="total" id="district-total"></div>
        <div id="factor-list"></div>
    </div>
    
    <div id="legend-panel">
        <h2>Market Overview</h2>
        <div class="stats-row">
            <div class="stat">
                <div class="stat-value" id="stat-districts">-</div>
                <div class="stat-label">Districts</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-properties">-</div>
                <div class="stat-label">Properties</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-factors">-</div>
                <div class="stat-label">Factors</div>
            </div>
        </div>
        <h2>Top Factors</h2>
        <div id="legend-items"></div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading map...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const DISTRICT_DATA = {"DD1":{"total":2340,"factor":"Managing Estates Limited","count":511,"share":22,"topFactors":[{"factor":"Managing Estates Limited","count":511,"share":22},{"factor":"James Gibb Property Management Ltd","count":465,"share":20},{"factor":"Hillcrest Homes (Scotland) Ltd","count":411,"share":18},{"factor":"Ross & Liddell Ltd","count":282,"share":12},{"factor":"Dundee City Council","count":154,"share":7}],"allFactors":[{"factor":"Managing Estates Limited","count":511,"share":22},{"factor":"James Gibb Property Management Ltd","count":465,"share":20},{"factor":"Hillcrest Homes (Scotland) Ltd","count":411,"share":18},{"factor":"Ross & Liddell Ltd","count":282,"share":12},{"factor":"Dundee City Council","count":154,"share":7},{"factor":"Abertay Housing Association Ltd","count":100,"share":4},{"factor":"Alison Bruce Property Management Ltd","count":82,"share":4},{"factor":"Home Group Scotland","count":80,"share":3},{"factor":"Rockford Properties Ltd","count":69,"share":3},{"factor":"West One Property Management & Factoring Ltd","count":46,"share":2},{"factor":"Trinity Factoring Services Ltd","count":33,"share":1},{"factor":"Speirs Gumley Property Management Limited","count":23,"share":1},{"factor":"Newton Property Management Ltd","count":23,"share":1},{"factor":"Pavillion Properties Limited","count":19,"share":1},{"factor":"Pavillion Properties (Assets) Limited","count":16,"share":1},{"factor":"Taylor Martin Property Management Ltd","count":12,"share":1},{"factor":"Park Property Management Limited","count":8,"share":0},{"factor":"Redpath Bruce Property Management Limited","count":5,"share":0},{"factor":"FirstPort Property Services Scotland Limited","count":1,"share":0}]},"DD10":{"total":913,"factor":"Angus Housing Association Limited","count":328,"share":36,"topFactors":[{"factor":"Angus Housing Association Limited","count":328,"share":36},{"factor":"Ross & Liddell Ltd","count":256,"share":28},{"factor":"PMC Property Management & Lettings Ltd","count":91,"share":10},{"factor":"Newton Property Management Ltd","count":86,"share":9},{"factor":"Taylor Martin Property Management Ltd","count":74,"share":8}],"allFactors":[{"factor":"Angus Housing Association Limited","count":328,"share":36},{"factor":"Ross & Liddell Ltd","count":256,"share":28},{"factor":"PMC Property Management & Lettings Ltd","count":91,"share":10},{"factor":"Newton Property Management Ltd","count":86,"share":9},{"factor":"Taylor Martin Property Management Ltd","count":74,"share":8},{"factor":"Greenbelt Group Limited","count":71,"share":8},{"factor":"Hillcrest Homes (Scotland) Ltd","count":7,"share":1}]},"DD11":{"total":1901,"factor":"Hillcrest Homes (Scotland) Ltd","count":783,"share":41,"topFactors":[{"factor":"Hillcrest Homes (Scotland) Ltd","count":783,"share":41},{"factor":"James Gibb Property Management Ltd","count":482,"share":25},{"factor":"Angus Housing Association Limited","count":389,"share":20},{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":108,"share":6},{"factor":"Hacking & Paterson Management Services Limited","count":84,"share":4}],"allFactors":[{"factor":"Hillcrest Homes (Scotland) Ltd","count":783,"share":41},{"factor":"James Gibb Property Management Ltd","count":482,"share":25},{"factor":"Angus Housing Association Limited","count":389,"share":20},{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":108,"share":6},{"factor":"Hacking & Paterson Management Services Limited","count":84,"share":4},{"factor":"Maroco Limited","count":55,"share":3}]},"DD2":{"total":5178,"factor":"Dundee City Council","count":2191,"share":42,"topFactors":[{"factor":"Dundee City Council","count":2191,"share":42},{"factor":"Abertay Housing Association Ltd","count":610,"share":12},{"factor":"Taylor Martin Property Management Ltd","count":533,"share":10},{"factor":"James Gibb Property Management Ltd","count":408,"share":8},{"factor":"Ross & Liddell Ltd","count":254,"share":5}],"allFactors":[{"factor":"Dundee City Council","count":2191,"share":42},{"factor":"Abertay Housing Association Ltd","count":610,"share":12},{"factor":"Taylor Martin Property Management Ltd","count":533,"share":10},{"factor":"James Gibb Property Management Ltd","count":408,"share":8},{"factor":"Ross & Liddell Ltd","count":254,"share":5},{"factor":"Greenbelt Group Limited","count":222,"share":4},{"factor":"Managing Estates Limited","count":191,"share":4},{"factor":"FirstPort Property Services Scotland Limited","count":189,"share":4},{"factor":"Newton Property Management Ltd","count":149,"share":3},{"factor":"Hillcrest Homes (Scotland) Ltd","count":119,"share":2},{"factor":"Home Group Scotland","count":91,"share":2},{"factor":"Sanctuary Scotland Housing Association Ltd","count":72,"share":1},{"factor":"Caledonia Housing Association Limited","count":67,"share":1},{"factor":"Alison Bruce Property Management Ltd","count":23,"share":0},{"factor":"Wanrobe Investments Limited","count":20,"share":0},{"factor":"Pamsco Ltd","count":15,"share":0},{"factor":"Pavillion Properties (Assets) Limited","count":12,"share":0},{"factor":"Speirs Gumley Property Management Limited","count":6,"share":0},{"factor":"Direct Lettings (Scotland) Ltd","count":5,"share":0},{"factor":"Hacking & Paterson Management Services Limited","count":1,"share":0}]},"DD3":{"total":4161,"factor":"Dundee City Council","count":2490,"share":60,"topFactors":[{"factor":"Dundee City Council","count":2490,"share":60},{"factor":"Hacking & Paterson Management Services Limited","count":415,"share":10},{"factor":"Abertay Housing Association Ltd","count":410,"share":10},{"factor":"Hillcrest Homes (Scotland) Ltd","count":234,"share":6},{"factor":"Managing Estates Limited","count":196,"share":5}],"allFactors":[{"factor":"Dundee City Council","count":2490,"share":60},{"factor":"Hacking & Paterson Management Services Limited","count":415,"share":10},{"factor":"Abertay Housing Association Ltd","count":410,"share":10},{"factor":"Hillcrest Homes (Scotland) Ltd","count":234,"share":6},{"factor":"Managing Estates Limited","count":196,"share":5},{"factor":"James Gibb Property Management Ltd","count":131,"share":3},{"factor":"Robertson Property Management Limited","count":59,"share":1},{"factor":"Newton Property Management Ltd","count":59,"share":1},{"factor":"Trinity Factoring Services Ltd","count":32,"share":1},{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":26,"share":1},{"factor":"Caledonia Housing Association Limited","count":19,"share":0},{"factor":"David Robin Wardhaugh","count":18,"share":0},{"factor":"Palms Property Management Ltd","count":16,"share":0},{"factor":"Angus Housing Association Limited","count":16,"share":0},{"factor":"Pavillion Properties (Assets) Limited","count":12,"share":0},{"factor":"Pavillion Properties Limited","count":10,"share":0},{"factor":"Ross & Liddell Ltd","count":9,"share":0},{"factor":"Home Group Scotland","count":6,"share":0},{"factor":"Fior Asset and Property Limited","count":2,"share":0},{"factor":"Westburn Services Ltd","count":1,"share":0}]},"DD4":{"total":7181,"factor":"Abertay Housing Association Ltd","count":2855,"share":40,"topFactors":[{"factor":"Abertay Housing Association Ltd","count":2855,"share":40},{"factor":"Dundee City Council","count":2495,"share":35},{"factor":"Hillcrest Homes (Scotland) Ltd","count":529,"share":7},{"factor":"James Gibb Property Management Ltd","count":414,"share":6},{"factor":"Alison Bruce Property Management Ltd","count":211,"share":3}],"allFactors":[{"factor":"Abertay Housing Association Ltd","count":2855,"share":40},{"factor":"Dundee City Council","count":2495,"share":35},{"factor":"Hillcrest Homes (Scotland) Ltd","count":529,"share":7},{"factor":"James Gibb Property Management Ltd","count":414,"share":6},{"factor":"Alison Bruce Property Management Ltd","count":211,"share":3},{"factor":"PMC Property Management & Lettings Ltd","count":189,"share":3},{"factor":"Ross & Liddell Ltd","count":176,"share":2},{"factor":"Robertson Property Management Limited","count":118,"share":2},{"factor":"Managing Estates Limited","count":42,"share":1},{"factor":"Hacking & Paterson Management Services Limited","count":40,"share":1},{"factor":"Home Group Scotland","count":38,"share":1},{"factor":"Simply Factors Limited","count":35,"share":0},{"factor":"Pavillion Properties (Assets) Limited","count":22,"share":0},{"factor":"Taylor Martin Property Management Ltd","count":9,"share":0},{"factor":"Pavillion Properties Limited","count":8,"share":0}]},"DD5":{"total":2843,"factor":"James Gibb Property Management Ltd","count":591,"share":21,"topFactors":[{"factor":"James Gibb Property Management Ltd","count":591,"share":21},{"factor":"Greenbelt Group Limited","count":546,"share":19},{"factor":"Ross & Liddell Ltd","count":499,"share":18},{"factor":"Dundee City Council","count":308,"share":11},{"factor":"Angus Housing Association Limited","count":190,"share":7}],"allFactors":[{"factor":"James Gibb Property Management Ltd","count":591,"share":21},{"factor":"Greenbelt Group Limited","count":546,"share":19},{"factor":"Ross & Liddell Ltd","count":499,"share":18},{"factor":"Dundee City Council","count":308,"share":11},{"factor":"Angus Housing Association Limited","count":190,"share":7},{"factor":"Newton Property Management Ltd","count":159,"share":6},{"factor":"Taylor Martin Property Management Ltd","count":122,"share":4},{"factor":"Robertson Property Management Limited","count":100,"share":4},{"factor":"Managing Estates Limited","count":97,"share":3},{"factor":"Hillcrest Homes (Scotland) Ltd","count":81,"share":3},{"factor":"Caledonia Housing Association Limited","count":50,"share":2},{"factor":"Trinity Factoring Services Ltd","count":26,"share":1},{"factor":"Hacking & Paterson Management Services Limited","count":24,"share":1},{"factor":"Pamsco Ltd","count":18,"share":1},{"factor":"Charles White Limited","count":17,"share":1},{"factor":"Palms Property Management Ltd","count":8,"share":0},{"factor":"Westburn Services Ltd","count":7,"share":0}]},"DD6":{"total":251,"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":120,"share":48,"topFactors":[{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":120,"share":48},{"factor":"Trinity Factoring Services Ltd","count":48,"share":19},{"factor":"Kingdom Housing Association Ltd","count":45,"share":18},{"factor":"Caledonia Housing Association Limited","count":37,"share":15},{"factor":"FirstPort Property Services Scotland Limited","count":1,"share":0}],"allFactors":[{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":120,"share":48},{"factor":"Trinity Factoring Services Ltd","count":48,"share":19},{"factor":"Kingdom Housing Association Ltd","count":45,"share":18},{"factor":"Caledonia Housing Association Limited","count":37,"share":15},{"factor":"FirstPort Property Services Scotland Limited","count":1,"share":0}]},"DD7":{"total":712,"factor":"Ross & Liddell Ltd","count":285,"share":40,"topFactors":[{"factor":"Ross & Liddell Ltd","count":285,"share":40},{"factor":"Trinity Factoring Services Ltd","count":100,"share":14},{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":73,"share":10},{"factor":"Pamsco Ltd","count":68,"share":10},{"factor":"Caledonia Housing Association Limited","count":66,"share":9}],"allFactors":[{"factor":"Ross & Liddell Ltd","count":285,"share":40},{"factor":"Trinity Factoring Services Ltd","count":100,"share":14},{"factor":"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED","count":73,"share":10},{"factor":"Pamsco Ltd","count":68,"share":10},{"factor":"Caledonia Housing Association Limited","count":66,"share":9},{"factor":"James Gibb Property Management Ltd","count":46,"share":6},{"factor":"Newton Property Management Ltd","count":32,"share":4},{"factor":"Angus Housing Association Limited","count":30,"share":4},{"factor":"Hacking & Paterson Management Services Limited","count":12,"share":2}]},"DD8":{"total":1263,"factor":"Hacking & Paterson Management Services Limited","count":644,"share":51,"topFactors":[{"factor":"Hacking & Paterson Management Services Limited","count":644,"share":51},{"factor":"Angus Housing Association Limited","count":281,"share":22},{"factor":"Newton Property Management Ltd","count":100,"share":8},{"factor":"Maroco Limited","count":66,"share":5},{"factor":"Hillcrest Homes (Scotland) Ltd","count":40,"share":3}],"allFactors":[{"factor":"Hacking & Paterson Management Services Limited","count":644,"share":51},{"factor":"Angus Housing Association Limited","count":281,"share":22},{"factor":"Newton Property Management Ltd","count":100,"share":8},{"factor":"Maroco Limited","count":66,"share":5},{"factor":"Hillcrest Homes (Scotland) Ltd","count":40,"share":3},{"factor":"Vista Properties and Development Ltd","count":31,"share":2},{"factor":"FirstPort Property Services Scotland Limited","count":31,"share":2},{"factor":"James Gibb Property Management Ltd","count":25,"share":2},{"factor":"Abertay Housing Association Ltd","count":16,"share":1},{"factor":"Direct Lettings (Scotland) Ltd","count":12,"share":1},{"factor":"Ross & Liddell Ltd","count":9,"share":1},{"factor":"Caledonia Housing Association Limited","count":8,"share":1}]},"DD9":{"total":510,"factor":"Angus Housing Association Limited","count":261,"share":51,"topFactors":[{"factor":"Angus Housing Association Limited","count":261,"share":51},{"factor":"Newton Property Management Ltd","count":145,"share":28},{"factor":"Scottish Woodlands Ltd","count":102,"share":20},{"factor":"Caledonia Housing Association Limited","count":2,"share":0}],"allFactors":[{"factor":"Angus Housing Association Limited","count":261,"share":51},{"factor":"Newton Property Management Ltd","count":145,"share":28},{"factor":"Scottish Woodlands Ltd","count":102,"share":20},{"factor":"Caledonia Housing Association Limited","count":2,"share":0}]}};
        const FACTOR_TOTALS = {"Managing Estates Limited":1037,"James Gibb Property Management Ltd":2562,"Hillcrest Homes (Scotland) Ltd":2204,"Ross & Liddell Ltd":1770,"Dundee City Council":7638,"Abertay Housing Association Ltd":3991,"Alison Bruce Property Management Ltd":316,"Home Group Scotland":215,"Rockford Properties Ltd":69,"West One Property Management & Factoring Ltd":46,"Trinity Factoring Services Ltd":239,"Speirs Gumley Property Management Limited":29,"Newton Property Management Ltd":753,"Pavillion Properties Limited":37,"Pavillion Properties (Assets) Limited":62,"Taylor Martin Property Management Ltd":750,"Park Property Management Limited":8,"Redpath Bruce Property Management Limited":5,"FirstPort Property Services Scotland Limited":222,"Angus Housing Association Limited":1495,"PMC Property Management & Lettings Ltd":280,"Greenbelt Group Limited":839,"FIRSTPORT PROPERTY SERVICES NO.17 LIMITED":327,"Hacking & Paterson Management Services Limited":1220,"Maroco Limited":121,"Sanctuary Scotland Housing Association Ltd":72,"Caledonia Housing Association Limited":249,"Wanrobe Investments Limited":20,"Pamsco Ltd":101,"Direct Lettings (Scotland) Ltd":17,"Robertson Property Management Limited":277,"David Robin Wardhaugh":18,"Palms Property Management Ltd":24,"Fior Asset and Property Limited":2,"Westburn Services Ltd":8,"Simply Factors Limited":35,"Charles White Limited":17,"Kingdom Housing Association Ltd":45,"Vista Properties and Development Ltd":31,"Scottish Woodlands Ltd":102};
        
        const COLORS = [
            '#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00',
            '#a65628', '#f781bf', '#66c2a5', '#fc8d62', '#8da0cb',
            '#e78ac3', '#a6d854', '#ffd92f', '#e5c494', '#b3b3b3'
        ];
        
        let map, geojsonLayer, allFeatures = [];
        let factorColors = {};
        let lockedDistrict = null;
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        }
        
        function assignColors() {
            const sorted = Object.entries(FACTOR_TOTALS).sort((a, b) => b[1] - a[1]);
            sorted.forEach((entry, i) => {
                if (i < COLORS.length) {
                    factorColors[entry[0]] = COLORS[i];
                } else {
                    factorColors[entry[0]] = COLORS[hashString(entry[0]) % COLORS.length];
                }
            });
        }
        
        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        function styleFeature(feature) {
            const data = feature.properties.data;
            let fillColor, fillOpacity;
            
            if (data.share >= 50) {
                fillColor = factorColors[data.factor] || '#ccc';
                fillOpacity = 0.8;
            } else if (data.share >= 25) {
                fillColor = factorColors[data.factor] || '#ccc';
                fillOpacity = 0.55;
            } else {
                fillColor = '#aaaaaa';
                fillOpacity = 0.4;
            }
            
            return {
                fillColor,
                fillOpacity,
                weight: 1.5,
                color: '#444',
                opacity: 1
            };
        }
        
        function highlightFeature(layer) {
            layer.setStyle({ weight: 3, color: '#000', fillOpacity: 0.9 });
            showPanel(layer.feature.properties);
        }
        
        function resetHighlight(layer) {
            if (lockedDistrict !== layer.feature.properties.district) {
                layer.setStyle(styleFeature(layer.feature));
                if (!lockedDistrict) {
                    document.getElementById('hover-panel').classList.remove('visible');
                }
            }
        }
        
        function showPanel(props) {
            const panel = document.getElementById('hover-panel');
            document.getElementById('district-name').textContent = props.district;
            document.getElementById('district-total').textContent = `${props.data.total.toLocaleString()} properties managed`;
            
            const list = document.getElementById('factor-list');
            list.innerHTML = props.data.topFactors.slice(0, 5).map((f, i) => `
                <div class="factor-row">
                    <div class="factor-rank ${i === 0 ? 'rank-1' : ''}">${i + 1}</div>
                    <div class="factor-color" style="background: ${factorColors[f.factor] || '#ccc'}"></div>
                    <div class="factor-name">${truncate(f.factor, 22)}</div>
                    <div class="factor-stats">
                        <span class="factor-share">${f.share}%</span>
                        (${f.count.toLocaleString()})
                    </div>
                </div>
            `).join('');
            
            panel.classList.add('visible');
        }
        
        function lockDistrict(layer) {
            if (lockedDistrict) {
                geojsonLayer.eachLayer(l => {
                    if (l.feature.properties.district === lockedDistrict) l.setStyle(styleFeature(l.feature));
                });
            }
            lockedDistrict = layer.feature.properties.district;
            highlightFeature(layer);
            document.getElementById('hover-panel').classList.add('locked');
        }
        
        function unlockDistrict() {
            if (lockedDistrict) {
                geojsonLayer.eachLayer(l => {
                    if (l.feature.properties.district === lockedDistrict) l.setStyle(styleFeature(l.feature));
                });
            }
            lockedDistrict = null;
            document.getElementById('hover-panel').classList.remove('visible', 'locked');
        }
        
        function updateStats() {
            const bounds = map.getBounds();
            const visible = {};
            let districtCount = 0;
            
            geojsonLayer.eachLayer(layer => {
                if (bounds.intersects(layer.getBounds())) {
                    districtCount++;
                    const data = layer.feature.properties.data;
                    for (const f of data.allFactors || []) {
                        visible[f.factor] = (visible[f.factor] || 0) + f.count;
                    }
                }
            });
            
            const totalProps = Object.values(visible).reduce((s, c) => s + c, 0);
            document.getElementById('stat-districts').textContent = districtCount;
            document.getElementById('stat-properties').textContent = totalProps.toLocaleString();
            document.getElementById('stat-factors').textContent = Object.keys(visible).length;
            
            const sorted = Object.entries(visible).sort((a, b) => b[1] - a[1]).slice(0, 10);
            document.getElementById('legend-items').innerHTML = sorted.map(([factor, count]) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${factorColors[factor] || '#999'}"></div>
                    <div class="legend-label">${truncate(factor, 20)}</div>
                    <div class="legend-count">${count.toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        function setupSearch() {
            const input = document.getElementById('search-box');
            const results = document.getElementById('search-results');
            
            input.addEventListener('input', e => {
                const q = e.target.value.toUpperCase().trim();
                if (q.length < 1) { results.style.display = 'none'; return; }
                
                const matches = allFeatures.filter(f => f.properties.district.toUpperCase().startsWith(q)).slice(0, 8);
                if (matches.length === 0) { results.style.display = 'none'; return; }
                
                results.innerHTML = matches.map(m => `<div class="search-result" data-district="${m.properties.district}">${m.properties.district}</div>`).join('');
                results.style.display = 'block';
            });
            
            results.addEventListener('click', e => {
                const district = e.target.dataset.district;
                if (district) {
                    geojsonLayer.eachLayer(layer => {
                        if (layer.feature.properties.district === district) {
                            map.fitBounds(layer.getBounds(), { maxZoom: 13 });
                            lockDistrict(layer);
                        }
                    });
                    results.style.display = 'none';
                    input.value = '';
                }
            });
            
            document.addEventListener('click', e => {
                if (!e.target.closest('#search-box') && !e.target.closest('#search-results')) {
                    results.style.display = 'none';
                }
            });
        }
        
        async function loadBoundaries() {
            try {
                
            const response = await fetch('https://raw.githubusercontent.com/missinglink/uk-postcode-polygons/master/geojson/DD.geojson');
            const geojson = await response.json();
            
            allFeatures = geojson.features.filter(f => {
                const district = f.properties?.name || f.properties?.Name;
                return district && DISTRICT_DATA[district];
            }).map(f => {
                const district = f.properties?.name || f.properties?.Name;
                f.properties.district = district;
                f.properties.data = DISTRICT_DATA[district];
                return f;
            });
                
                geojsonLayer = L.geoJSON({ type: 'FeatureCollection', features: allFeatures }, {
                    style: styleFeature,
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            mouseover: () => { if (!isTouch && !lockedDistrict) highlightFeature(layer); },
                            mouseout: () => { if (!isTouch) resetHighlight(layer); },
                            click: () => {
                                if (lockedDistrict === feature.properties.district) unlockDistrict();
                                else lockDistrict(layer);
                            }
                        });
                    }
                }).addTo(map);
                
                map.fitBounds(geojsonLayer.getBounds(), { padding: [50, 50] });
                updateStats();
                document.getElementById('loading').classList.add('hidden');
                
            } catch (e) {
                console.error('Failed to load boundaries:', e);
                document.getElementById('loading').innerHTML = '<div>Failed to load map data</div>';
            }
        }
        
        async function init() {
            map = L.map('map', {
                center: [56.46, -2.97],
                zoom: 10,
                zoomControl: true
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap, &copy; CARTO'
            }).addTo(map);
            
            assignColors();
            setupSearch();
            await loadBoundaries();
            
            map.on('moveend', updateStats);
            document.addEventListener('keydown', e => { if (e.key === 'Escape') unlockDistrict(); });

            // Mobile: toggle legend panel
            const legendPanel = document.getElementById('legend-panel');
            const legendTitle = legendPanel.querySelector('h2');
            if (legendTitle) {
                legendTitle.addEventListener('click', () => {
                    legendPanel.classList.toggle('expanded');
                });
            }
        }

        init();
    </script>
</body>
</html>