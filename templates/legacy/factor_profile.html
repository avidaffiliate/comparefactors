{#
Factor Profile Template v5.23 - Fee data removed, WSS link preserved
Inherits: header, footer, navigation, base styles from base.html

v5.23 Changes:
- Removed Fee Information section (fee data too unreliable for display)
- Removed Service Commitments section (fee data too unreliable for display)
- WSS document link preserved in sidebar (links to actual PDF)
- Coverage areas now use coverage_areas_list (pre-split list) instead of profile.coverage_areas.split()
- Removed "operating primarily in" text from verdict (coverage areas are alphabetical, not by property count)
- Registry link now uses registry_url for specific factor page
- WSS indicator and button now check wss_url instead of wss object
- Updated FAQ schema to remove fee references

v5.22 Changes:
- Added full Companies House section with status, incorporated, directors, tenure, accounts status
- Added insolvency history and outstanding charges warnings
- Fixed cases_by_year trend chart (was not being populated)
- Fixed complaint_categories population
- Fixed google_places contact info (phone, address) population
- Removed TPI Scotland membership from schema.org and Accreditation sidebar

v5.21 Changes:
- Added review snippets with actual review text, author, date, rating
- Added combined rating explanation ("4.2★ weighted average...")
- Added Rate per 10k properties metric with tooltip in Tribunal section
- Added benchmark indicator "(avg 47%)" after upheld rate
- Added Cases by Year trend chart with bar visualization and PFEO overlay
- Added severity badges (low/medium/high/critical) on case cards
- Added case summary text in addition to key quotes
- Enhanced outcome badge logic for better classification
- Added case links (PDF or HPC) on each case card

v5.20 Changes:
- Restored WSS document link and Companies House link in Data Sources sidebar
- Restored WSS indicator in Data Sources checklist
- Added Service Commitments section (response time, online portal, notice period, billing cycle)
- Added NOPLI warning banner in Fees section
- Fixed missing external source links

v5.19 Changes:
- Refactored to use Jinja2 template inheritance with base.html
- Removed duplicate header/footer/nav (now inherited from base.html)
- Removed duplicate CSS variables and base styles
- Page-specific styles moved to {% block styles %}
- Main content wrapped in {% block content %}
- Page-specific scripts moved to {% block scripts %}

Required data context:
- profile: Row from v_factor_profiles view
- at_a_glance: Parsed JSON {bullets: [...], overall_sentiment: ..., summary: ...}
- wss_url: URL to the WSS PDF document (or None if not available)
- registry_url: URL to specific factor page on Property Factor Register
- coverage_areas_list: Pre-split list of coverage areas
- recent_reviews: List of reviews (with review_text, author_name, review_date, rating, platform for snippets)
- google_places: Dict with contact info (phone, address, place_id)
- google_locations: List of Google locations [{name, rating, review_count, place_id, address}]
- trustpilot: Dict with url
- tribunal_last_5_years: Dict stats (including rate_per_10k)
- tribunal_full_history: Dict stats (including first_case_year)
- cases_by_year: List for trend chart [{year, cases, pfeos}]
- recent_cases: List of cases (with summary, severity_score, key_quote/quote)
- complaint_categories: Dict
- similar_factors: List
- generated_date: Date string
- current_year: Current year for footer copyright
#}

{% extends "base.html" %}

{% block title %}{{ profile.name }} | Compare Factors Scotland{% endblock %}

{% block meta %}
    <meta name="description" content="{% if profile.status != 'registered' %}Historical profile for {{ profile.name }} (registration expired). {% else %}Independent profile for {{ profile.name }}. Tribunal rating: {{ profile.risk_band|default('CLEAN') }}. {% endif %}Reviews, fees, and registration status. Compare Scottish property factors.">
    <link rel="canonical" href="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">
    <meta property="og:title" content="{{ profile.name }} - Property Factor Profile | Compare Factors">
    <meta property="og:description" content="{% if profile.risk_band %}{{ profile.risk_band }} tribunal rating. {% endif %}{% if profile.combined_rating %}{{ "%.1f"|format(profile.combined_rating) }}★ average review rating. {% endif %}Independent comparison data for Scottish property factors.">
    <meta property="og:image" content="https://comparefactors.co.uk/images/og-factor-profile.png">
    <meta name="twitter:card" content="summary_large_image">

    <!-- ==================== DYNAMIC SEO SCHEMA ==================== -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "RealEstateAgent",
          "@id": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/#organization",
          "name": "{{ profile.name }}",
          {% if profile.registration_number %}
          "image": "https://comparefactors.co.uk/images/factors/{{ profile.registration_number|lower }}.jpg",
          {% endif %}
          "description": "Property factor profile for {{ profile.name }} ({{ profile.registration_number }}). Risk rating: {{ profile.risk_band }}. Managed properties: {{ profile.property_count }}. Services include block management, insurance administration, and repairs.",
          "url": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/",
          {% if google_places and google_places.phone %}
          "telephone": "{{ google_places.phone }}",
          {% endif %}
          {% if google_places and google_places.address %}
          "address": {
            "@type": "PostalAddress",
            "streetAddress": "{{ google_places.address.split(',')[0] if ',' in google_places.address else google_places.address }}",
            "addressLocality": "{{ google_places.address.split(',')[-2].strip() if google_places.address.split(',')|length > 2 else 'Scotland' }}",
            "postalCode": "{{ google_places.address.split(',')[-1].strip() if ',' in google_places.address else '' }}",
            "addressCountry": "GB"
          },
          {% endif %}
          
          {% if coverage_areas_list %}
          "areaServed": [
            {% for area in coverage_areas_list[:15] %}
            {% set clean_area = area.strip().replace('"', '').replace('&#34;', '') %}
            {"@type": "City", "name": "{{ clean_area }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          {% endif %}

          "hasOfferCatalog": {
            "@type": "OfferCatalog",
            "name": "Property Factoring Services",
            "itemListElement": [
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Block Management" } },
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Building Insurance Administration" } },
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Emergency Repairs" } }
            ]
          },

          "priceRange": "££",

          {% set total_reviews = (profile.google_review_count|default(0)) + (profile.trustpilot_review_count|default(0)) %}
          {% if profile.combined_rating and total_reviews > 0 %}
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ "%.1f"|format(profile.combined_rating) }}",
            "reviewCount": "{{ total_reviews }}",
            "bestRating": "5",
            "worstRating": "1"
          },
          {% endif %}

          "knowsAbout": "Property Factoring Act (Scotland) 2011"
        },
        
        {
          "@type": "BreadcrumbList",
          "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://comparefactors.co.uk/" },
            { "@type": "ListItem", "position": 2, "name": "Factors", "item": "https://comparefactors.co.uk/factors/" },
            { "@type": "ListItem", "position": 3, "name": "{{ profile.name }}", "item": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/" }
          ]
        },

        {
          "@type": "FAQPage",
          "mainEntity": [
            {
              "@type": "Question",
              "name": "Has {{ profile.name }} had any tribunal cases?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "{% if tribunal_last_5_years.case_count > 0 %}Yes, {{ profile.name }} has had {{ tribunal_last_5_years.case_count }} tribunal cases in the last 5 years, with {{ tribunal_last_5_years.complaints_upheld_pct|default(0)|int }}% of complaints upheld.{% elif tribunal_full_history.case_count > 0 %}{{ profile.name }} has tribunal history, but no cases in the last 5 years.{% else %}No, {{ profile.name }} has no tribunal cases on record with the Housing & Property Chamber.{% endif %}"
              }
            },
            {
                "@type": "Question",
                "name": "How much does {{ profile.name }} charge?",
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": "Fee information for {{ profile.name }} varies by development. Factors typically charge between £120 and £350 per year for management fees. Request a quote directly from the factor for accurate pricing, or view their Written Statement of Services if available."
                }
            },
            {
              "@type": "Question",
              "name": "How do I make a complaint about {{ profile.name }}?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "First, raise your complaint directly with {{ profile.name }} using their formal complaints procedure (required by law to be in their Written Statement of Services). If unresolved after 8 weeks, you can apply to the Housing & Property Chamber. Visit housingandpropertychamber.scot to start an application."
              }
            }
            {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
            ,{
                "@type": "Question",
                "name": "How do I switch away from {{ profile.name }}?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "To change property factors, you'll need a majority vote from property owners in your development (typically at an AGM or EGM). The new factor must be registered with the Scottish Property Factor Register. Our switching guide explains the full process step-by-step."
                }
            }
            {% endif %}
          ]
        }
      ]
    }
    </script>
{% endblock %}

{% block styles %}
<style>
    /* ==================== PAGE-SPECIFIC CSS VARIABLES ==================== */
    :root {
        /* Teal for charts */
        --teal-500: #14b8a6;
        --teal-600: #0d9488;
        
        /* Additional status colors not in base */
        --indigo-600: #4f46e5;
        --indigo-100: #e0e7ff;
        --indigo-50: #eef2ff;
        
        /* Grey for expired/inactive */
        --gray-600: #4b5563;
        --gray-500: #6b7280;
        --gray-100: #f3f4f6;
        
        /* Amber additions */
        --amber-50: #fffbeb;
        --amber-200: #fde68a;
        --amber-800: #92400e;
        
        /* Text sizes */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        /* Borders */
        --radius-sm: 8px;
        --radius-md: 10px;
        --radius-lg: 16px;
    }
    
    /* ==================== LAYOUT ==================== */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    
    .profile-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: var(--space-xl);
        align-items: start;
        padding: var(--space-xl) 0;
    }
    
    @media (max-width: 968px) {
        .profile-layout {
            grid-template-columns: 1fr;
        }
        .sidebar { order: 2; }
        .main-content { order: 1; }
    }
    
    /* ==================== BREADCRUMB OVERRIDE ==================== */
    .breadcrumb {
        padding: var(--space-md) 0;
        font-size: var(--text-sm);
        color: var(--slate-500);
    }
    .breadcrumb a { color: var(--slate-500); }
    .breadcrumb a:hover { color: var(--navy-900); }
    .breadcrumb span { margin: 0 var(--space-sm); }
    
    /* ==================== ALERT BANNERS ==================== */
    .alert-banner {
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        font-size: var(--text-sm);
        line-height: 1.5;
    }
    
    .alert-banner svg {
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .alert-banner-content {
        flex: 1;
    }
    
    .alert-banner-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .alert-banner--expired {
        background: var(--gray-100);
        border: 1px solid var(--slate-300);
        color: var(--gray-600);
    }
    
    .alert-banner--info {
        background: var(--blue-100);
        border: 1px solid #93c5fd;
        color: var(--blue-700);
    }
    
    /* ==================== PROFILE HEADER ==================== */
    .profile-header {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--space-xl) 28px;
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--slate-200);
    }
    
    .profile-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
    }
    
    .profile-identity h1 {
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--navy-950);
        margin-bottom: var(--space-xs);
    }
    
    .profile-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
        color: var(--slate-500);
    }
    
    .profile-meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }
    
    /* Risk Badge - Page-specific override */
    .risk-badge {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-sm);
        font-weight: 600;
        text-align: center;
        min-width: 100px;
    }
    
    .risk-badge-main {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    
    .risk-badge-reason {
        font-size: var(--text-xs);
        font-weight: 500;
        opacity: 0.85;
        margin-top: 2px;
        text-transform: none;
        letter-spacing: 0;
    }
    
    .risk-badge.clean, .risk-badge--clean { background: var(--emerald-100); color: var(--emerald-700); }
    .risk-badge.green, .risk-badge--green { background: var(--green-100); color: var(--green-700); }
    .risk-badge.amber, .risk-badge--amber { background: var(--amber-100); color: var(--amber-600); }
    .risk-badge.orange, .risk-badge--orange { background: var(--orange-100); color: var(--orange-600); }
    .risk-badge.red, .risk-badge--red { background: var(--red-100); color: var(--red-700); }
    .risk-badge.expired, .risk-badge--expired { background: var(--gray-100); color: var(--gray-500); }
    
    /* ==================== VERDICT BOX ==================== */
    .verdict-box {
        background: var(--slate-50);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
        position: relative;
    }

    .verdict-box::before {
        content: '';
        position: absolute;
        left: 0;
        top: 20px;
        bottom: 20px;
        width: 4px;
        background: var(--navy-700);
        border-radius: 0 4px 4px 0;
    }
    
    .verdict-box.red::before { background: var(--red-600); }
    .verdict-box.orange::before { background: var(--orange-600); }
    .verdict-box.amber::before { background: var(--amber-600); }
    .verdict-box.green::before { background: var(--green-600); }
    .verdict-box.clean::before { background: var(--emerald-600); }
    
    .verdict-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--navy-900);
        margin-bottom: var(--space-sm);
    }
    
    .verdict-text {
        font-size: 0.95rem;
        color: var(--slate-600);
        margin: 0;
        line-height: 1.6;
    }
    
    .verdict-highlight {
        font-weight: 600;
        color: var(--navy-800);
    }
    
    /* ==================== TOOLTIPS ==================== */
    .tooltip-trigger {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: var(--slate-200);
        color: var(--slate-500);
        border-radius: 50%;
        font-size: 10px;
        font-weight: 600;
        cursor: help;
        position: relative;
        border: none;
        padding: 0;
        vertical-align: middle;
        margin-left: 4px;
    }
    
    .tooltip-content {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--navy-900);
        color: white;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 400;
        line-height: 1.4;
        white-space: normal;
        width: 220px;
        text-align: left;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s, visibility 0.15s;
        z-index: 100;
        pointer-events: none;
    }
    
    .tooltip-content::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: var(--navy-900);
    }
    
    .tooltip-trigger:hover .tooltip-content,
    .tooltip-trigger:focus .tooltip-content {
        opacity: 1;
        visibility: visible;
    }
    
    /* ==================== AT A GLANCE ==================== */
    .at-a-glance {
        background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
    }
    
    .at-a-glance-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-md);
    }
    
    .at-a-glance-title {
        font-family: var(--font-display);
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--navy-900);
    }
    
    .at-a-glance-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: var(--text-xs);
        color: var(--slate-500);
        background: var(--white);
        padding: 2px 8px;
        border-radius: 100px;
        border: 1px solid var(--slate-200);
    }
    
    .at-a-glance-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .at-a-glance-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-sm) 0;
        font-size: var(--text-sm);
        color: var(--slate-700);
        border-bottom: 1px solid var(--slate-200);
    }
    
    .at-a-glance-item:last-child {
        border-bottom: none;
    }
    
    .at-a-glance-icon {
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .at-a-glance-icon.positive { color: var(--green-600); }
    .at-a-glance-icon.neutral { color: var(--slate-400); }
    .at-a-glance-icon.negative { color: var(--red-600); }
    
    /* ==================== CARDS ==================== */
    .card {
        background: var(--white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--slate-200);
        margin-bottom: var(--space-lg);
        overflow: hidden;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--slate-100);
        background: var(--slate-50);
    }
    
    .card-header-links {
        display: flex;
        gap: var(--space-md);
        align-items: center;
    }
    
    .card-title {
        font-family: var(--font-display);
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--navy-900);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    
    .card-link {
        font-size: var(--text-sm);
        color: var(--blue-600);
    }
    
    .card-body {
        padding: var(--space-lg);
    }
    
    .card-footer {
        padding: var(--space-md) var(--space-lg);
        background: var(--slate-50);
        border-top: 1px solid var(--slate-100);
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    /* ==================== DATA GRID ==================== */
    .data-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
    }
    
    @media (max-width: 640px) {
        .data-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .data-item {
        text-align: center;
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
    }
    
    .data-value {
        font-family: var(--font-display);
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--navy-900);
    }
    
    .data-value.green { color: var(--green-600); }
    .data-value.amber { color: var(--amber-600); }
    .data-value.red { color: var(--red-600); }
    
    .data-label {
        font-size: var(--text-xs);
        color: var(--slate-500);
        margin-top: var(--space-xs);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    
    /* ==================== CASE LIST ==================== */
    .case-card {
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-bottom: var(--space-sm);
        background: var(--white);
    }
    
    .case-card.hidden {
        display: none;
    }
    
    .case-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-sm);
    }
    
    .case-ref {
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--navy-800);
    }
    
    .case-date {
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    .case-outcome {
        display: inline-block;
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
    }
    
    .case-outcome.upheld { background: var(--red-100); color: var(--red-700); }
    .case-outcome.dismissed { background: var(--green-100); color: var(--green-700); }
    .case-outcome.partial { background: var(--amber-100); color: var(--amber-600); }
    .case-outcome.withdrawn { background: var(--slate-100); color: var(--slate-600); }
    .case-outcome.settled { background: var(--blue-100); color: var(--blue-700); }
    .case-outcome.neutral { background: var(--slate-100); color: var(--slate-600); }
    
    .case-summary {
        font-size: var(--text-sm);
        color: var(--slate-600);
        line-height: 1.5;
    }
    
    .case-meta {
        display: flex;
        gap: var(--space-md);
        margin-top: var(--space-sm);
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    .case-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        padding: var(--space-sm);
        margin-top: var(--space-sm);
        background: var(--slate-50);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-sm);
        color: var(--slate-600);
        transition: background 0.15s;
    }
    
    .case-toggle:hover {
        background: var(--slate-100);
    }
    
    .case-toggle svg {
        transition: transform 0.2s;
    }
    
    .case-toggle.expanded svg {
        transform: rotate(180deg);
    }
    
    /* ==================== FEES ==================== */
    .fee-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-xs);
        font-size: var(--text-sm);
    }
    
    .fee-label { color: var(--slate-700); }
    .fee-value { font-weight: 600; color: var(--navy-800); }
    .fee-frequency {
        font-size: var(--text-xs);
        color: var(--slate-500);
        margin-left: var(--space-sm);
    }
    
    .fee-note {
        font-size: var(--text-sm);
        color: var(--slate-500);
        margin-top: 4px;
        line-height: 1.3;
        font-style: italic;
    }
    
    /* Fees Caveat Banner */
    .fees-caveat {
        display: flex;
        gap: var(--space-sm);
        padding: var(--space-md);
        background: var(--amber-50);
        border: 1px solid var(--amber-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        color: var(--amber-800);
        font-size: var(--text-sm);
    }
    
    .fees-caveat svg {
        flex-shrink: 0;
        color: var(--amber-500);
    }
    
    .fees-caveat p {
        margin: 0;
    }
    
    /* Fees Source Sections */
    .fees-source-section {
        margin-bottom: var(--space-lg);
    }
    
    .fees-source-section--separated {
        padding-top: var(--space-lg);
        border-top: 1px solid var(--slate-200);
    }
    
    .fees-source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
    }
    
    .fees-source-header h4 {
        margin: 0;
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--navy-800);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .fees-source-link {
        font-size: var(--text-sm);
        color: var(--blue-600);
        text-decoration: none;
    }
    
    .fees-source-link:hover {
        text-decoration: underline;
    }
    
    .fees-context {
        font-size: var(--text-sm);
        color: var(--slate-500);
        margin-bottom: var(--space-md);
        font-style: italic;
    }
    
    .tribunal-fees-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }
    
    .tribunal-fee-group {
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }
    
    .tribunal-fee-group.expandable .tribunal-fee-header {
        cursor: pointer;
    }
    
    .tribunal-fee-group.expandable .tribunal-fee-header:hover {
        background: var(--slate-100);
    }
    
    .tribunal-fee-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
        gap: var(--space-md);
    }
    
    .tribunal-fee-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
    }
    
    .tribunal-fee-type {
        color: var(--slate-700);
        font-weight: 500;
    }
    
    .tribunal-fee-count {
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    .tribunal-fee-details {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        flex-shrink: 0;
    }
    
    .tribunal-fee-amount {
        font-weight: 600;
        color: var(--navy-800);
    }
    
    .tribunal-fee-frequency {
        font-size: var(--text-xs);
        color: var(--slate-500);
        background: var(--slate-200);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
    }
    
    .tribunal-fee-chevron {
        color: var(--slate-400);
        transition: transform 0.2s;
        flex-shrink: 0;
    }
    
    .tribunal-fee-group.expanded .tribunal-fee-chevron {
        transform: rotate(180deg);
    }
    
    .tribunal-fee-details-list {
        display: none;
        border-top: 1px solid var(--slate-200);
        background: var(--white);
    }
    
    .tribunal-fee-group.expanded .tribunal-fee-details-list {
        display: block;
    }
    
    .tribunal-fee-detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-xs) var(--space-md);
        font-size: var(--text-xs);
        border-bottom: 1px solid var(--slate-100);
    }
    
    .tribunal-fee-detail-row:last-child {
        border-bottom: none;
    }
    
    .tribunal-fee-case-link {
        color: var(--blue-600);
    }
    
    .tribunal-fee-detail-amount {
        color: var(--slate-600);
    }
    
    /* ==================== REVIEWS ==================== */
    .review-snippet {
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-sm);
        border-left: 3px solid var(--slate-300);
    }
    
    .review-snippet-text {
        font-size: var(--text-sm);
        color: var(--slate-700);
        line-height: 1.5;
        font-style: italic;
        margin-bottom: var(--space-sm);
    }
    
    .review-snippet-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    .review-rating {
        display: flex;
        align-items: center;
        gap: 2px;
        color: var(--amber-500);
    }
    
    /* Review Source Links */
    .review-sources {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    
    .review-source-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-sm) var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        text-decoration: none;
        transition: background 0.15s;
    }
    
    .review-source-row:hover {
        background: var(--slate-100);
        text-decoration: none;
    }
    
    .review-source-info {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    
    .platform-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
    }
    
    .platform-icon--google {
        background: #E8F0FE;
        color: #4285F4;
    }
    
    .review-locations-summary {
        font-weight: 600;
        color: var(--navy-800);
        font-size: var(--text-sm);
    }
    
    .review-locations-list {
        display: flex;
        flex-direction: column;
    }
    
    .review-location-row {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        text-decoration: none;
        border-bottom: 1px solid var(--slate-100);
        transition: background 0.15s;
    }
    
    .review-location-row:last-child {
        border-bottom: none;
    }
    
    .review-location-row:hover {
        background: var(--white);
    }
    
    .review-location-name {
        flex: 1;
        font-size: var(--text-sm);
        color: var(--navy-800);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .review-location-stats {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--text-sm);
    }
    
    .review-location-rating {
        font-weight: 600;
        color: var(--amber-600);
    }
    
    .review-location-count {
        color: var(--slate-500);
    }
    
    .review-location-arrow {
        color: var(--slate-400);
        flex-shrink: 0;
    }
    
    .review-location-row:hover .review-location-arrow {
        color: var(--blue-600);
    }
    
    /* ==================== INFO GRID ==================== */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-md) var(--space-xl);
    }
    
    @media (max-width: 480px) {
        .info-grid { grid-template-columns: 1fr; }
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--slate-100);
        font-size: var(--text-sm);
    }
    
    .info-label {
        color: var(--slate-500);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }
    
    .info-value {
        font-weight: 500;
        text-align: right;
    }
    
    .info-value.green { color: var(--green-600); }
    .info-value.red { color: var(--red-600); }
    .info-value.amber { color: var(--amber-600); }
    
    /* ==================== COVERAGE ==================== */
    .coverage-areas-grid {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
    }
    
    .area-tag {
        display: inline-flex;
        align-items: center;
        padding: var(--space-xs) var(--space-sm);
        background: var(--slate-100);
        color: var(--slate-700);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        font-weight: 500;
    }
    
    .coverage-stats {
        display: flex;
        gap: var(--space-xl);
        margin-top: var(--space-lg);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--slate-200);
    }
    
    .coverage-stat {
        text-align: center;
    }
    
    .coverage-stat-value {
        font-family: var(--font-display);
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--navy-800);
    }
    
    .coverage-stat-label {
        font-size: var(--text-sm);
        color: var(--slate-500);
        margin-top: var(--space-xs);
    }
    
    /* ==================== SIMILAR FACTORS ==================== */
    .similar-factors-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-md);
    }
    
    @media (max-width: 768px) {
        .similar-factors-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 480px) {
        .similar-factors-grid { grid-template-columns: 1fr; }
    }
    
    .similar-factor-card {
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--slate-100);
        transition: border-color 0.15s, box-shadow 0.15s;
    }
    
    .similar-factor-card:hover {
        border-color: var(--blue-600);
        box-shadow: var(--shadow-sm);
    }
    
    .similar-factor-name {
        font-weight: 600;
        font-size: var(--text-sm);
        margin-bottom: var(--space-xs);
        color: var(--navy-800);
    }
    
    .similar-factor-name a { color: inherit; }
    
    .similar-factor-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .similar-factor-meta {
        font-size: var(--text-xs);
        color: var(--slate-500);
        margin-top: var(--space-xs);
    }
    
    /* ==================== SIDEBAR ==================== */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    
    .sidebar-card {
        background: var(--white);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .sidebar-section {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--slate-100);
    }
    
    .sidebar-section:last-child {
        border-bottom: none;
    }
    
    .sidebar-title {
        font-family: var(--font-display);
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--navy-900);
        margin-bottom: var(--space-md);
    }
    
    .contact-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-xs) 0;
        font-size: var(--text-sm);
    }
    
    .contact-icon {
        color: var(--slate-400);
        margin-top: 2px;
        flex-shrink: 0;
    }
    
    .contact-value {
        color: var(--slate-700);
        word-break: break-word;
    }
    
    .contact-value a {
        color: var(--blue-600);
    }
    
    /* Source List */
    .source-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .source-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) 0;
        font-size: var(--text-sm);
    }
    
    .source-check {
        width: 16px;
        height: 16px;
    }
    .source-check.available { color: var(--green-600); }
    .source-check.unavailable { color: var(--slate-400); }
    
    /* CTA Box */
    .cta-box {
        background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-950) 100%);
        color: white;
        padding: var(--space-lg);
        text-align: center;
    }
    
    .cta-title {
        font-family: var(--font-display);
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--space-sm);
    }
    
    .cta-text {
        font-size: var(--text-sm);
        opacity: 0.9;
        margin-bottom: var(--space-md);
    }
    
    .cta-highlight {
        font-size: var(--text-xs);
        background: rgba(255,255,255,0.2);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-md);
        display: inline-block;
    }
    
    .cta-button {
        display: inline-block;
        background: white;
        color: var(--navy-900);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .cta-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        text-decoration: none;
    }
    
    .correction-link {
        display: block;
        padding: var(--space-md) var(--space-lg);
        text-align: center;
        font-size: var(--text-sm);
        color: var(--slate-500);
        background: var(--slate-50);
    }
    
    /* Mobile sticky CTA */
    .mobile-cta {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--navy-900);
        color: white;
        padding: var(--space-md);
        text-align: center;
        z-index: 100;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
    }
    
    @media (max-width: 968px) {
        .mobile-cta { display: block; }
        body.has-mobile-cta { padding-bottom: 70px; }
    }
    
    /* ==================== FOOTER ADDITIONS ==================== */
    .footer-disclaimer {
        max-width: 1200px;
        margin: 32px auto 0;
        padding: 16px 24px;
        background: rgba(255,255,255,0.05);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        color: rgba(255,255,255,0.7);
        text-align: center;
    }
    
    .footer-disclaimer a {
        color: rgba(255,255,255,0.9);
        text-decoration: underline;
    }
    
    /* ==================== REVIEW SNIPPETS (Enhanced) ==================== */
    .review-snippets {
        margin-bottom: var(--space-lg);
    }
    
    .review-snippets-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--navy-800);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0 0 var(--space-md) 0;
    }
    
    .review-snippet {
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-sm);
        border-left: 3px solid var(--slate-300);
    }
    
    .review-snippet-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
    }
    
    .platform-badge {
        font-size: var(--text-xs);
        font-weight: 600;
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        text-transform: uppercase;
    }
    
    .platform-badge--google {
        background: #E8F0FE;
        color: #4285F4;
    }
    
    .platform-badge--trustpilot {
        background: #E6F4E6;
        color: #00B67A;
    }
    
    .review-snippet-text {
        font-size: var(--text-sm);
        color: var(--slate-700);
        line-height: 1.5;
        font-style: italic;
        margin-bottom: var(--space-sm);
    }
    
    .review-snippet-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: var(--text-xs);
        color: var(--slate-500);
    }
    
    .review-author {
        font-weight: 500;
    }
    
    .rating-explanation {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-md);
        background: var(--blue-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        font-size: var(--text-sm);
        color: var(--blue-800);
    }
    
    .rating-explanation svg {
        flex-shrink: 0;
        color: var(--blue-500);
        margin-top: 2px;
    }
    
    /* ==================== SEVERITY BADGES ==================== */
    .severity-badge {
        font-size: var(--text-xs);
        font-weight: 600;
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }
    
    .severity-badge--low {
        background: var(--green-100);
        color: var(--green-700);
    }
    
    .severity-badge--medium {
        background: var(--amber-100);
        color: var(--amber-700);
    }
    
    .severity-badge--high {
        background: var(--orange-100);
        color: var(--orange-700);
    }
    
    .severity-badge--critical {
        background: var(--red-100);
        color: var(--red-700);
    }
    
    /* ==================== BENCHMARK INDICATOR ==================== */
    .benchmark-indicator {
        font-size: var(--text-xs);
        font-weight: 400;
        color: var(--slate-500);
        margin-left: var(--space-xs);
    }
    
    /* ==================== TRIBUNAL TREND CHART ==================== */
    .tribunal-trend {
        margin-top: var(--space-lg);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--slate-200);
    }
    
    .trend-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--navy-800);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }
    
    .trend-context {
        font-size: var(--text-xs);
        color: var(--slate-500);
        margin-bottom: var(--space-md);
    }
    
    .trend-chart-wrapper {
        display: flex;
        gap: var(--space-sm);
    }
    
    .trend-y-axis {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        font-size: var(--text-xs);
        color: var(--slate-400);
        text-align: right;
        min-width: 24px;
        padding-bottom: 20px;
    }
    
    .trend-chart {
        flex: 1;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 100px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--slate-200);
    }
    
    .trend-bar-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-width: 0;
    }
    
    .trend-bar-wrapper.highlight .trend-bar {
        background: var(--red-500);
    }
    
    .trend-bar-value {
        font-size: var(--text-xs);
        color: var(--slate-500);
        font-weight: 500;
    }
    
    .trend-bar {
        width: 100%;
        max-width: 32px;
        background: var(--teal-500);
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        min-height: 4px;
        transition: height 0.3s ease;
    }
    
    .trend-bar.pfeo {
        background: var(--red-400);
        margin-top: 2px;
    }
    
    .trend-label {
        font-size: var(--text-xs);
        color: var(--slate-500);
        position: absolute;
        bottom: 0;
        transform: translateY(100%);
        padding-top: 4px;
    }
    
    .trend-bar-wrapper {
        position: relative;
    }
    
    /* ==================== CASE SUMMARY ==================== */
    .case-summary {
        font-size: var(--text-sm);
        color: var(--slate-600);
        line-height: 1.5;
        margin-bottom: var(--space-sm);
    }
    
    .case-badges {
        display: flex;
        gap: var(--space-xs);
        flex-wrap: wrap;
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
        .profile-header-top {
            flex-direction: column;
        }
        .profile-identity h1 {
            font-size: var(--text-xl);
        }
        .risk-badge {
            align-self: flex-start;
        }
        .trend-chart {
            height: 80px;
        }
        .trend-bar-value {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- ==================== BREADCRUMB ==================== -->
<div class="container">
    <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span>›</span>
        <a href="/factors/">Factors</a>
        <span>›</span>
        <span>{{ profile.name }}</span>
    </nav>
</div>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="container">
    <div class="profile-layout">

    <main class="main-content">
        
        <!-- ==================== ALERT BANNERS ==================== -->
        {% if profile.status != 'registered' %}
        <div class="alert-banner alert-banner--expired" role="alert">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <div class="alert-banner-content">
                <div class="alert-banner-title">Registration Expired</div>
                This profile is included for historical completeness. {{ profile.name }} is no longer registered with the Scottish Property Factor Register and cannot legally provide factoring services.
            </div>
        </div>
        {% endif %}
        
        {% if profile.status == 'registered' and profile.factor_type in ['RSL', 'Housing Association', 'Local Authority'] %}
        <div class="alert-banner alert-banner--info" role="alert">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <div class="alert-banner-content">
                <div class="alert-banner-title">Switching Not Available</div>
                This factor is a {{ profile.factor_type }}. Homeowners in properties managed by this organisation typically cannot choose an alternative factor—the factoring arrangement is tied to the property ownership or tenancy structure.
            </div>
        </div>
        {% endif %}
        
        <!-- ==================== PROFILE HEADER ==================== -->
        {% set band = profile.risk_band|default('CLEAN') %}
        {% set band_lower = band|lower %}
        {% set band_class = 'expired' if profile.status != 'registered' else {'CLEAN': 'clean', 'GREEN': 'green', 'AMBER': 'amber', 'ORANGE': 'orange', 'RED': 'red'}.get(band, 'clean') %}
        
        <div class="profile-header">
            <div class="profile-header-top">
                <div class="profile-identity">
                    <h1>{{ profile.name }}</h1>
                    <div class="profile-meta">
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            {{ profile.registration_number }}
                        </span>
                        {% if profile.factor_type %}
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            {{ profile.factor_type }}
                            <span class="tooltip-trigger" tabindex="0" role="button" aria-describedby="factor-type-tooltip">i<span class="tooltip-content" id="factor-type-tooltip">{% if profile.factor_type == 'Commercial' %}A private company providing factoring services for profit.{% elif profile.factor_type == 'RSL' or profile.factor_type == 'Housing Association' %}A Registered Social Landlord or housing association, typically non-profit.{% elif profile.factor_type == 'Sole Proprietor' %}An individual operating as a property factor.{% elif profile.factor_type == 'Local Authority' %}A council or local government body.{% else %}{{ profile.factor_type }}{% endif %}</span></span>
                        </span>
                        {% endif %}
                        <span class="profile-meta-item">
                            {% if profile.status == 'registered' %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--green-600)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span style="color: var(--green-600); font-weight: 500;">Active</span>
                            {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gray-500)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span style="color: var(--gray-500); font-weight: 500;">Expired</span>
                            {% endif %}
                        </span>
                        {% if profile.property_count %}
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                            {{ "{:,}".format(profile.property_count) }} properties
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Risk Badge with Composite Score -->
                {% set score = profile.tribunal_composite_score|default(100) %}
                <div class="risk-badge {{ band_class }}" role="status" aria-label="{% if profile.status != 'registered' %}Historical tribunal rating{% else %}Tribunal risk rating: {{ band }}{% endif %}">
                    <div class="risk-badge-main">
                        {% if profile.status != 'registered' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        {{ band }}
                        {% elif band == 'CLEAN' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        {{ band }}
                        {% elif band == 'RED' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        {{ band }}
                        {% else %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        {{ band }}
                        {% endif %}
                    </div>
                    <div class="risk-badge-reason">
                        {% if profile.status != 'registered' %}Historical record{% elif band == 'CLEAN' %}No upheld cases{% elif profile.tribunal_pfeo_penalty and profile.tribunal_pfeo_penalty > 0 %}Includes PFEO penalty{% else %}Tribunal record{% endif %}
                    </div>
                </div>
            </div>
            
            <!-- ==================== VERDICT BOX ==================== -->
            <div class="verdict-box {{ band_lower }}">
                <div class="verdict-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    Our Verdict
                </div>
                <p class="verdict-text">
                    {% if at_a_glance and at_a_glance.summary %}
                        {{ at_a_glance.summary }}
                    {% else %}
                        {{ profile.name }} is a <strong>
                        {% if profile.property_count and profile.property_count > 5000 %}large{% elif profile.property_count and profile.property_count > 1000 %}mid-sized{% else %}small{% endif %}
                        </strong> Scottish property factor.
                        
                        Based on our data, they hold a <strong>{{ band }}</strong> risk rating.
                        {% if band == 'CLEAN' %}
                        They have no significant tribunal history, suggesting a reliable service record.
                        {% elif band == 'AMBER' %}
                        Potential clients should be aware of a moderate frequency of tribunal disputes relative to their size.
                        {% elif band == 'RED' %}
                        They have a higher-than-average volume of tribunal cases or enforcement orders, which is a significant concern.
                        {% endif %}
                    {% endif %}
                </p>
            </div>
            
            <!-- ==================== AT A GLANCE ==================== -->
            {% if at_a_glance and at_a_glance.bullets %}
            <div class="at-a-glance">
                <div class="at-a-glance-header">
                    <span class="at-a-glance-title">At a Glance</span>
                    <span class="at-a-glance-badge">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        AI Summary
                    </span>
                </div>
                <ul class="at-a-glance-list">
                    {% for bullet in at_a_glance.bullets %}
                    <li class="at-a-glance-item">
                        {% if bullet.sentiment == 'positive' %}
                        <svg class="at-a-glance-icon positive" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        {% elif bullet.sentiment == 'negative' %}
                        <svg class="at-a-glance-icon negative" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        {% else %}
                        <svg class="at-a-glance-icon neutral" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        {% endif %}
                        <span>{{ bullet.text }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        
        <!-- ==================== REST OF CONTENT ==================== -->
        <!-- TRIBUNAL RECORD CARD -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Tribunal Record
                    <span class="tooltip-trigger" tabindex="0" role="button" aria-describedby="tribunal-tooltip">i<span class="tooltip-content" id="tribunal-tooltip">Cases heard by the Housing & Property Chamber. Homeowners can raise complaints about code breaches, fees, or service failures.</span></span>
                </h2>
                <div class="card-header-links">
                    {% if tribunal_last_5_years.case_count > 0 %}
                    <a href="/factors/{{ profile.registration_number|lower }}/tribunal/" class="card-link">View cases →</a>
                    {% endif %}
                    <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" class="card-link" target="_blank" rel="noopener">HPC decisions ↗</a>
                </div>
            </div>
            <div class="card-body">
                {% if tribunal_last_5_years.case_count == 0 %}
                <div class="empty-state" style="text-align: center; padding: var(--space-xl); color: var(--slate-500);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: var(--space-md); color: var(--green-500);"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <p>No tribunal cases in the last 5 years.</p>
                </div>
                {% else %}
                <div style="margin-bottom: var(--space-lg);">
                    <div style="font-size: var(--text-sm); font-weight: 600; color: var(--navy-800); margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 0.05em;">Last 5 Years</div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-md);">
                        <div style="text-align: center; padding: var(--space-sm); background: var(--slate-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--navy-800);">{{ tribunal_last_5_years.case_count|default(0) }}</div>
                            <div style="font-size: var(--text-xs); color: var(--slate-500); margin-top: var(--space-xs);">Cases</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-sm); background: var(--slate-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--text-2xl); font-weight: 700; {% if tribunal_last_5_years.complaints_upheld_pct and tribunal_last_5_years.complaints_upheld_pct > 50 %}color: var(--red-600);{% else %}color: var(--navy-800);{% endif %}">
                                {% if tribunal_last_5_years.complaints_upheld_pct %}{{ tribunal_last_5_years.complaints_upheld_pct|int }}%{% else %}—{% endif %}
                            </div>
                            <div style="font-size: var(--text-xs); color: var(--slate-500); margin-top: var(--space-xs);">Upheld</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-sm); background: var(--slate-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--text-2xl); font-weight: 700; color: var(--navy-800);">{{ "%.1f"|format(tribunal_last_5_years.rate_per_10k) if tribunal_last_5_years.rate_per_10k else '—' }}</div>
                            <div style="font-size: var(--text-xs); color: var(--slate-500); margin-top: var(--space-xs);">Rate/10k</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-sm); background: var(--slate-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--text-2xl); font-weight: 700; {% if tribunal_last_5_years.pfeo_count and tribunal_last_5_years.pfeo_count > 0 %}color: var(--red-600);{% else %}color: var(--navy-800);{% endif %}">{{ tribunal_last_5_years.pfeo_count|default(0) }}</div>
                            <div style="font-size: var(--text-xs); color: var(--slate-500); margin-top: var(--space-xs);">PFEOs</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-sm); background: var(--slate-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--text-2xl); font-weight: 700; {% if tribunal_last_5_years.compensation and tribunal_last_5_years.compensation > 1000 %}color: var(--red-600);{% else %}color: var(--navy-800);{% endif %}">£{{ "{:,.0f}".format(tribunal_last_5_years.compensation|default(0)) }}</div>
                            <div style="font-size: var(--text-xs); color: var(--slate-500); margin-top: var(--space-xs);">Compensation</div>
                        </div>
                    </div>
                </div>


                
                <!-- Cases by Year Trend Chart -->
                {% if cases_by_year and cases_by_year|length > 1 %}
                {% set recent_years = cases_by_year[-5:] %}
                <div class="tribunal-trend">
                    <div class="trend-title">
                        Cases by Year (Last 5 Years)
                        <span class="tooltip-trigger" tabindex="0">i<span class="tooltip-content">Annual tribunal case volume over the last 5 years.</span></span>
                    </div>
                    {% set max_cases = recent_years|map(attribute='cases')|max %}
                    {% set max_year = recent_years|selectattr('cases', 'equalto', max_cases)|first %}
                    {% if max_cases > 5 %}
                    <div class="trend-context">{{ max_cases }} cases in {{ max_year.year }} (highest in period)</div>
                    {% endif %}
                    <div class="trend-chart-wrapper">
                        <div class="trend-y-axis">
                            <span>{{ max_cases }}</span>
                            <span>{{ (max_cases / 2)|int }}</span>
                            <span>0</span>
                        </div>
                        <div class="trend-chart" role="img" aria-label="Bar chart showing tribunal cases by year">
                            {% for year_data in recent_years %}
                            <div class="trend-bar-wrapper {% if year_data.cases == max_cases %}highlight{% endif %}">
                                <div class="trend-bar-value">{{ year_data.cases }}</div>
                                <div class="trend-bar" style="height: {{ (year_data.cases / max_cases * 70)|int if max_cases else 4 }}px;" title="{{ year_data.cases }} cases in {{ year_data.year }}"></div>
                                {% if year_data.pfeos and year_data.pfeos > 0 %}
                                <div class="trend-bar pfeo" style="height: {{ (year_data.pfeos / max_cases * 70)|int }}px;" title="{{ year_data.pfeos }} PFEOs"></div>
                                {% endif %}
                                <div class="trend-label">'{{ (year_data.year|string)[-2:] }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            <div class="card-footer">
                Case summaries and statistics are AI-generated from official HPC decisions. <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener">Verify with official records ↗</a>
            </div>
        </div>
        
        <!-- RECENT DECISIONS -->
        {% if recent_cases %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Recent Decisions
                </h2>
                <div class="card-header-links">
                    <a href="/factors/{{ profile.registration_number|lower }}/tribunal/" class="card-link">Full history →</a>
                    <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" class="card-link" target="_blank" rel="noopener">HPC decisions ↗</a>
                </div>
            </div>
            <div class="card-body">
                <div id="cases-list">
                    {% for case in recent_cases %}
                    <div class="case-card {% if loop.index > 3 %}hidden{% endif %}">
                        <div class="case-header">
                            <div>
                                <a href="{{ case.pdf_url or 'https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions' }}" class="case-ref" target="_blank" rel="noopener">{{ case.case_reference }}</a>
                                <span class="case-date">{{ case.decision_date }}</span>
                            </div>
                            <div class="case-badges">
                                {% set outcome = case.outcome|default('Unknown') %}
                                {% set outcome_lower = outcome|lower %}
                                {% set outcome_class = 'upheld' if 'upheld' in outcome_lower and 'not' not in outcome_lower and 'partial' not in outcome_lower else 'partial' if 'partial' in outcome_lower else 'dismissed' if 'dismiss' in outcome_lower or 'not upheld' in outcome_lower else 'withdrawn' if 'withdrawn' in outcome_lower else 'other' %}
                                <span class="case-outcome {{ outcome_class }}">{{ outcome }}</span>
                                {% if case.severity_score %}
                                {% set sev = case.severity_score|float %}
                                {% set sev_class = 'critical' if sev >= 8 else 'high' if sev >= 6 else 'medium' if sev >= 4 else 'low' %}
                                <span class="severity-badge severity-badge--{{ sev_class }}" title="Case severity: {{ case.severity_score }}/10">{{ case.severity_score }}/10</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if case.summary %}
                        <div class="case-summary">{{ case.summary|truncate(200) }}</div>
                        {% endif %}
                        {% set quote_text = case.key_quote or case.quote %}
                        {% if quote_text %}
                        <div class="case-quote" style="font-style: italic; color: var(--slate-600); font-size: var(--text-sm); margin-bottom: var(--space-sm); padding-left: var(--space-md); border-left: 2px solid var(--slate-300);">"{{ quote_text|truncate(150) }}"</div>
                        {% endif %}
                        <div class="case-meta">
                            {% set comp = case.compensation_awarded or case.compensation or 0 %}
                            {% if comp and comp > 0 %}
                            <span>£{{ "{:,.0f}".format(comp) }} compensation</span>
                            {% endif %}
                            {% if case.pfeo_issued %}
                            <span style="color: var(--red-600); font-weight: 600;">⚠ PFEO issued</span>
                            {% endif %}
                        </div>
                        <div class="case-links" style="margin-top: var(--space-sm);">
                            {% if case.pdf_url %}
                            <a href="{{ case.pdf_url }}" target="_blank" rel="noopener" style="font-size: var(--text-sm); color: var(--blue-600);">View decision (PDF) →</a>
                            {% else %}
                            <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener" style="font-size: var(--text-sm); color: var(--blue-600);">View on HPC →</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if recent_cases|length > 3 %}
                <div class="case-toggle" id="cases-toggle" onclick="toggleCases()">
                    <span id="toggle-text">Show {{ recent_cases|length - 3 }} more recent cases</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                Case data extracted by AI from official Housing & Property Chamber decision PDFs. Verify important details with <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener">official records</a>.
            </div>
        </div>
        {% endif %}
        
        <!-- REVIEWS CARD -->
        {% if profile.google_rating or profile.trustpilot_rating %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    Ratings & Reviews
                    <span class="tooltip-trigger" tabindex="0" role="button" aria-describedby="reviews-tooltip">i<span class="tooltip-content" id="reviews-tooltip">Public reviews collected from Google Maps and Trustpilot. We weight the average by review count.</span></span>
                </h2>
            </div>
            <div class="card-body">
                {% set total_reviews = (profile.google_review_count|default(0)) + (profile.trustpilot_review_count|default(0)) %}
                
                <!-- Combined Rating Explanation -->
                {% if profile.combined_rating and total_reviews > 0 %}
                <div class="rating-explanation">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span><strong>{{ "%.1f"|format(profile.combined_rating) }}★ weighted average</strong> calculated from {{ profile.google_review_count|default(0) }} Google + {{ profile.trustpilot_review_count|default(0) }} Trustpilot reviews</span>
                </div>
                {% endif %}
                
                <!-- Review Snippets (when we have actual review text) -->
                {% if recent_reviews and recent_reviews|length > 0 %}
                {% set reviews_with_text = recent_reviews|selectattr('review_text')|list %}
                {% if reviews_with_text|length > 0 %}
                <div class="review-snippets">
                    <h4 class="review-snippets-title">Recent Reviews</h4>
                    {% for review in reviews_with_text[:5] %}
                    <div class="review-snippet">
                        <div class="review-snippet-header">
                            <span class="platform-badge platform-badge--{{ review.platform|default('google') }}">{{ review.platform|default('Google')|title }}</span>
                            {% if review.rating %}<span class="review-rating">{{ "%.1f"|format(review.rating) }}★</span>{% endif %}
                        </div>
                        <div class="review-snippet-text">"{{ review.review_text|truncate(300) }}"</div>
                        <div class="review-snippet-meta">
                            <span class="review-author">— {{ review.author_name or 'Anonymous' }}</span>
                            {% if review.review_date %}<span class="review-date">{{ review.review_date }}</span>{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
                
                <!-- Review Source Links -->
                <div class="review-sources" {% if recent_reviews and recent_reviews|selectattr('review_text')|list|length > 0 %}style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--slate-200);"{% endif %}>
                    <h4 class="review-snippets-title">Read Reviews</h4>
                    
                    {% if google_locations and google_locations|length > 1 %}
                    <!-- Multiple Google locations -->
                    <div class="review-locations-breakdown" style="background: var(--slate-50); border: 1px solid var(--slate-200); border-radius: var(--radius-md); overflow: hidden; margin-bottom: var(--space-sm);">
                        <div class="review-locations-header" style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-md); background: var(--white); border-bottom: 1px solid var(--slate-200);">
                            <span class="platform-icon platform-icon--google">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            </span>
                            <span class="review-locations-summary">Google Reviews · {{ profile.google_review_count }} total across {{ google_locations|length }} locations</span>
                        </div>
                        <div class="review-locations-list">
                            {% for loc in google_locations %}
                            <a href="{% if loc.place_id %}https://search.google.com/local/reviews?placeid={{ loc.place_id }}{% else %}https://www.google.com/search?q={{ loc.name|urlencode }}+{{ profile.name|urlencode }}+reviews{% endif %}" class="review-location-row" target="_blank" rel="noopener">
                                <span class="review-location-name">{{ loc.name or loc.address or 'Office' }}</span>
                                <div class="review-location-stats">
                                    <span class="review-location-rating">{{ "%.1f"|format(loc.rating) if loc.rating else '—' }}★</span>
                                    <span class="review-location-count">({{ loc.review_count or 0 }})</span>
                                </div>
                                <svg class="review-location-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif profile.google_review_count and profile.google_review_count > 0 %}
                    <!-- Single Google location -->
                    <a href="{% if google_places and google_places.place_id %}https://search.google.com/local/reviews?placeid={{ google_places.place_id }}{% else %}https://www.google.com/search?q={{ profile.name|urlencode }}+property+factor+reviews{% endif %}" class="review-source-row" target="_blank" rel="noopener">
                        <div class="review-source-info">
                            <span class="platform-icon platform-icon--google">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            </span>
                            <span style="font-weight: 600; color: var(--navy-800);">Google Reviews</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <span style="font-weight: 600; color: var(--amber-600);">{{ "%.1f"|format(profile.google_rating) if profile.google_rating else '—' }}★</span>
                            <span style="color: var(--slate-500);">({{ profile.google_review_count|default(0) }})</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </a>
                    {% endif %}
                    
                    {% if profile.trustpilot_review_count and profile.trustpilot_review_count > 0 %}
                    <a href="{% if trustpilot and trustpilot.url %}{{ trustpilot.url }}{% else %}https://uk.trustpilot.com/search?query={{ profile.name|urlencode }}{% endif %}" class="review-source-row" target="_blank" rel="noopener">
                        <div class="review-source-info">
                            <span class="platform-icon" style="background: #E6F4E6; color: #00B67A;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </span>
                            <span style="font-weight: 600; color: var(--navy-800);">Trustpilot</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <span style="font-weight: 600; color: var(--amber-600);">{{ "%.1f"|format(profile.trustpilot_rating) if profile.trustpilot_rating else '—' }}★</span>
                            <span style="color: var(--slate-500);">({{ profile.trustpilot_review_count|default(0) }})</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer">
                Reviews are collected from public listings and may not represent all customer experiences.
            </div>
        </div>
        {% endif %}
        
        <!-- FEES CARD -->
        <!-- FEE INFORMATION REMOVED - See WSS document link in sidebar for details -->
        
        <!-- SERVICE COMMITMENTS REMOVED - See WSS document link in sidebar for details -->
        
        <!-- COMPANIES HOUSE CARD -->
        {% if profile.ch_number %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                    Company Information
                </h2>
                <a href="https://find-and-update.company-information.service.gov.uk/company/{{ profile.ch_number }}" class="card-link" target="_blank" rel="noopener">Companies House →</a>
            </div>
            <div class="card-body">
                <div class="company-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
                    <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0; border-bottom: 1px solid var(--slate-100);">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">
                                Status
                                <span class="tooltip-trigger" tabindex="0" role="button">i<span class="tooltip-content">"Active" means the company is operational and filing required documents.</span></span>
                            </span>
                            <span style="font-weight: 600; {% if profile.ch_status == 'active' %}color: var(--green-600);{% elif profile.ch_status %}color: var(--red-600);{% endif %}">
                                {{ profile.ch_status|capitalize if profile.ch_status else '—' }}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0; border-bottom: 1px solid var(--slate-100);">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">Incorporated</span>
                            <span style="font-weight: 600; color: var(--navy-800);">{{ profile.ch_incorporated or '—' }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0;">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">Company Number</span>
                            <span style="font-weight: 600; color: var(--navy-800);">{{ profile.ch_number }}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0; border-bottom: 1px solid var(--slate-100);">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">
                                Accounts
                                <span class="tooltip-trigger" tabindex="0" role="button">i<span class="tooltip-content">Whether the company is up to date with annual accounts filing.</span></span>
                            </span>
                            <span style="font-weight: 600; {% if profile.ch_accounts_overdue %}color: var(--red-600);{% else %}color: var(--green-600);{% endif %}">
                                {% if profile.ch_accounts_overdue %}Overdue{% else %}Up to date{% endif %}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0; border-bottom: 1px solid var(--slate-100);">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">Directors</span>
                            <span style="font-weight: 600; color: var(--navy-800);">{{ profile.ch_directors or '—' }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: var(--space-xs) 0;">
                            <span style="color: var(--slate-600); font-size: var(--text-sm);">
                                Avg. Tenure
                                <span class="tooltip-trigger" tabindex="0" role="button">i<span class="tooltip-content">Average years directors have served. Longer tenure often indicates stability.</span></span>
                            </span>
                            <span style="font-weight: 600; color: var(--navy-800);">{% if profile.ch_avg_tenure %}{{ "%.1f"|format(profile.ch_avg_tenure) }} yrs{% else %}—{% endif %}</span>
                        </div>
                    </div>
                </div>
                
                {% if profile.ch_insolvency or profile.ch_charges %}
                <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--slate-200); display: flex; gap: var(--space-lg);">
                    {% if profile.ch_insolvency %}
                    <div style="display: flex; align-items: center; gap: var(--space-xs); color: var(--red-600); font-size: var(--text-sm);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        <span>Insolvency history</span>
                        <span class="tooltip-trigger" tabindex="0" role="button">i<span class="tooltip-content">This company has insolvency proceedings in its history. Check Companies House for details.</span></span>
                    </div>
                    {% endif %}
                    {% if profile.ch_charges %}
                    <div style="display: flex; align-items: center; gap: var(--space-xs); color: var(--amber-600); font-size: var(--text-sm);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <span>Outstanding charges</span>
                        <span class="tooltip-trigger" tabindex="0" role="button">i<span class="tooltip-content">The company has charges (e.g. mortgages or debentures) registered against it.</span></span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- COVERAGE CARD -->
        {% if coverage_areas_list or profile.property_count or profile.postcode_count %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    Coverage Area
                </h2>
            </div>
            <div class="card-body">
                {% if coverage_areas_list %}
                <div class="coverage-areas-grid">
                    {% for area in coverage_areas_list[:20] %}
                    {% set clean_area = area.strip().replace('"', '').replace('&#34;', '') %}
                    {% if clean_area %}
                    <span class="area-tag">{{ clean_area }}</span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if profile.property_count or profile.postcode_count %}
                <div class="coverage-stats">
                    {% if profile.property_count %}
                    <div class="coverage-stat">
                        <div class="coverage-stat-value">{{ "{:,}".format(profile.property_count) }}</div>
                        <div class="coverage-stat-label">Properties Managed</div>
                    </div>
                    {% endif %}
                    {% if profile.postcode_count %}
                    <div class="coverage-stat">
                        <div class="coverage-stat-value">{{ profile.postcode_count }}</div>
                        <div class="coverage-stat-label">Postcode Sectors</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- QUICK ACTIONS CTA -->
        {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
        <div class="card" style="background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-950) 100%); color: white; border: none;">
            <div class="card-body" style="text-align: center; padding: var(--space-xl);">
                <h3 style="font-family: var(--font-display); font-size: 1.25rem; margin-bottom: var(--space-sm); color: white;">Considering a switch?</h3>
                <p style="margin-bottom: var(--space-lg); opacity: 0.9;">Compare quotes from vetted factors serving your area. Free, no obligation.</p>
                <a href="/get-quotes/?from={{ profile.registration_number }}" class="cta-button">Get Free Quotes →</a>
            </div>
        </div>
        {% endif %}
        
    </main>
    
    <!-- ==================== SIDEBAR ==================== -->
    <aside class="sidebar">
        <div class="sidebar-card">
            <!-- CTA Box (if switchable) -->
            {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
            <div class="cta-box">
                <h3 class="cta-title">Unhappy with {{ profile.name.split()[0] }}?</h3>
                <p class="cta-text">Compare quotes from better-rated factors in your area</p>
                <a href="/get-quotes/?from={{ profile.registration_number }}" class="cta-button">Get Free Quotes</a>
            </div>
            {% endif %}
            
            <!-- Quick Links -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Quick Links</h3>
                <ul class="source-list">
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        <a href="https://www.gov.scot/publications/property-factor-register/" target="_blank" rel="noopener">View on Official Register</a>
                    </li>
                    {% if profile.website %}
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                        <a href="{{ profile.website }}" target="_blank" rel="noopener">Official Website</a>
                    </li>
                    {% endif %}
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        <a href="/guides/how-to-switch-factors-scotland/">How to Switch Factors</a>
                    </li>
                </ul>
            </div>
            
            <!-- Contact Info -->
            {% if google_places or profile.website %}
            <div class="sidebar-section">
                <h3 class="sidebar-title">Contact</h3>
                {% if profile.website %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span class="contact-value"><a href="{{ profile.website }}" target="_blank" rel="noopener">{{ profile.website|replace('https://', '')|replace('http://', '')|replace('www.', '')|truncate(30) }}</a></span>
                </div>
                {% endif %}
                {% if google_places and google_places.phone %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    <span class="contact-value">{{ google_places.phone }}</span>
                </div>
                {% endif %}
                {% if google_places and google_places.address %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <span class="contact-value">{{ google_places.address }}</span>
                </div>
                {% endif %}
                {% if not google_places and not profile.website %}
                <p style="color: var(--slate-500); font-size: var(--text-sm);">No contact information available.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Data Sources -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Data Sources</h3>
                <ul class="source-list">
                    <li class="source-item">
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <a href="{{ registry_url|default('https://www.gov.scot/publications/property-factor-register/') }}" target="_blank" rel="noopener">Property Factor Register</a>
                    </li>
                    <li class="source-item">
                        {% if tribunal_last_5_years.case_count > 0 %}
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        {% else %}
                        <svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        {% endif %}
                        <span>Tribunal ({{ tribunal_last_5_years.case_count|default(0) }} cases, 5yr)</span>
                    </li>
                    <li class="source-item">
                        {% if profile.ch_number %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Companies House</span>
                    </li>
                    <li class="source-item">
                        {% if profile.google_rating %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Google ({{ profile.google_review_count|default(0) }} reviews)</span>
                    </li>
                    <li class="source-item">
                        {% if profile.trustpilot_rating %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Trustpilot ({{ profile.trustpilot_review_count|default(0) }} reviews)</span>
                    </li>
                    <li class="source-item">
                        {% if wss_url %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>WSS on file</span>
                    </li>
                </ul>
                
                <!-- External Source Links -->
                <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--slate-200); display: flex; flex-direction: column; gap: var(--space-sm);">
                    {% if wss_url %}
                    <a href="{{ wss_url }}" class="btn-outline" style="width: 100%; justify-content: center; font-size: var(--text-sm);" target="_blank" rel="noopener">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        View WSS Document
                    </a>
                    {% endif %}
                    {% if profile.ch_number %}
                    <a href="https://find-and-update.company-information.service.gov.uk/company/{{ profile.ch_number }}" class="btn-outline" style="width: 100%; justify-content: center; font-size: var(--text-sm);" target="_blank" rel="noopener">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                        Companies House
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Accreditation -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Accreditation</h3>
                <ul class="source-list">
                    <li class="source-item">
                        {% if profile.status == 'registered' %}
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>Scottish PF Register</span>
                        {% else %}
                        <svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        <span>Previously registered</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
        
    </aside>
    
</div>

</div>

<!-- Mobile Sticky CTA (hidden for non-switchable factor types and expired registrations) -->
{% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
<div class="mobile-cta">
    <a href="/get-quotes/?from={{ profile.registration_number }}" style="color: white; font-weight: 600;">Get Free Quotes from Better-Rated Factors →</a>
</div>
{% endif %}

<!-- Page-specific footer disclaimer -->
<div class="footer-disclaimer" style="max-width: 1200px; margin: 0 auto var(--space-lg); padding: 16px 24px; background: var(--slate-100); border-radius: var(--radius-md); font-size: var(--text-sm); color: var(--slate-600); text-align: center;">
    Some summaries and statistics on this page are AI-generated from official sources. Always verify important information with <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener" style="color: var(--blue-600);">official HPC records</a>.
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCases() {
    const casesList = document.getElementById('cases-list');
    const toggle = document.getElementById('cases-toggle');
    const toggleText = document.getElementById('toggle-text');
    const hiddenCases = casesList.querySelectorAll('.case-card.hidden');
    const visibleCases = casesList.querySelectorAll('.case-card:not(.hidden)');
    
    if (hiddenCases.length > 0) {
        hiddenCases.forEach(card => card.classList.remove('hidden'));
        toggleText.textContent = 'Show fewer cases';
        toggle.classList.add('expanded');
    } else {
        const cards = casesList.querySelectorAll('.case-card');
        cards.forEach((card, i) => {
            if (i >= 3) card.classList.add('hidden');
        });
        toggleText.textContent = 'Show ' + (cards.length - 3) + ' more recent cases';
        toggle.classList.remove('expanded');
    }
}
</script>
{% endblock %}