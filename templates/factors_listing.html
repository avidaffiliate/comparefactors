{#
Factors Listing Template
All factors grid with search, filters, and sorting
Uses client-side filtering for fast interaction
#}
{% extends "base_listing.html" %}

{% block title %}All Property Factors in Scotland | Compare Factors Scotland{% endblock %}
{% block description %}Compare {{ stats.total }} registered property factors in Scotland. View ratings, tribunal records, and find the right factor for your property.{% endblock %}
{% block canonical %}https://comparefactors.co.uk/factors/{% endblock %}

{% block content %}
<div class="breadcrumb"><a href="/">Home</a><span class="breadcrumb-sep">›</span><span>All Factors</span></div>
<div class="page-header"><h1 class="page-title">All Property Factors</h1><p class="page-subtitle">Compare registered property factors serving Scottish homeowners</p></div>
<div class="main-content">

<div class="stats-bar">
    <div class="stat-item"><div class="stat-value" id="statFactors">{{ stats.active }}</div><div class="stat-label">Showing Factors</div></div>
    <div class="stat-item"><div class="stat-value" id="statProperties">{{ "{:,}".format(stats.total_properties) }}</div><div class="stat-label">Showing Properties</div></div>
    <div class="stat-item"><div class="stat-value" id="statReviews">{{ stats.with_reviews }}</div><div class="stat-label">Showing With Reviews</div></div>
</div>

<div class="filters-bar">
    <input type="text" class="search-input" id="searchInput" placeholder="Search by name...">
    <div class="filter-group">
        <label class="filter-label" for="riskFilter">Tribunal Risk:</label>
        <select class="filter-select" id="riskFilter">
            <option value="">All</option>
            <option value="CLEAN">Clean Record</option>
            <option value="GREEN">Low Risk</option>
            <option value="LIMITED">Limited Data</option>
            <option value="ORANGE">Significant Issues</option>
            <option value="RED">Serious Record</option>
        </select>
    </div>
    <div class="filter-group">
        <label class="filter-label" for="sortFilter">Sort by:</label>
        <select class="filter-select" id="sortFilter">
            <option value="properties" selected>Properties (most)</option>
            <option value="name">Name (A-Z)</option>
            <option value="tribunal">Tribunal Cases 5yr (fewest)</option>
        </select>
    </div>
    <div class="filter-divider"></div>
    <label class="filter-checkbox"><input type="checkbox" id="includeExpired">Include expired / inactive ({{ stats.expired + stats.inactive }})</label>
</div>

<div class="find-factor-box">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>
    <span>Not sure who manages your building?</span>
    <a href="https://www.propertyfactorregister.gov.scot/search" target="_blank" rel="noopener">Check the official register →</a>
</div>

<div class="results-count" id="resultsCount">Showing <strong>{{ stats.active }}</strong> factors</div>

<div class="factor-grid" id="factorGrid">
{% for f in factors %}
{% set is_expired = f.status == 'expired' %}
{% set is_inactive = f.status == 'inactive' %}
{% set is_hidden = is_expired or is_inactive %}
{% set factor_type_lower = (f.factor_type or '')|lower %}
{% set is_rsl = factor_type_lower in ['registered social landlord', 'local authority'] %}
{% set risk = (f.risk_band or 'CLEAN')|lower %}
{# Determine entity type based on factor_type #}
{% if factor_type_lower == 'local authority' %}
    {% set type_class = 'type-council' %}
    {% set type_label = 'Local Authority' %}
{% elif factor_type_lower == 'registered social landlord' %}
    {% set type_class = 'type-rsl' %}
    {% set type_label = 'RSL' %}
{% elif factor_type_lower in ['company', 'partnership', 'sole trader'] %}
    {% set type_class = 'type-commercial' %}
    {% set type_label = 'Commercial' %}
{% else %}
    {# Homeowners Association, Other Legal Status #}
    {% set type_class = 'type-other' %}
    {% set type_label = 'Other' %}
{% endif %}
<div class="factor-card"
     data-name="{{ f.name|lower }}"
     data-risk="{{ f.risk_band or 'CLEAN' }}"
     data-expired="{{ '1' if is_hidden else '0' }}"
     data-properties="{{ f.property_count or 0 }}"
     data-postcodes="{{ f.postcode_count or 0 }}"
     data-tribunal="{{ f.tribunal_case_count_5yr or 0 }}"
     {% if is_hidden %}style="display:none"{% endif %}>
    <div class="factor-card-header">
        <div>
            <h3 class="factor-name"><a href="/factors/{{ f.registration_number|lower }}/">{{ f.name }}</a></h3>
            <div class="factor-reg">{{ f.registration_number }} <span class="factor-type {{ type_class }}">{{ type_label }}</span></div>
        </div>
        <div class="factor-badges">
            {% if is_expired %}<span class="badge badge-expired">Expired</span>{% endif %}
            {% if is_inactive %}<span class="badge badge-inactive">Inactive</span>{% endif %}
            {% if is_rsl %}<span class="badge badge-rsl">{{ 'Council' if factor_type_lower == 'local authority' else 'RSL' }}</span>{% endif %}
            <span class="badge badge-{{ risk }}">{{ f.risk_band or 'Clean' }}</span>
        </div>
    </div>
    <div class="factor-stats">
        <div class="factor-stat">
            <div class="factor-stat-value">{{ "{:,}".format(f.property_count) if f.property_count else '—' }}</div>
            <div class="factor-stat-label">Properties</div>
        </div>
        <div class="factor-stat">
            <div class="factor-stat-value">{{ f.tribunal_case_count_5yr or 0 }}</div>
            <div class="factor-stat-label">Cases (5yr)</div>
        </div>
        <div class="factor-stat">
            <div class="factor-stat-value">{{ f.postcode_count if f.postcode_count else '—' }}</div>
            <div class="factor-stat-label">Postcodes</div>
        </div>
    </div>
    {% if f.google_rating or f.trustpilot_rating %}
    <div class="reviews-row">
        {% if f.google_rating %}
        <div class="review-item">
            <span class="stars">★</span>
            <span class="rating-num">{{ "%.1f"|format(f.google_rating) }}</span>
            <span class="review-count">({{ f.google_review_count }} Google)</span>
        </div>
        {% endif %}
        {% if f.trustpilot_rating %}
        <div class="review-item">
            <span class="stars">★</span>
            <span class="rating-num">{{ "%.1f"|format(f.trustpilot_rating) }}</span>
            <span class="review-count">({{ f.trustpilot_review_count }} Trustpilot)</span>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="no-reviews">No reviews yet</div>
    {% endif %}
    <div class="factor-footer">
        <span class="factor-meta">{{ f.city or 'Scotland' }}</span>
        <a href="/factors/{{ f.registration_number|lower }}/" class="factor-link">View Profile →</a>
    </div>
</div>
{% endfor %}
</div>

</div>
{% endblock %}

{% block scripts %}
const searchInput=document.getElementById('searchInput'),
      riskFilter=document.getElementById('riskFilter'),
      sortFilter=document.getElementById('sortFilter'),
      includeExpired=document.getElementById('includeExpired'),
      grid=document.getElementById('factorGrid'),
      cards=Array.from(grid.querySelectorAll('.factor-card')),
      resultsCount=document.getElementById('resultsCount');

function formatNumber(n){
    if(n>=1000000)return(n/1000000).toFixed(1)+'M';
    if(n>=1000)return Math.round(n/1000)+'K';
    return n.toString();
}

function filterAndSort(){
    const search=searchInput.value.toLowerCase(),
          risk=riskFilter.value,
          sort=sortFilter.value,
          showExpired=includeExpired.checked;

    let visibleCount=0,totalProps=0,withReviews=0;

    cards.forEach(card=>{
        const name=card.dataset.name,
              cardRisk=card.dataset.risk,
              isExpired=card.dataset.expired==='1',
              props=parseInt(card.dataset.properties)||0,
              hasReviews=card.querySelector('.reviews-row')!==null;

        // Filter logic: show if matches search AND risk filter AND (show expired/inactive OR not expired/inactive)
        const matchesSearch=name.includes(search),
              matchesRisk=!risk||cardRisk===risk,
              passesExpired=showExpired||!isExpired;

        const visible=matchesSearch&&matchesRisk&&passesExpired;

        card.style.display=visible?'':'none';

        if(visible){
            visibleCount++;
            totalProps+=props;
            if(hasReviews)withReviews++;
        }
    });

    document.getElementById('statFactors').textContent=visibleCount;
    document.getElementById('statProperties').textContent=formatNumber(totalProps);
    document.getElementById('statReviews').textContent=withReviews;
    resultsCount.innerHTML='Showing <strong>'+visibleCount+'</strong> factors';

    // Sort visible cards
    const visibleCards=cards.filter(c=>c.style.display!=='none');
    visibleCards.sort((a,b)=>{
        switch(sort){
            case'properties':
                return(parseInt(b.dataset.properties)||0)-(parseInt(a.dataset.properties)||0);
            case'tribunal':
                return(parseInt(a.dataset.tribunal)||0)-(parseInt(b.dataset.tribunal)||0);
            default:
                return a.dataset.name.localeCompare(b.dataset.name);
        }
    });
    visibleCards.forEach(card=>grid.appendChild(card));
}

// Initialize from URL params
const urlParams = new URLSearchParams(window.location.search);
const searchParam = urlParams.get('search');
if(searchParam) searchInput.value = searchParam;

filterAndSort();

// Event listeners
searchInput.addEventListener('input',filterAndSort);
riskFilter.addEventListener('change',filterAndSort);
sortFilter.addEventListener('change',filterAndSort);
includeExpired.addEventListener('change',filterAndSort);
{% endblock %}