{% extends "base.html" %}

{# 
Tribunal History Template v2.0 - Mobile & SEO Optimized

Changes:
- SEO: Better title tag and meta description with actual data
- Mobile: Table converts to stacked cards on small screens
- Mobile: Improved spacing and touch targets
- Added structured data for BreadcrumbList
#}

{% block title %}{{ factor.name }} Tribunal Cases & Complaints | Compare Factors{% endblock %}

{% block meta %}
{# SEO-optimized meta description with actual data #}
<meta name="description" content="{{ factor.name }}: {{ stats.total_cases }} tribunal case{{ 's' if stats.total_cases != 1 else '' }} ({{ stats.five_year_cutoff }}–{{ stats.analysis_end_year }}), {{ stats.upheld_rate }}% upheld{% if stats.total_compensation > 0 %}, £{{ '{:,.0f}'.format(stats.total_compensation) }} compensation{% endif %}. {{ stats.risk_band }} risk rating. Full complaint history and analysis.">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://comparefactors.co.uk/factors/{{ factor.slug }}/tribunal/">

<!-- Open Graph -->
<meta property="og:title" content="{{ factor.name }} - Tribunal Record | Compare Factors">
<meta property="og:description" content="{{ stats.total_cases }} tribunal cases, {{ stats.upheld_rate }}% upheld. {{ stats.risk_band }} risk rating.">
<meta property="og:url" content="https://comparefactors.co.uk/factors/{{ factor.slug }}/tribunal/">
<meta property="og:type" content="website">

<!-- Structured Data: BreadcrumbList -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://comparefactors.co.uk/"},
        {"@type": "ListItem", "position": 2, "name": "Factors", "item": "https://comparefactors.co.uk/factors/"},
        {"@type": "ListItem", "position": 3, "name": "{{ factor.name }}", "item": "https://comparefactors.co.uk/factors/{{ factor.slug }}/"},
        {"@type": "ListItem", "position": 4, "name": "Tribunal Record"}
    ]
}
</script>
{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="/">Home</a><span class="sep">›</span>
    <a href="/factors/">Factors</a><span class="sep">›</span>
    <a href="/factors/{{ factor.slug }}/">{{ factor.name }}</a><span class="sep">›</span>
    <span>Tribunal Record</span>
</nav>

<article class="tribunal-history-page">

    <!-- HEADER -->
    <header class="page-header">
        <div class="header-main">
            <a href="/factors/{{ factor.slug }}/" class="back-link">← {{ factor.name }}</a>
            <h1>Tribunal Record</h1>
            <p class="last-updated">{{ stats.five_year_cutoff }}–{{ stats.analysis_end_year }} · Updated {{ stats.last_updated }}</p>
        </div>
    </header>

    <!-- EXECUTIVE SUMMARY -->
    <section class="section summary-section">
        <div class="card">
            <div class="card-body">
                <div class="summary-narrative">
                    <p>
                        <strong>{{ factor.name }}</strong> has faced <strong>{{ stats.total_cases }} tribunal case{{ 's' if stats.total_cases != 1 else '' }}</strong> in the last 5 years,
                        with <strong>{{ stats.upheld_count }} upheld or partially upheld</strong> ({{ stats.upheld_rate }}%).
                        {% if stats.most_recent_case_date %}
                        Most recent: <strong>{{ stats.most_recent_case_date }}</strong>.
                        {% endif %}
                    </p>
                </div>

                <!-- Risk Band Banner -->
                <div class="risk-band-banner risk-band-banner--{{ stats.risk_band | lower }}">
                    <span class="risk-band-label">Tribunal Rating</span>
                    <span class="risk-band-value">{{ stats.risk_band }}</span>
                    <a href="#methodology" class="risk-band-link">How is this calculated?</a>
                </div>

                <div class="summary-grid">
                    <div class="summary-stat">
                        <span class="stat-value">{{ stats.total_cases }}</span>
                        <span class="stat-label">Cases</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-value">{{ stats.upheld_rate }}%</span>
                        <span class="stat-label">Upheld</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-value">{{ stats.pfeo_count }}</span>
                        <span class="stat-label">PFEOs</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-value">£{{ '{:,.0f}'.format(stats.total_compensation) }}</span>
                        <span class="stat-label">Compensation</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TREND CHART -->
    {% if stats.cases_by_year %}
    <section class="section">
        <h2 class="section-title">Cases Over Time</h2>
        <div class="trend-chart">
            {% set max_cases = stats.cases_by_year.values() | max %}
            {% for year, data in stats.cases_by_year.items() %}
            {% set count = data.count if data is mapping else data %}
            {% set annotation = data.annotation if data is mapping else none %}
            <div class="trend-row">
                <span class="trend-year">{{ year }}</span>
                <div class="trend-bar-container">
                    <div class="trend-bar" style="width: {{ (count / max_cases * 100) | round }}%">
                        {% if annotation %}
                        <span class="trend-annotation" title="{{ annotation }}">*</span>
                        {% endif %}
                    </div>
                </div>
                <span class="trend-count">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- OUTCOME BREAKDOWN -->
    <section class="section">
        <h2 class="section-title">Outcomes</h2>
        <div class="outcome-grid">
            {% for outcome in stats.outcomes %}
            <div class="outcome-item outcome-{{ outcome.type | lower | replace(' ', '-') }}">
                <span class="outcome-count">{{ outcome.count }}</span>
                <span class="outcome-label">{{ outcome.type }}</span>
                <span class="outcome-pct">{{ outcome.percentage }}%</span>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- COMPLAINT PATTERNS -->
    {% if stats.complaint_categories and stats.complaint_categories|length > 0 %}
    <section class="section">
        <h2 class="section-title">Complaint Types</h2>
        <p class="section-intro">Based on {{ stats.categorized_cases }} analysed case{{ 's' if stats.categorized_cases != 1 else '' }}.</p>
        <div class="category-chart">
            {% set max_cat = stats.complaint_categories[0].count if stats.complaint_categories else 1 %}
            {% for cat in stats.complaint_categories %}
            <div class="category-row">
                <span class="category-name">{{ cat.name | replace('_', ' ') | title }}</span>
                <div class="category-bar-container">
                    <div class="category-bar cat-{{ cat.name }}" style="width: {{ (cat.count / max_cat * 100) | round }}%"></div>
                </div>
                <span class="category-stats">{{ cat.count }}</span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- CODE BREACHES -->
    {% if stats.code_breaches %}
    <section class="section">
        <h2 class="section-title">Code Breaches</h2>
        <p class="section-intro">Most commonly breached sections of the <a href="https://www.gov.scot/publications/property-factors-scotland-act-2011-code-of-conduct-for-property-factors-2/" target="_blank" rel="noopener">Property Factors Code</a>.</p>
        <div class="breach-list">
            {% for breach in stats.code_breaches %}
            <div class="breach-item">
                <span class="breach-section">§{{ breach.section }}</span>
                <span class="breach-desc">{{ breach.description }}</span>
                <span class="breach-count">{{ breach.count }}</span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- ENFORCEMENT SUMMARY -->
    <section class="section">
        <h2 class="section-title">Enforcement & Compensation</h2>
        
        <div class="enforcement-grid">
            <div class="enforcement-block">
                <h3>Enforcement Orders (PFEOs)</h3>
                <p class="enforcement-headline">
                    <strong>{{ stats.pfeo_count }}</strong> of {{ stats.total_cases }} cases ({{ stats.pfeo_rate }}%)
                </p>
                {% if stats.pfeo_requirements %}
                <ul class="enforcement-list">
                    {% for req in stats.pfeo_requirements %}
                    <li>{{ req.description }} ({{ req.count }})</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>

            <div class="enforcement-block">
                <h3>Compensation Awarded</h3>
                <p class="enforcement-headline">
                    <strong>£{{ '{:,.0f}'.format(stats.total_compensation) }}</strong> total
                </p>
                {% if stats.largest_award %}
                <p class="enforcement-note">
                    Largest: <strong>£{{ '{:,.0f}'.format(stats.largest_award.amount) }}</strong>
                    (<a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_case_reference_number={{ stats.largest_award.case_ref }}" target="_blank" rel="noopener">{{ stats.largest_award.case_ref }}</a>)
                </p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- NOTABLE CASES -->
    {% if notable_cases %}
    <section class="section">
        <h2 class="section-title">Notable Cases</h2>
        <div class="notable-cases">
            {% for case in notable_cases %}
            {% set outcome_display = case.outcome_display | default(case.outcome_type) %}
            <div class="notable-case {% if case.pfeo_issued %}has-pfeo{% endif %}">
                <div class="notable-header">
                    <span class="notable-ref">{{ case.case_ref }}</span>
                    <div class="notable-badges">
                        <span class="outcome-badge outcome-{{ outcome_display | lower | replace(' ', '-') }}">{{ outcome_display }}</span>
                        {% if case.pfeo_issued %}
                        <span class="notable-tag tag-pfeo">⚠ PFEO Issued</span>
                        {% endif %}
                    </div>
                </div>
                <div class="notable-meta">
                    {{ case.hearing_date[:10] }}
                    {% if case.severity_score %}· Severity {{ '%.1f' | format(case.severity_score) }}/10{% endif %}
                    {% if case.compensation_awarded and case.compensation_awarded > 0 %}
                    · £{{ '{:,.0f}'.format(case.compensation_awarded) }} compensation
                    {% endif %}
                </div>
                {% if case.summary %}
                <p class="notable-summary">{{ case.summary }}</p>
                {% endif %}
                {% if case.complaint_categories %}
                <div class="notable-categories">
                    {% for category in case.complaint_categories %}
                    <span class="category-tag tag-{{ category }}">{{ category | replace('_', ' ') | title }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                {% if case.key_quote %}
                <blockquote class="notable-quote">"{{ case.key_quote }}"</blockquote>
                {% endif %}
                <div class="notable-footer">
                    <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_case_reference_number={{ case.case_ref }}" class="notable-link" target="_blank" rel="noopener">View on HPC →</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- FULL CASE LIST -->
    <section class="section">
        <h2 class="section-title">All Cases</h2>

        {# Only default to year filter if 10+ cases, otherwise show all #}
        {# Default to most recent year with cases, not current year #}
        {% set should_filter_year = cases|length >= 10 %}
        {% set latest_case_year = cases[0].hearing_date[:4]|int if cases and cases[0].hearing_date else stats.analysis_end_year %}
        <div class="case-filters">
            <label>
                <span>Year:</span>
                <select id="filter-year">
                    <option value="" {% if not should_filter_year %}selected{% endif %}>All Years</option>
                    {% for year in range(stats.analysis_end_year, stats.five_year_cutoff - 1, -1) %}
                    <option value="{{ year }}" {% if should_filter_year and year == latest_case_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>Outcome:</span>
                <select id="filter-outcome">
                    <option value="">All Outcomes</option>
                    <option value="upheld">Upheld</option>
                    <option value="partial">Partially Upheld</option>
                    <option value="dismissed">Dismissed/Rejected</option>
                    <option value="withdrawn">Withdrawn</option>
                </select>
            </label>
            <button type="button" id="clear-filters" class="clear-filters-btn" style="display: none;">Clear filters</button>
        </div>

        <!-- Case Table -->
        <div class="case-table-wrapper">
            <table class="case-table" id="case-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reference</th>
                        <th>Outcome</th>
                        <th>PFEO</th>
                        <th>Comp.</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for case in cases %}
                    {% set case_year = case.hearing_date[:4] if case.hearing_date else '' %}
                    {% set outcome_lower = (case.outcome_display | default(case.outcome_type) | default('unknown')) | lower %}
                    {% set outcome_normalized = 'upheld' if 'upheld' in outcome_lower and 'partial' not in outcome_lower else ('partial' if 'partial' in outcome_lower else ('dismissed' if 'dismissed' in outcome_lower or 'rejected' in outcome_lower else ('withdrawn' if 'withdrawn' in outcome_lower else 'other'))) %}
                    <tr class="case-row"
                        data-year="{{ case_year }}"
                        data-outcome="{{ outcome_normalized }}"
                        data-case-id="{{ case.case_ref | replace('/', '-') }}">
                        <td>{{ case.hearing_date[:10] if case.hearing_date else '—' }}</td>
                        <td><code>{{ case.case_ref }}</code></td>
                        <td><span class="outcome-pill outcome-{{ outcome_normalized }}">{{ case.outcome_display | default(case.outcome_type) | default('Unknown') }}</span></td>
                        <td>{% if case.pfeo_issued %}<span class="pfeo-badge">PFEO</span>{% else %}—{% endif %}</td>
                        <td>{% if case.compensation_awarded and case.compensation_awarded > 0 %}£{{ '{:,.0f}'.format(case.compensation_awarded) }}{% else %}—{% endif %}</td>
                        <td>
                            <a href="#case-{{ case.case_ref | replace('/', '-') }}" class="view-details-link">Details</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="no-results-message" id="no-results" style="display: none;">
            <p>No cases match your filters.</p>
        </div>

        <div class="results-count" id="results-count"></div>

        <div class="source-note">
            <p>
                Data from <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener">Housing & Property Chamber</a>.
                Last 5 years ({{ stats.five_year_cutoff }}–{{ stats.analysis_end_year }}).
            </p>
        </div>
    </section>

    <!-- CASE DETAILS -->
    <section class="section" id="case-details-section">
        <h2 class="section-title">Case Details</h2>
        <p class="section-intro">Click "Details" in the table above to jump to a case.</p>

        <div class="case-details-list">
            {% for case in cases %}
            {% set case_year = case.hearing_date[:4] if case.hearing_date else '' %}
            {% set outcome_lower = (case.outcome_display | default(case.outcome_type) | default('unknown')) | lower %}
            {% set outcome_normalized = 'upheld' if 'upheld' in outcome_lower and 'partial' not in outcome_lower else ('partial' if 'partial' in outcome_lower else ('dismissed' if 'dismissed' in outcome_lower or 'rejected' in outcome_lower else ('withdrawn' if 'withdrawn' in outcome_lower else 'other'))) %}
            <div class="case-detail-card"
                 id="case-{{ case.case_ref | replace('/', '-') }}"
                 data-year="{{ case_year }}"
                 data-outcome="{{ outcome_normalized }}">
                <div class="case-detail-header">
                    <div class="case-detail-title">
                        <code class="case-ref">{{ case.case_ref }}</code>
                        <span class="case-date">{{ case.hearing_date[:10] if case.hearing_date else '' }}</span>
                    </div>
                    <div class="case-detail-badges">
                        <span class="outcome-pill outcome-{{ outcome_normalized }}">{{ case.outcome_display | default(case.outcome_type) | default('Unknown') }}</span>
                        {% if case.pfeo_issued %}
                        <span class="pfeo-badge">PFEO Issued</span>
                        {% endif %}
                        {% if case.compensation_awarded and case.compensation_awarded > 0 %}
                        <span class="comp-badge">£{{ '{:,.0f}'.format(case.compensation_awarded) }}</span>
                        {% endif %}
                    </div>
                </div>

                {% if case.summary %}
                <p class="case-summary">{{ case.summary }}</p>
                {% endif %}

                {% if case.complaint_categories and case.complaint_categories | length > 0 %}
                <div class="case-categories">
                    {% for category in case.complaint_categories %}
                    <span class="category-tag tag-{{ category }}">{{ category | replace('_', ' ') | title }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if case.key_quote %}
                <blockquote class="case-quote">"{{ case.key_quote }}"</blockquote>
                {% endif %}

                <div class="case-detail-footer">
                    <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_case_reference_number={{ case.case_ref }}" target="_blank" rel="noopener" class="hpc-link">View full decision on HPC →</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- METHODOLOGY -->
    <section class="section" id="methodology">
        <details class="methodology-toggle">
            <summary>
                <h2 class="section-title inline-title">How We Calculate Ratings</h2>
            </summary>
            <div class="methodology-content">
                <p>Ratings are based on a factor's <strong>adjusted adverse case rate</strong> per 10,000 properties over the past 5 years. Cases involving Property Factor Enforcement Orders (PFEOs) are weighted more heavily.</p>

                <h3>Rating Bands</h3>
                <div class="rating-bands">
                    <div class="rating-band">
                        <span class="band-badge band-clean">CLEAN</span>
                        <span class="band-desc">Zero adverse cases in the past 5 years</span>
                    </div>
                    <div class="rating-band">
                        <span class="band-badge band-green">GREEN</span>
                        <span class="band-desc">Adjusted rate of 10 or fewer per 10,000 properties</span>
                    </div>
                    <div class="rating-band">
                        <span class="band-badge band-orange">ORANGE</span>
                        <span class="band-desc">Rate between 11–30 per 10,000, OR 2+ PFEO breaches</span>
                    </div>
                    <div class="rating-band">
                        <span class="band-badge band-red">RED</span>
                        <span class="band-desc">Rate above 30 per 10,000 properties</span>
                    </div>
                    <div class="rating-band">
                        <span class="band-badge band-limited">LIMITED</span>
                        <span class="band-desc">Fewer than 50 properties (insufficient data)</span>
                    </div>
                </div>

                <h3>Special Rules</h3>
                <ul>
                    <li>Factors with only 1–2 adverse cases (no PFEO breaches) are capped at GREEN</li>
                    <li>2+ PFEO breaches = minimum ORANGE rating regardless of case rate</li>
                </ul>

                <p><a href="/methodology/" class="methodology-link">Read our full methodology →</a></p>

                <h3>Data Updates</h3>
                <ul>
                    <li><strong>Last updated:</strong> {{ stats.last_updated }}</li>
                    <li><strong>Next update:</strong> {{ stats.next_update }}</li>
                </ul>
                <p>We update quarterly. For the latest decisions, <a href="https://www.housingandpropertychamber.scot/search-decisions" target="_blank" rel="noopener">search the HPC directly →</a></p>
            </div>
        </details>
    </section>

    <!-- CTA -->
    <section class="section cta-section">
        <h2>Looking for alternatives?</h2>
        <p>Compare quotes from factors with better tribunal records.</p>
        <a href="/get-quotes/?exclude={{ factor.registration_number }}" class="btn-primary">Get Free Quotes</a>
        <p class="cta-back"><a href="/factors/{{ factor.slug }}/">← Back to {{ factor.name }} profile</a></p>
    </section>

</article>
{% endblock %}

{% block styles %}
<style>
/* =============================================================================
   TRIBUNAL HISTORY PAGE - Mobile Optimized
   ============================================================================= */

:root {
    --primary: #1e40af;
    --primary-dark: #1e3a8a;
    --text: #1e293b;
    --text-muted: #64748b;
    --bg: #ffffff;
    --bg-muted: #f8fafc;
    --bg-hover: #f1f5f9;
    --border: #e2e8f0;
    --border-light: #f1f5f9;
    --red-50: #fef2f2;
    --red-600: #dc2626;
    --red-700: #b91c1c;
    --amber-50: #fffbeb;
    --amber-700: #b45309;
    --green-50: #f0fdf4;
    --green-600: #16a34a;
    --green-700: #15803d;
    --orange-50: #fff7ed;
    --orange-600: #ea580c;
}

/* Card Component */
.card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}

.card-body {
    padding: 1.25rem;
}

/* Layout */
.tribunal-history-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem 2rem;
}

.breadcrumb {
    max-width: 800px;
    margin: 0 auto;
    padding: 0.75rem 1rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.breadcrumb a { color: var(--text-muted); text-decoration: none; }
.breadcrumb a:hover { color: var(--primary); }
.breadcrumb .sep { margin: 0 0.4rem; color: var(--border); }

/* Page Header */
.page-header {
    padding: 1rem 0 1.5rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.5rem;
}

.back-link {
    font-size: 0.85rem;
    color: var(--primary);
    text-decoration: none;
}

.page-header h1 {
    font-size: 1.5rem;
    margin: 0.5rem 0 0.25rem;
    color: var(--text);
}

.last-updated {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0;
}

/* Sections */
.section {
    margin-bottom: 1.5rem;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 1rem;
}

.section-intro {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: -0.5rem 0 1rem;
}

/* Summary Section - no box */
.summary-section {
    background: transparent;
    border: none;
    padding: 0;
}

/* Summary Narrative */
.summary-narrative {
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

/* Risk Band Banner */
.risk-band-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.risk-band-label { font-weight: 500; opacity: 0.9; }
.risk-band-value { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; }
.risk-band-link { font-size: 0.75rem; opacity: 0.8; text-decoration: none; }
.risk-band-link:hover { text-decoration: underline; }

.risk-band-banner--clean { background: #ecfdf5; color: #047857; }
.risk-band-banner--green { background: #f0fdf4; color: var(--green-700); }
.risk-band-banner--orange { background: var(--orange-50); color: var(--orange-600); }
.risk-band-banner--red { background: var(--red-50); color: var(--red-700); }
.risk-band-banner--limited { background: var(--bg-muted); color: var(--text-muted); }

/* Summary Grid */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
}

.summary-stat {
    text-align: center;
    padding: 1rem 0.5rem;
    background: var(--bg-muted);
    border-radius: 8px;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
}

.stat-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-top: 0.25rem;
}

/* Trend Chart */
.trend-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.trend-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.trend-year {
    width: 45px;
    font-size: 0.8rem;
    color: var(--text-muted);
    flex-shrink: 0;
}

.trend-bar-container {
    flex: 1;
    height: 20px;
    background: var(--bg-muted);
    border-radius: 4px;
    overflow: hidden;
}

.trend-bar {
    height: 100%;
    background: var(--primary);
    border-radius: 4px;
    min-width: 4px;
}

.trend-count {
    width: 28px;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: right;
    flex-shrink: 0;
}

/* Outcome Grid */
.outcome-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.outcome-item {
    text-align: center;
    padding: 0.75rem 0.5rem;
    border-radius: 8px;
    background: var(--bg-muted);
}

.outcome-count {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
}

.outcome-label {
    display: block;
    font-size: 0.7rem;
    margin-top: 0.2rem;
}

.outcome-pct {
    display: block;
    font-size: 0.7rem;
    opacity: 0.7;
}

.outcome-upheld { background: var(--red-50); color: var(--red-700); }
.outcome-partially-upheld { background: var(--amber-50); color: var(--amber-700); }
.outcome-dismissed, .outcome-rejected, .outcome-dismissed-rejected { background: var(--green-50); color: var(--green-700); }
.outcome-withdrawn { background: var(--bg-muted); color: var(--text-muted); }
.outcome-pfeo-issued, .outcome-pfeo-breached, .outcome-pfeo { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
.outcome-pfeo-complied { background: #fefce8; color: #854d0e; border: 1px solid #fef08a; }

/* Category Chart */
.category-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.category-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.category-name {
    width: 100px;
    font-size: 0.8rem;
    flex-shrink: 0;
}

.category-bar-container {
    flex: 1;
    height: 16px;
    background: var(--bg-muted);
    border-radius: 4px;
    overflow: hidden;
}

.category-bar {
    height: 100%;
    background: #6366f1;
    border-radius: 4px;
    min-width: 4px;
}

.category-stats {
    width: 30px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: right;
    flex-shrink: 0;
}

/* Category-specific bar colors */
.cat-communication { background: #3b82f6; }
.cat-financial { background: #f59e0b; }
.cat-maintenance { background: #ef4444; }
.cat-insurance { background: #14b8a6; }
.cat-governance { background: #6366f1; }
.cat-disclosure { background: #8b5cf6; }
.cat-health_safety { background: #dc2626; }
.cat-debt_recovery { background: #ea580c; }

/* Code Breaches - Mobile friendly list instead of table */
.breach-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.breach-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-muted);
    border-radius: 6px;
}

.breach-section {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--primary);
    flex-shrink: 0;
}

.breach-desc {
    flex: 1;
    font-size: 0.85rem;
    color: var(--text);
}

.breach-count {
    font-weight: 600;
    font-size: 0.9rem;
    flex-shrink: 0;
}

/* Enforcement Grid */
.enforcement-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.enforcement-block {
    padding: 1rem;
    background: var(--bg-muted);
    border-radius: 8px;
}

.enforcement-block h3 {
    font-size: 0.85rem;
    font-weight: 600;
    margin: 0 0 0.5rem;
}

.enforcement-headline {
    font-size: 0.9rem;
    margin: 0 0 0.5rem;
}

.enforcement-headline strong {
    font-size: 1.25rem;
}

.enforcement-list {
    font-size: 0.8rem;
    margin: 0;
    padding-left: 1.25rem;
}

.enforcement-list li {
    margin-bottom: 0.25rem;
}

.enforcement-note {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0.5rem 0 0;
}

/* Notable Cases */
.notable-cases {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.notable-case {
    padding: 1.25rem;
    background: var(--bg-muted);
    border: 1px solid var(--border);
    border-radius: 8px;
}

.notable-case.has-pfeo {
    border-left: 3px solid var(--red-600);
    background: var(--red-50);
}

.notable-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.notable-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.notable-ref {
    font-family: monospace;
    font-size: 0.9rem;
    font-weight: 600;
}

.notable-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}

.notable-summary {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text);
    margin: 0 0 0.75rem;
}

.notable-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
}

.category-tag {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 500;
    background: #e0e7ff;
    color: #3730a3;
}

.tag-communication { background: #dbeafe; color: #1e40af; }
.tag-financial { background: #fef3c7; color: #92400e; }
.tag-maintenance { background: #fee2e2; color: #991b1b; }
.tag-code_breach { background: #ede9fe; color: #5b21b6; }
.tag-disclosure { background: #f3e8ff; color: #7c3aed; }
.tag-insurance { background: #ccfbf1; color: #0f766e; }
.tag-governance { background: #e0e7ff; color: #4338ca; }
.tag-health_safety { background: #fecaca; color: #b91c1c; }
.tag-debt_recovery { background: #fed7aa; color: #c2410c; }

.notable-quote {
    font-size: 0.85rem;
    font-style: italic;
    color: var(--text-muted);
    margin: 0 0 0.75rem;
    padding: 0.75rem 1rem;
    border-left: 3px solid var(--primary);
    background: #fff;
    border-radius: 0 6px 6px 0;
    line-height: 1.6;
}

.notable-footer {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-light);
}

.notable-tag {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
}

.tag-pfeo { background: var(--red-50); color: var(--red-700); border: 1px solid #fecaca; }
.tag-comp { background: var(--amber-50); color: var(--amber-700); }

.notable-link {
    font-size: 0.85rem;
    color: var(--primary);
    text-decoration: none;
    margin-left: auto;
    font-weight: 500;
}

.notable-link:hover {
    text-decoration: underline;
}

/* Outcome Badge */
.outcome-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
}

.outcome-badge.outcome-upheld { background: var(--red-50); color: var(--red-700); }
.outcome-badge.outcome-partially-upheld { background: var(--amber-50); color: var(--amber-700); }
.outcome-badge.outcome-dismissed, .outcome-badge.outcome-rejected { background: var(--green-50); color: var(--green-700); }
.outcome-badge.outcome-pfeo-issued, .outcome-badge.outcome-pfeo-breached, .outcome-badge.outcome-pfeo { background: #fef2f2; color: #991b1b; }
.outcome-badge.outcome-pfeo-complied { background: #fefce8; color: #854d0e; }

/* Case Filters */
.case-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.case-filters label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
}

.case-filters select {
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    background: #fff;
}

/* =============================================================================
   CASE TABLE
   ============================================================================= */

.case-table-wrapper {
    overflow-x: auto;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
}

.case-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.case-table th,
.case-table td {
    padding: 0.65rem 0.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.case-table th {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.7rem;
    text-transform: uppercase;
    background: var(--bg-muted);
}

.case-table tbody tr:hover {
    background: var(--bg-muted);
}

.case-table code {
    font-size: 0.8rem;
    background: var(--bg-muted);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
}

.case-table .pdf-link {
    color: var(--primary);
    text-decoration: none;
    font-size: 0.8rem;
}

.outcome-pill {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    white-space: nowrap;
}

.outcome-pill.outcome-upheld { background: var(--red-50); color: var(--red-700); }
.outcome-pill.outcome-partial { background: var(--amber-50); color: var(--amber-700); }
.outcome-pill.outcome-dismissed { background: var(--green-50); color: var(--green-700); }
.outcome-pill.outcome-withdrawn { background: var(--bg-muted); color: var(--text-muted); }
.outcome-pill.outcome-other { background: var(--bg-muted); color: var(--text-muted); }

.pfeo-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 700;
    background: var(--red-50);
    color: var(--red-700);
    border: 1px solid #fecaca;
}

.comp-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    background: var(--amber-50);
    color: var(--amber-700);
}

.view-details-link {
    color: var(--primary);
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
}

.view-details-link:hover {
    text-decoration: underline;
}

.clear-filters-btn {
    padding: 0.4rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.8rem;
    background: #fff;
    cursor: pointer;
    color: var(--text-muted);
}

.clear-filters-btn:hover {
    background: var(--bg-muted);
    color: var(--text);
}

.no-results-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.results-count {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.75rem;
}

/* Case Details Section */
.case-details-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.case-detail-card {
    padding: 1.25rem;
    background: var(--bg-muted);
    border: 1px solid var(--border);
    border-radius: 8px;
    scroll-margin-top: 1rem;
}

.case-detail-card:target {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.case-detail-card.highlight {
    animation: highlight-flash 1.5s ease-out;
}

@keyframes highlight-flash {
    0% { background: #dbeafe; border-color: var(--primary); }
    100% { background: var(--bg-muted); border-color: var(--border); }
}

.case-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.case-detail-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.case-detail-title .case-ref {
    font-size: 0.95rem;
    font-weight: 600;
    background: #fff;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.case-detail-title .case-date {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.case-detail-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.case-summary {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text);
    margin: 0 0 0.75rem;
}

.case-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
}

.case-quote {
    font-size: 0.85rem;
    font-style: italic;
    color: var(--text-muted);
    margin: 0 0 0.75rem;
    padding: 0.75rem 1rem;
    border-left: 3px solid var(--primary);
    background: #fff;
    border-radius: 0 6px 6px 0;
    line-height: 1.6;
}

.case-detail-footer {
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light);
}

.hpc-link {
    font-size: 0.85rem;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}

.hpc-link:hover {
    text-decoration: underline;
}

.hidden-row {
    display: none;
}

.hidden-card {
    display: none;
}

/* =============================================================================
   RESPONSIVE TABLE
   ============================================================================= */

/* Source Note */
.source-note {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background: #fefce8;
    border: 1px solid #fef08a;
    border-radius: 8px;
    font-size: 0.8rem;
}

.source-note p {
    margin: 0;
}

.source-note a {
    color: var(--primary);
}

/* Methodology - section already has box, so toggle is transparent */
.methodology-toggle {
    background: transparent;
}

.methodology-toggle summary {
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 500;
}

.methodology-toggle summary::after {
    content: "+";
    font-size: 1.1rem;
    color: var(--text-muted);
}

.methodology-toggle[open] summary::after {
    content: "−";
}

.methodology-toggle summary::-webkit-details-marker {
    display: none;
}

.inline-title {
    display: inline;
    margin: 0;
    font-size: 1rem;
}

.methodology-content {
    padding: 0 1rem 1rem;
}

.methodology-content h3 {
    font-size: 0.9rem;
    margin: 1rem 0 0.4rem;
}

.methodology-content p,
.methodology-content ul {
    font-size: 0.85rem;
    line-height: 1.6;
    margin-bottom: 0.5rem;
}

.methodology-content ul {
    padding-left: 1.25rem;
}

/* Rating Bands */
.rating-bands {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.rating-band {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.band-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    min-width: 70px;
    text-align: center;
}

.band-clean { background: #ecfdf5; color: #047857; }
.band-green { background: var(--green-50); color: var(--green-700); }
.band-orange { background: var(--orange-50); color: var(--orange-600); }
.band-red { background: var(--red-50); color: var(--red-700); }
.band-limited { background: var(--bg-muted); color: var(--text-muted); }

.band-desc {
    font-size: 0.8rem;
    color: var(--text);
}

.methodology-link {
    color: var(--primary);
    font-weight: 500;
}

/* CTA Section - inherits section box styling */
.cta-section {
    text-align: center;
    background: var(--primary);
    color: #fff;
}

.cta-section h2 {
    font-size: 1.1rem;
    margin: 0 0 0.4rem;
    color: #fff;
}

.cta-section > p {
    font-size: 0.9rem;
    color: rgba(255,255,255,0.85);
    margin-bottom: 1rem;
}

.cta-section .btn-primary {
    display: inline-block;
    padding: 0.65rem 1.5rem;
    background: #fff;
    color: var(--primary);
    font-weight: 600;
    font-size: 0.9rem;
    border-radius: 6px;
    text-decoration: none;
}

.cta-section .btn-primary:hover {
    background: var(--bg-muted);
}

.cta-back {
    margin-top: 0.75rem;
    font-size: 0.85rem;
}

.cta-back a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
}

.cta-back a:hover {
    color: #fff;
}

/* =============================================================================
   MOBILE RESPONSIVE
   ============================================================================= */

@media (max-width: 700px) {
    /* Tighter spacing */
    .tribunal-history-page {
        padding: 0 0.75rem 1.5rem;
    }
    
    .breadcrumb {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .page-header {
        padding: 0.75rem 0 1rem;
    }
    
    .page-header h1 {
        font-size: 1.25rem;
    }
    
    /* Summary grid: 2x2 */
    .summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-value {
        font-size: 1.25rem;
    }
    
    /* Risk band */
    .risk-band-banner {
        flex-wrap: wrap;
        padding: 0.6rem 0.75rem;
    }
    
    .risk-band-label {
        width: 100%;
        text-align: center;
        font-size: 0.75rem;
    }
    
    /* Outcome grid: 2x2 */
    .outcome-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    /* Enforcement: stack */
    .enforcement-grid {
        grid-template-columns: 1fr;
    }
    
    /* Category names shorter */
    .category-name {
        width: 80px;
        font-size: 0.75rem;
    }
    
    /* Notable cases */
    .notable-case {
        padding: 0.75rem;
    }
    
    .notable-quote {
        font-size: 0.8rem;
    }
    
    /* Sections */
    .section {
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1rem;
    }

    /* Case filters */
    .case-filters {
        flex-direction: column;
        gap: 0.5rem;
    }

    .case-filters label {
        width: 100%;
    }

    .case-filters select {
        flex: 1;
    }

    /* Table - make compact on mobile */
    .case-table {
        font-size: 0.75rem;
    }

    .case-table th,
    .case-table td {
        padding: 0.5rem 0.35rem;
    }

    .case-table code {
        font-size: 0.7rem;
    }

    /* Case detail cards */
    .case-detail-card {
        padding: 1rem;
    }

    .case-detail-header {
        flex-direction: column;
        gap: 0.5rem;
    }

    .case-detail-title {
        flex-wrap: wrap;
    }

    .case-quote {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
}

@media (max-width: 400px) {
    .summary-stat {
        padding: 0.75rem 0.25rem;
    }
    
    .stat-value {
        font-size: 1.1rem;
    }
    
    .stat-label {
        font-size: 0.65rem;
    }
    
    .breach-item {
        flex-wrap: wrap;
    }
    
    .breach-desc {
        width: 100%;
        order: 3;
        margin-top: 0.25rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearFilter = document.getElementById('filter-year');
    const outcomeFilter = document.getElementById('filter-outcome');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const noResultsMsg = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const rows = document.querySelectorAll('.case-row');
    const detailCards = document.querySelectorAll('.case-detail-card');

    function applyFilters() {
        const yearVal = yearFilter ? yearFilter.value : '';
        const outcomeVal = outcomeFilter ? outcomeFilter.value : '';
        let visibleCount = 0;

        // Filter table rows
        rows.forEach(row => {
            const rowYear = row.dataset.year || '';
            const rowOutcome = row.dataset.outcome || '';
            const yearMatch = !yearVal || rowYear === yearVal;
            const outcomeMatch = !outcomeVal || rowOutcome === outcomeVal;
            const visible = yearMatch && outcomeMatch;
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        // Filter case detail cards to match
        detailCards.forEach(card => {
            const cardYear = card.dataset.year || '';
            const cardOutcome = card.dataset.outcome || '';
            const yearMatch = !yearVal || cardYear === yearVal;
            const outcomeMatch = !outcomeVal || cardOutcome === outcomeVal;
            card.style.display = (yearMatch && outcomeMatch) ? '' : 'none';
        });

        // Show/hide no results message
        if (noResultsMsg) {
            noResultsMsg.style.display = visibleCount === 0 ? '' : 'none';
        }

        // Update results count
        if (resultsCount) {
            const totalCount = rows.length;
            if (yearVal || outcomeVal) {
                resultsCount.textContent = `Showing ${visibleCount} of ${totalCount} cases`;
            } else {
                resultsCount.textContent = '';
            }
        }

        // Show/hide clear filters button
        if (clearFiltersBtn) {
            clearFiltersBtn.style.display = (yearVal || outcomeVal) ? '' : 'none';
        }
    }

    // Attach filter listeners
    if (yearFilter) {
        yearFilter.addEventListener('change', applyFilters);
    }
    if (outcomeFilter) {
        outcomeFilter.addEventListener('change', applyFilters);
    }

    // Clear filters
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            if (yearFilter) yearFilter.value = '';
            if (outcomeFilter) outcomeFilter.value = '';
            applyFilters();
        });
    }

    // Apply initial filter (year defaults to current year)
    applyFilters();

    // Handle "View details" clicks - scroll and highlight
    document.querySelectorAll('.view-details-link').forEach(link => {
        link.addEventListener('click', function(e) {
            const targetId = this.getAttribute('href').substring(1);
            const targetCard = document.getElementById(targetId);
            if (targetCard) {
                // Make sure the card is visible (clear outcome filter if needed)
                if (targetCard.style.display === 'none') {
                    if (outcomeFilter) outcomeFilter.value = '';
                    applyFilters();
                }
                // Scroll to card
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Add highlight effect
                targetCard.classList.add('highlight');
                setTimeout(() => targetCard.classList.remove('highlight'), 1500);
            }
        });
    });
});
</script>
{% endblock %}