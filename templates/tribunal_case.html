{% extends "base.html" %}

{% block title %}{{ case.case_ref }} | Tribunal Decision | Compare Factors{% endblock %}

{% block meta %}
<meta name="description" content="Tribunal decision {{ case.case_ref }} against {{ case.factor_name }}. {{ case.outcome }} - {{ case.hearing_date[:10] }}. Read the full summary.">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://comparefactors.co.uk/tribunal/case/{{ case.case_ref | lower | replace('/', '-') }}/">

<!-- JSON-LD Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "LegalCase",
    "name": "{{ case.case_ref }} - {{ case.factor_name }}",
    "identifier": "{{ case.case_ref }}",
    "datePublished": "{{ case.hearing_date[:10] }}",
    "description": "{{ case.summary | truncate(200) | replace('"', '\\"') if case.summary else 'Tribunal decision against ' + case.factor_name }}",
    "court": {
        "@type": "Organization",
        "name": "Housing and Property Chamber, First-tier Tribunal for Scotland",
        "url": "https://www.housingandpropertychamber.scot/"
    },
    "url": "https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_case_reference_number={{ case.case_ref }}",
    "about": {
        "@type": "Organization",
        "name": "{{ case.factor_name }}"
    },
    "isPartOf": {
        "@type": "WebSite",
        "name": "Compare Factors",
        "url": "https://comparefactors.co.uk/"
    }
}
</script>
{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="/">Home</a><span class="sep">›</span>
    <a href="/factors/{{ case.factor_slug }}/">{{ case.factor_name }}</a><span class="sep">›</span>
    <span>{{ case.case_ref }}</span>
</nav>

<article class="case-page">

    <!-- HEADER -->
    <header class="case-header">
        <div class="case-header-main">
            <span class="case-ref">{{ case.case_ref }}</span>
            <h1 class="case-title">
                Complaint against <a href="/factors/{{ case.factor_slug }}/">{{ case.factor_name }}</a>
            </h1>
            <div class="case-meta">
                {% if case.property_location %}
                <span class="meta-item">
                    <svg class="icon-location" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span>{{ case.property_location }}</span>
                </span>
                {% endif %}
                <span class="meta-item">
                    <svg class="icon-calendar" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span>{{ case.hearing_date[:10] }}</span>
                </span>
            </div>
        </div>
        <div class="case-outcome-badge outcome-{{ case.outcome_type | lower | replace(' ', '-') }}">
            {{ case.outcome_type }}
        </div>
    </header>

    <!-- AT A GLANCE -->
    <section class="case-section case-glance">
        <h2 class="section-title">At a Glance</h2>
        <div class="glance-grid">
            <div class="glance-item">
                <span class="glance-label">Complaints Made</span>
                <span class="glance-value">{{ case.complaints_made or '—' }}</span>
            </div>
            <div class="glance-item">
                <span class="glance-label">Complaints Upheld</span>
                <span class="glance-value">{{ case.complaints_upheld or '—' }}</span>
            </div>
            <div class="glance-item">
                <span class="glance-label">PFEO Issued</span>
                <span class="glance-value {% if case.pfeo_issued %}text-warning{% endif %}">
                    {{ 'Yes' if case.pfeo_issued else 'No' }}
                </span>
            </div>
            <div class="glance-item">
                <span class="glance-label">Compensation</span>
                <span class="glance-value">
                    {% if case.compensation_awarded and case.compensation_awarded > 0 %}
                    £{{ '{:,.0f}'.format(case.compensation_awarded) }}
                    {% else %}
                    None
                    {% endif %}
                </span>
            </div>
            <div class="glance-item">
                <span class="glance-label">Factor Attended</span>
                <span class="glance-value {% if case.factor_attended == 'no' %}text-warning{% endif %}">
                    {{ case.factor_attended | capitalize if case.factor_attended else '—' }}
                </span>
            </div>
            <div class="glance-item">
                <span class="glance-label">
                    Severity
                    <a href="#methodology" class="info-tooltip" aria-label="How severity is calculated">
                        <svg class="icon-info" aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    </a>
                </span>
                <span class="glance-value">
                    {% if case.severity_score %}
                    <span class="severity-badge severity-{{ 'high' if case.severity_score >= 7 else 'medium' if case.severity_score >= 4 else 'low' }}">
                        {{ '%.1f' | format(case.severity_score) }}/10
                    </span>
                    {% else %}
                    —
                    {% endif %}
                </span>
            </div>
        </div>
    </section>

    <!-- SUMMARY -->
    {% if case.summary %}
    <section class="case-section">
        <h2 class="section-title">Summary</h2>
        <p class="case-summary">{{ case.summary }}</p>
        <p class="ai-note">AI-extracted from official tribunal decision</p>
    </section>
    {% endif %}

    <!-- COMPLAINT CATEGORIES -->
    {% if case.complaint_categories %}
    <section class="case-section">
        <h2 class="section-title">Complaint Categories</h2>
        <div class="category-tags">
            {% for category in case.complaint_categories %}
            <span class="category-tag tag-{{ category }}">{{ category | replace('_', ' ') | title }}</span>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- KEY FINDING -->
    {% if case.key_quote %}
    <section class="case-section">
        <h2 class="section-title">Tribunal's Key Finding</h2>
        <blockquote class="key-quote">
            "{{ case.key_quote }}"
        </blockquote>
    </section>
    {% endif %}

    <!-- CODE BREACHES -->
    {% if case.code_breaches %}
    <section class="case-section">
        <h2 class="section-title">Code of Conduct Breaches</h2>
        <ul class="breach-list">
            {% for breach in case.code_breaches %}
            <li>{{ breach }}</li>
            {% endfor %}
        </ul>
        <p class="source-note">Breaches of the <a href="https://www.gov.scot/publications/property-factors-scotland-act-2011-code-of-conduct-for-property-factors-2/" target="_blank" rel="noopener">Property Factors Code of Conduct</a></p>
    </section>
    {% endif %}

    <!-- ENFORCEMENT -->
    {% if case.pfeo_issued or (case.compensation_awarded and case.compensation_awarded > 0) %}
    <section class="case-section">
        <h2 class="section-title">Enforcement &amp; Compensation</h2>
        
        {% if case.pfeo_issued %}
        <div class="enforcement-block">
            <h3>Property Factor Enforcement Order</h3>
            {% if case.pfeo_requirements %}
            <p><strong>Requirements:</strong> {{ case.pfeo_requirements }}</p>
            {% endif %}
            {% if case.pfeo_evidence %}
            <blockquote class="evidence-quote">"{{ case.pfeo_evidence }}"</blockquote>
            {% endif %}
        </div>
        {% endif %}

        {% if case.compensation_awarded and case.compensation_awarded > 0 %}
        <div class="enforcement-block">
            <h3>Compensation Awarded</h3>
            <p class="compensation-amount">£{{ '{:,.2f}'.format(case.compensation_awarded) }}</p>
            {% if case.compensation_breakdown %}
            <ul class="compensation-breakdown">
                {% for item in case.compensation_breakdown %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% if case.compensation_evidence %}
            <blockquote class="evidence-quote">"{{ case.compensation_evidence }}"</blockquote>
            {% endif %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    <!-- FACTOR CONDUCT -->
    {% if case.factor_attended or case.factor_cooperated or case.factor_conduct %}
    <section class="case-section">
        <h2 class="section-title">Factor's Conduct During Proceedings</h2>
        <dl class="conduct-list">
            {% if case.factor_attended %}
            <dt>Attendance</dt>
            <dd>{{ 'Factor attended hearing or submitted representations' if case.factor_attended == 'yes' else 'Factor did not attend or respond' if case.factor_attended == 'no' else 'Not specified' }}</dd>
            {% endif %}
            {% if case.factor_cooperated %}
            <dt>Cooperation</dt>
            <dd>{{ case.factor_cooperated | capitalize }}</dd>
            {% endif %}
        </dl>
        {% if case.factor_conduct %}
        <p>{{ case.factor_conduct }}</p>
        {% endif %}
    </section>
    {% endif %}

    <!-- FULL TEXT (COLLAPSED) -->
    {% if case.full_text %}
    <section class="case-section">
        <h2 class="section-title">Full Tribunal Decision</h2>
        <details class="full-text-toggle">
            <summary>
                <span class="toggle-icon">▶</span> 
                Show Full Text 
                <span class="word-count">(~{{ (case.full_text | wordcount) | round(-2) | int }} words)</span>
            </summary>
            <div class="full-text-content">
                {{ case.full_text | redact_names | nl2br }}
            </div>
        </details>
    </section>
    {% endif %}

    <!-- METHODOLOGY -->
    <section class="case-section" id="methodology">
        <details class="methodology-toggle">
            <summary>
                <h2 class="section-title inline-title">How We Calculate Severity</h2>
            </summary>
            <div class="methodology-content">
                <p>The severity score (0-10) is AI-extracted based on objective factors in the tribunal decision:</p>
                <ul>
                    <li><strong>Outcome weight:</strong> Upheld complaints score higher than dismissed</li>
                    <li><strong>Enforcement:</strong> PFEO issued adds to severity</li>
                    <li><strong>Compensation:</strong> Higher awards indicate more serious failings</li>
                    <li><strong>Code breaches:</strong> Multiple sections breached increases score</li>
                    <li><strong>Factor conduct:</strong> Non-attendance or non-cooperation adds weight</li>
                </ul>
                <p><strong>Score ranges:</strong></p>
                <ul>
                    <li><span class="severity-badge severity-low">0-3.9</span> Minor or procedural issues</li>
                    <li><span class="severity-badge severity-medium">4-6.9</span> Moderate failures requiring correction</li>
                    <li><span class="severity-badge severity-high">7-10</span> Serious or systemic failures</li>
                </ul>
                <p class="methodology-note">Scores are algorithmically derived from extracted data and should be considered alongside the full decision context.</p>
            </div>
        </details>
    </section>

    <!-- SOURCE -->
    <section class="case-section case-source">
        <h2 class="section-title">Source</h2>
        <p>
            <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_case_reference_number={{ case.case_ref }}" class="pdf-link" target="_blank" rel="noopener">
                <svg class="icon-pdf" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                View on HPC Website
            </a>
        </p>
        <p class="source-meta">
            Source: Scottish Housing and Property Chamber<br>
            {% if case.extracted_at %}
            Data extracted: {{ case.extracted_at[:10] }}
            {% endif %}
        </p>
    </section>

    <!-- RELATED -->
    <section class="case-section case-related">
        <h2 class="section-title">Related</h2>
        <ul class="related-links">
            <li><a href="/factors/{{ case.factor_slug }}/">{{ case.factor_name }} full profile</a></li>
            <li><a href="/factors/{{ case.factor_slug }}/tribunal/">All tribunal cases for {{ case.factor_name }}</a></li>
            {% if case.property_postcode %}
            <li><a href="/areas/{{ case.property_postcode[:3] | lower }}/">Factors in {{ case.property_postcode[:3] }} area</a></li>
            {% endif %}
        </ul>
    </section>

</article>
{% endblock %}

{% block styles %}
<style>
/* Case Page Layout */
.case-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem 3rem;
}

/* Header */
.case-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    padding: 2rem 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2rem;
}

.case-ref {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
    background: var(--bg-muted);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.case-title {
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1.3;
    margin: 0 0 0.75rem;
}

.case-title a {
    color: var(--primary);
    text-decoration: none;
}

.case-title a:hover {
    text-decoration: underline;
}

.case-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
}

.meta-item svg {
    flex-shrink: 0;
}

/* SVG Icons */
.icon-location,
.icon-calendar,
.icon-pdf,
.icon-info {
    vertical-align: middle;
}

/* Info Tooltip */
.info-tooltip {
    display: inline-flex;
    align-items: center;
    margin-left: 0.25rem;
    color: var(--text-muted);
    text-decoration: none;
}

.info-tooltip:hover {
    color: var(--primary);
}

/* Outcome Badge */
.case-outcome-badge {
    flex-shrink: 0;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.outcome-upheld {
    background: #fef2f2;
    color: #b91c1c;
    border: 1px solid #fecaca;
}

.outcome-partially-upheld {
    background: #fffbeb;
    color: #b45309;
    border: 1px solid #fde68a;
}

.outcome-dismissed {
    background: #f0fdf4;
    color: #15803d;
    border: 1px solid #bbf7d0;
}

.outcome-withdrawn {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

/* Sections */
.case-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-light);
}

.case-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* At a Glance Grid */
.glance-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.glance-item {
    background: var(--bg-muted);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.glance-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.glance-value {
    font-size: 1.25rem;
    font-weight: 600;
}

.text-warning {
    color: #b45309;
}

/* Severity Badge */
.severity-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.severity-high {
    background: #fef2f2;
    color: #b91c1c;
}

.severity-medium {
    background: #fffbeb;
    color: #b45309;
}

.severity-low {
    background: #f0fdf4;
    color: #15803d;
}

/* Summary */
.case-summary {
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--text);
}

.ai-note {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-style: italic;
    margin-top: 0.75rem;
}

/* Category Tags */
.category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.category-tag {
    display: inline-block;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: #e0e7ff;
    color: #3730a3;
}

.tag-communication { background: #dbeafe; color: #1e40af; }
.tag-financial { background: #fef3c7; color: #92400e; }
.tag-maintenance { background: #fee2e2; color: #991b1b; }
.tag-code_breach { background: #ede9fe; color: #5b21b6; }
.tag-disclosure { background: #f3e8ff; color: #7c3aed; }
.tag-insurance { background: #ccfbf1; color: #0f766e; }
.tag-governance { background: #e0e7ff; color: #4338ca; }
.tag-health_safety { background: #fecaca; color: #b91c1c; }
.tag-debt_recovery { background: #fed7aa; color: #c2410c; }

/* Key Quote */
.key-quote {
    font-size: 1.1rem;
    line-height: 1.6;
    font-style: italic;
    color: var(--text);
    border-left: 4px solid var(--primary);
    padding: 1rem 1.5rem;
    margin: 0;
    background: var(--bg-muted);
    border-radius: 0 8px 8px 0;
}

/* Breach List */
.breach-list {
    margin: 0;
    padding-left: 1.5rem;
}

.breach-list li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.source-note {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 1rem;
}

/* Enforcement */
.enforcement-block {
    background: var(--bg-muted);
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.enforcement-block h3 {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0 0 0.75rem;
}

.compensation-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin: 0 0 0.5rem;
}

.evidence-quote {
    font-size: 0.9rem;
    font-style: italic;
    color: var(--text-muted);
    border-left: 3px solid var(--border);
    padding-left: 1rem;
    margin: 0.75rem 0 0;
}

/* Conduct */
.conduct-list {
    margin: 0;
}

.conduct-list dt {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.conduct-list dd {
    margin: 0 0 1rem;
}

/* Full Text Toggle */
.full-text-toggle {
    background: var(--bg-muted);
    border-radius: 8px;
    overflow: hidden;
}

.full-text-toggle summary {
    padding: 1rem 1.25rem;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.full-text-toggle summary:hover {
    background: var(--bg-hover);
}

.full-text-toggle[open] summary {
    border-bottom: 1px solid var(--border);
}

.full-text-toggle[open] .toggle-icon {
    transform: rotate(90deg);
}

.toggle-icon {
    transition: transform 0.2s;
    font-size: 0.75rem;
}

.word-count {
    color: var(--text-muted);
    font-weight: 400;
    font-size: 0.85rem;
}

.full-text-content {
    padding: 1.5rem;
    font-size: 0.9rem;
    line-height: 1.8;
    max-height: 600px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: var(--font-mono);
    background: #fff;
}

/* Source */
.pdf-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--primary);
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
}

.pdf-link svg {
    flex-shrink: 0;
}

.pdf-link:hover {
    background: var(--primary-dark);
}

/* Methodology */
.methodology-toggle {
    background: var(--bg-muted);
    border-radius: 8px;
    overflow: hidden;
}

.methodology-toggle summary {
    padding: 1rem 1.25rem;
    cursor: pointer;
    list-style: none;
}

.methodology-toggle summary::-webkit-details-marker {
    display: none;
}

.methodology-toggle summary:hover {
    background: var(--bg-hover);
}

.inline-title {
    display: inline;
    margin: 0;
}

.methodology-content {
    padding: 0 1.25rem 1.25rem;
    font-size: 0.9rem;
    line-height: 1.6;
}

.methodology-content p {
    margin-bottom: 0.75rem;
}

.methodology-content ul {
    margin: 0 0 1rem;
    padding-left: 1.5rem;
}

.methodology-content li {
    margin-bottom: 0.35rem;
}

.methodology-note {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
}

.source-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 1rem;
}

/* Related */
.related-links {
    margin: 0;
    padding: 0;
    list-style: none;
}

.related-links li {
    margin-bottom: 0.5rem;
}

.related-links a {
    color: var(--primary);
    text-decoration: none;
}

.related-links a:hover {
    text-decoration: underline;
}

/* Responsive */
@media (max-width: 700px) {
    .case-header {
        flex-direction: column;
    }
    
    .case-outcome-badge {
        align-self: flex-start;
    }
    
    .glance-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .case-title {
        font-size: 1.25rem;
    }
}

@media (max-width: 500px) {
    .glance-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .case-meta {
        flex-direction: column;
        gap: 0.25rem;
    }
}
</style>
{% endblock %}
