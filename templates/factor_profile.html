{#
Factor Profile Template v7.0 - Mobile Optimized
Inherits: header, footer, navigation, base styles from base.html

v7.0 Changes:
- Mobile content reordering: main content first, sidebar utilities at end
- Improved mobile spacing and typography
- Better data grid layout (3-2 on mobile instead of 2-2-1)

Required data context:
- profile: Row from v_factor_profiles view
- at_a_glance: Parsed JSON {bullets: [...], overall_sentiment: ..., summary: ...}
- wss_url: URL to the WSS PDF document (or None if not available)
- wss: Dict with extracted WSS fields (management_fee_amount, emergency_response, etc.) or None
- registry_url: URL to specific factor page on Property Factor Register
- coverage_areas_list: Pre-split list of coverage areas
- recent_reviews: List of reviews (with review_text, author_name, review_date, rating, platform for snippets)
- google_places: Dict with contact info (phone, address, place_id)
- google_locations: List of Google locations [{name, rating, review_count, place_id, address}]
- trustpilot: Dict with url
- tribunal_last_5_years: Dict stats (including rate_per_10k)
- tribunal_full_history: Dict stats (including first_case_year)
- cases_by_year: List for trend chart [{year, cases, pfeos}]
- recent_cases: List of cases (with summary, severity_score, key_quote/quote)
- complaint_categories: Dict

- generated_date: Date string
- current_year: Current year for footer copyright
#}

{% extends "base.html" %}

{# ==================== IMPORT PARTIALS ==================== #}
{% from "partials/_icons.html" import icon_check, icon_check_circle, icon_x, icon_alert_circle, icon_info, 
    icon_warning, icon_document, icon_file, icon_building, icon_thumbs_up, icon_star, icon_clock,
    icon_chevron_down, icon_chevron_right, icon_external_link, icon_globe, icon_phone, icon_mail, 
    icon_map_pin, icon_google, icon_trustpilot, icon_source_check, icon_risk_badge, icon_sentiment %}
{% from "partials/_risk_badge.html" import risk_badge, severity_badge, outcome_badge %}
{% from "partials/_case_card.html" import case_card, case_card_list, case_toggle_script %}
{% from "partials/_review_snippet.html" import review_snippet, review_source_link, review_location_row, 
    rating_explanation, review_snippets_section %}
{% from "partials/_at_a_glance.html" import at_a_glance_box, verdict_box %}
{% from "partials/_tooltip.html" import tooltip %}

{# ==================== PAGE VARIABLES ==================== #}
{% set band = profile.risk_band|default('CLEAN') %}
{% set band_lower = band|lower %}
{% set band_class = 'expired' if profile.status != 'registered' else band_lower %}
{% set is_switchable = profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}

{% block title %}{{ profile.name }} - Complaints & Ratings | Compare Factors{% endblock %}

{% block meta %}
{# SEO-optimized meta description with actual data #}
{% set case_count = tribunal_last_5_years.case_count|default(0) %}
{% set prop_count = profile.property_count|default(0) %}
<meta name="description" content="{% if profile.status != 'registered' %}Historical profile for {{ profile.name }} (registration expired). {% elif case_count > 0 and prop_count > 0 %}{{ profile.name }} manages {{ "{:,}".format(prop_count) }} properties. {{ case_count }} tribunal case{{ 's' if case_count != 1 else '' }}, {{ band }} rating.{% if profile.google_rating %} {{ "%.1f"|format(profile.google_rating) }}★ on Google.{% endif %} Compare Scottish factors.{% elif prop_count > 0 %}{{ profile.name }} manages {{ "{:,}".format(prop_count) }} properties in Scotland. {{ band }} tribunal rating.{% if profile.google_rating %} {{ "%.1f"|format(profile.google_rating) }}★ on Google.{% endif %} Independent comparison data.{% else %}{{ profile.name }}: {{ band }} tribunal rating.{% if profile.google_rating %} {{ "%.1f"|format(profile.google_rating) }}★ reviews.{% endif %} Independent Scottish property factor comparison.{% endif %}">
<link rel="canonical" href="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">

<!-- Open Graph / Social Sharing -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">
<meta property="og:title" content="{{ profile.name }} - Complaints & Ratings | Compare Factors">
<meta property="og:description" content="{% if profile.risk_band %}{{ profile.risk_band }} tribunal rating. {% endif %}{% if tribunal_last_5_years.case_count %}{{ tribunal_last_5_years.case_count }} cases. {% endif %}{% if profile.combined_rating %}{{ "%.1f"|format(profile.combined_rating) }}★ rating. {% endif %}Compare Scottish property factors.">
<meta property="og:image" content="https://comparefactors.co.uk/og-image.png">
<meta name="twitter:card" content="summary_large_image">

<!-- Structured Data -->
{% include "partials/_schema_factor.html" %}
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/factor-profile.css">
{% endblock %}

{% block content %}
<!-- ==================== BREADCRUMB ==================== -->
<div class="container">
    <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span>›</span>
        <a href="/factors/">Factors</a>
        <span>›</span>
        <span>{{ profile.name }}</span>
    </nav>
</div>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="container">
    <div class="profile-layout">

        <!-- ==================== ALERT BANNERS ==================== -->
        <div class="alert-banners-wrapper">{% include "partials/_alert_banners.html" %}</div>
        
        <!-- ==================== PROFILE HEADER ==================== -->
        <div class="profile-header">
            <div class="profile-header-top">
                <div class="profile-identity">
                    <h1>{{ profile.name }}</h1>
                    <div class="profile-meta">
                        <span class="profile-meta-item">
                            {{ icon_document(size=14) }}
                            {{ profile.registration_number }}
                        </span>
                        <span class="profile-meta-item">
                            {% if profile.status == 'registered' %}
                            {{ icon_check_circle(size=14, class="", stroke_width=2) }}
                            <span style="color: var(--green-600); font-weight: 500;">Active</span>
                            {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gray-500)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span style="color: var(--gray-500); font-weight: 500;">Expired</span>
                            {% endif %}
                        </span>
                        {% if profile.factor_type %}
                        <span class="profile-meta-item">
                            {{ icon_building(size=14) }}
                            {{ profile.factor_type }}
                        </span>
                        {% endif %}
                        {% if profile.property_count and profile.property_count > 0 %}
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                            {{ "{:,}".format(profile.property_count) }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Risk Badge (hidden on mobile) -->
                {{ risk_badge(profile) }}
            </div>

            <!-- Verdict Box -->
            {{ verdict_box(profile, at_a_glance, band, tribunal_stats=tribunal_last_5_years, complaint_categories=complaint_categories, wss=wss, sector_avg=sector_avg_rate|default(2.1), current_year=current_year, override_text=at_a_glance_override) }}
            
            <!-- At a Glance -->
            {{ at_a_glance_box(at_a_glance) }}
        </div>
        
        <!-- ==================== SIDEBAR (moves to bottom on mobile) ==================== -->
        <aside class="sidebar">
            <div class="sidebar-card">
                <!-- Quick Links -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Quick Links</h3>
                    <ul class="source-list">
                        <li class="source-item">
                            {{ icon_external_link(size=14, class="", stroke_width=2) }}
                            <a href="{{ registry_url|default('https://www.propertyfactorregister.gov.scot/property-factor/' ~ profile.registration_number) }}" target="_blank" rel="noopener">View on Official Register</a>
                        </li>
                        {% if profile.website %}
                        <li class="source-item">
                            {{ icon_globe(size=14) }}
                            <a href="{{ profile.website }}" target="_blank" rel="noopener">Official Website</a>
                        </li>
                        {% endif %}
                        <li class="source-item">
                            {{ icon_file(size=14) }}
                            <a href="/guides/how-to-switch-factors-scotland/">How to Switch Factors</a>
                        </li>
                    </ul>
                </div>
                
                <!-- Contact Info -->
                {% if google_places or profile.website or profile.address %}
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Contact</h3>
                    {% if profile.website %}
                    <div class="contact-item">
                        {{ icon_globe(size=14, class="contact-icon") }}
                        <span class="contact-value"><a href="{{ profile.website }}" target="_blank" rel="noopener">{{ profile.website|replace('https://', '')|replace('http://', '')|replace('www.', '')|truncate(30) }}</a></span>
                    </div>
                    {% endif %}
                    {% if google_places and google_places.phone %}
                    <div class="contact-item">
                        {{ icon_phone(size=14, class="contact-icon") }}
                        <span class="contact-value">{{ google_places.phone }}</span>
                    </div>
                    {% endif %}
                    {% if (google_places and google_places.address) or profile.address %}
                    <div class="contact-item">
                        {{ icon_map_pin(size=14, class="contact-icon") }}
                        <span class="contact-value">{{ google_places.address if (google_places and google_places.address) else profile.address }}</span>
                    </div>
                    {% endif %}
                    {% if not google_places and not profile.website and not profile.address %}
                    <p class="no-contact">No contact information available.</p>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Data Sources -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Data Sources</h3>
                    <ul class="source-list">
                        {% if wss_url %}
                        <li class="source-item">
                            {{ icon_document(size=14) }}
                            <a href="{{ wss_url }}" target="_blank" rel="noopener">Written Statement of Services</a>
                        </li>
                        {% endif %}
                        {% if profile.ch_number %}
                        <li class="source-item">
                            {{ icon_building(size=14) }}
                            <a href="https://find-and-update.company-information.service.gov.uk/company/{{ profile.ch_number }}" target="_blank" rel="noopener">Companies House</a>
                        </li>
                        {% endif %}
                        {% if trustpilot and trustpilot.url %}
                        <li class="source-item">
                            {{ icon_trustpilot(size=14) }}
                            <a href="{{ trustpilot.url }}" target="_blank" rel="noopener">Trustpilot</a>
                        </li>
                        {% endif %}
                        {% if google_places and google_places.place_id %}
                        <li class="source-item">
                            {{ icon_google(size=14) }}
                            <a href="https://search.google.com/local/reviews?placeid={{ google_places.place_id }}" target="_blank" rel="noopener">Google Reviews</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </aside>

        <!-- ==================== MAIN CONTENT ==================== -->
        <main class="main-content">

        <!-- ==================== SECTION NAVIGATION ==================== -->
        <nav class="section-nav" aria-label="Page sections">
            <span class="section-nav-label">Jump to:</span>
            <div class="section-nav-links">
                {% if profile.google_rating or profile.trustpilot_rating %}
                <a href="#reviews" class="section-nav-item">Reviews</a>
                {% endif %}
                <a href="#wss" class="section-nav-item">Services</a>
                <a href="#tribunal" class="section-nav-item">Tribunal</a>
                {% if recent_cases %}
                <a href="#decisions" class="section-nav-item">Decisions</a>
                {% endif %}
                {% if profile.ch_number %}
                <a href="#company" class="section-nav-item">Company</a>
                {% endif %}
            </div>
        </nav>

        <!-- ==================== REVIEWS CARD ==================== -->
        {% if profile.google_rating or profile.trustpilot_rating %}
        <div class="card" id="reviews">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_star(size=18) }}
                    Ratings & Reviews
                </h2>
            </div>
            <div class="card-body">
                {% set total_reviews = (profile.google_review_count|default(0)) + (profile.trustpilot_review_count|default(0)) %}
                
                <!-- Combined Rating Explanation -->
                {{ rating_explanation(profile.combined_rating, profile.google_review_count, profile.trustpilot_review_count) }}
                
                <!-- Review Snippets -->
                {% if recent_reviews %}
                {{ review_snippets_section(recent_reviews, max_reviews=3) }}
                {% endif %}
                
                <!-- Review Sources -->
                <div class="review-sources">
                    {% if google_locations and google_locations|length > 1 %}
                    <!-- Multiple Google locations with expandable list -->
                    <div style="background: var(--slate-50); border-radius: var(--radius-md); overflow: hidden;">
                        <div style="padding: var(--space-sm) var(--space-md); background: #E8F0FE; display: flex; align-items: center; gap: var(--space-sm);">
                            <span class="platform-icon platform-icon--google" style="width: 24px; height: 24px;">
                                {{ icon_google(size=14) }}
                            </span>
                            <span class="review-locations-summary">{{ google_locations|length }} Google Locations</span>
                        </div>
                        <div class="review-locations-list">
                            {% for loc in google_locations[:2] %}
                            {{ review_location_row(loc) }}
                            {% endfor %}
                            {% if google_locations|length > 2 %}
                            <div class="hidden-locations" style="display: none;">
                                {% for loc in google_locations[2:] %}
                                {{ review_location_row(loc) }}
                                {% endfor %}
                            </div>
                            <button type="button" class="toggle-locations-btn" onclick="toggleLocations(this)" style="width: 100%; padding: var(--space-sm) var(--space-md); background: var(--slate-100); border: none; border-top: 1px solid var(--slate-200); cursor: pointer; font-size: var(--text-sm); color: var(--navy-700); display: flex; align-items: center; justify-content: center; gap: var(--space-xs);">
                                {{ icon_chevron_down(size=14) }}
                                <span>Show {{ google_locations|length - 2 }} more location{{ 's' if google_locations|length - 2 > 1 else '' }}</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% elif profile.google_review_count and profile.google_review_count > 0 %}
                    <!-- Single Google location -->
                    {{ review_source_link(
                        platform='google',
                        rating=profile.google_rating,
                        count=profile.google_review_count,
                        url=("https://search.google.com/local/reviews?placeid=" ~ google_places.place_id) if google_places and google_places.place_id else ("https://www.google.com/search?q=" ~ (profile.name|urlencode) ~ "+property+factor+reviews"),
                        name='Google Reviews'
                    ) }}
                    {% endif %}
                    
                    {% if profile.trustpilot_review_count and profile.trustpilot_review_count > 0 %}
                    {{ review_source_link(
                        platform='trustpilot',
                        rating=profile.trustpilot_rating,
                        count=profile.trustpilot_review_count,
                        url=trustpilot.url if trustpilot and trustpilot.url else ("https://uk.trustpilot.com/search?query=" ~ (profile.name|urlencode)),
                        name='Trustpilot'
                    ) }}
                    {% endif %}
                </div>
            </div>
            <div class="card-footer">
                Reviews are collected from public listings and may not represent all customer experiences.
            </div>
        </div>
        {% endif %}

        <!-- ==================== WRITTEN STATEMENT OF SERVICES ==================== -->
        <div class="card" id="wss">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_document(size=18) }}
                    Written Statement of Services
                </h2>
                {% if wss_url %}
                <div class="card-header-links">
                    <a href="{{ wss_url }}" class="card-link" target="_blank" rel="noopener">View PDF →</a>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if wss and wss.confidence_score %}
                {# We have extracted WSS data - show as description list #}
                <dl class="wss-list">
                    {# Response Times #}
                    {% if wss.emergency_response %}
                    <div class="wss-item wss-item--emergency">
                        <dt>Emergency Response</dt>
                        <dd>{{ wss.emergency_response }}</dd>
                    </div>
                    {% endif %}
                    {% if wss.urgent_response %}
                    <div class="wss-item wss-item--urgent">
                        <dt>Urgent Response</dt>
                        <dd>{{ wss.urgent_response }}</dd>
                    </div>
                    {% endif %}
                    {% if wss.routine_response %}
                    <div class="wss-item">
                        <dt>Routine Response</dt>
                        <dd>{{ wss.routine_response }}</dd>
                    </div>
                    {% endif %}

                    {# Communication #}
                    {% if wss.enquiry_response %}
                    <div class="wss-item">
                        <dt>Enquiry Response</dt>
                        <dd>{{ wss.enquiry_response }}</dd>
                    </div>
                    {% endif %}
                    {% if wss.complaint_response %}
                    <div class="wss-item">
                        <dt>Complaint Response</dt>
                        <dd>{{ wss.complaint_response }}</dd>
                    </div>
                    {% endif %}

                    {# Service Terms #}
                    {% if wss.billing_frequency %}
                    <div class="wss-item">
                        <dt>Billing Frequency</dt>
                        <dd>{{ wss.billing_frequency }}</dd>
                    </div>
                    {% endif %}
                    {% if wss.notice_period %}
                    <div class="wss-item">
                        <dt>Notice Period</dt>
                        <dd>{{ wss.notice_period }}</dd>
                    </div>
                    {% endif %}
                    {% if wss.delegated_authority_limit %}
                    <div class="wss-item">
                        <dt>Delegated Authority</dt>
                        <dd>{{ wss.delegated_authority_limit }}</dd>
                    </div>
                    {% endif %}
                </dl>

                {# Digital & Compliance badges #}
                {% if wss.portal or wss.app or wss.code_of_conduct_version or wss.professional_memberships %}
                <div style="margin-top: var(--space-md); display: flex; flex-wrap: wrap; gap: var(--space-xs); align-items: center;">
                    {% if wss.portal %}
                    <span class="wss-badge wss-badge--feature">{{ icon_check(size=12) }} Online Portal</span>
                    {% endif %}
                    {% if wss.app %}
                    <span class="wss-badge wss-badge--feature">{{ icon_check(size=12) }} Mobile App</span>
                    {% endif %}
                    {% if wss.code_of_conduct_version %}
                    <span class="wss-badge">Code of Conduct {{ wss.code_of_conduct_version }}</span>
                    {% endif %}
                    {% if wss.professional_memberships %}
                    <span class="wss-badge">{{ wss.professional_memberships }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {# Download link #}
                <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--slate-50); border-radius: var(--radius-md); border-left: 3px solid var(--navy-600);">
                    <a href="{{ wss_url }}" target="_blank" rel="noopener" style="display: inline-flex; align-items: center; gap: var(--space-xs); color: var(--navy-700); font-weight: 500; text-decoration: none;">
                        {{ icon_file(size=16) }}
                        Download Full Written Statement
                        {{ icon_external_link(size=14) }}
                    </a>
                </div>

                {% elif wss_url %}
                {# We have a URL but no extracted data #}
                <p style="margin-bottom: var(--space-md);">
                    Every registered property factor must provide a Written Statement of Services (WSS) outlining their scope, responsibilities, fee structure, and complaints procedure.
                </p>
                <div style="padding: var(--space-md); background: var(--slate-50); border-radius: var(--radius-md); border-left: 3px solid var(--navy-600);">
                    <a href="{{ wss_url }}" target="_blank" rel="noopener" style="display: inline-flex; align-items: center; gap: var(--space-xs); color: var(--navy-700); font-weight: 500; text-decoration: none;">
                        {{ icon_file(size=16) }}
                        Download {{ profile.name }}'s Written Statement
                        {{ icon_external_link(size=14) }}
                    </a>
                </div>
                {% else %}
                {# No WSS on file #}
                <div style="text-align: center; padding: var(--space-lg) 0;">
                    {{ icon_document(size=48, class="", stroke_width=1) }}
                    <p style="margin-top: var(--space-md); color: var(--slate-600);">
                        We don't have {{ profile.name }}'s Written Statement of Services on file.
                    </p>
                    <p style="margin-top: var(--space-sm); font-size: var(--text-sm); color: var(--slate-500);">
                        Are you {{ profile.name }} or a homeowner with a copy? <a href="mailto:hello@comparefactors.co.uk?subject=WSS for {{ profile.name }} ({{ profile.registration_number }})&body=Hi,%0D%0A%0D%0AI'd like to share the Written Statement of Services for {{ profile.name }}.%0D%0A%0D%0A[Please attach the WSS document or provide a link]" style="color: var(--navy-600); font-weight: 500;">Send it our way</a> and we'll add it to this profile.
                    </p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                The WSS is a legal requirement under the Property Factors (Scotland) Act 2011.{% if wss and wss.confidence_score %} Data extracted from official document.{% endif %}
            </div>
        </div>

        <!-- ==================== TRIBUNAL RECORD CARD ==================== -->
        <div class="card" id="tribunal">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_document(size=18) }}
                    Tribunal Record
                </h2>
                <div class="card-header-links">
                    {% if tribunal_last_5_years.case_count > 0 %}
                    <a href="/factors/{{ profile.registration_number|lower }}/tribunal/" class="card-link">View cases →</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if tribunal_last_5_years.case_count == 0 %}
                <div class="empty-state">
                    {{ icon_check_circle(size=48, class="", stroke_width=1.5) }}
                    <p style="margin-top: var(--space-md);">No tribunal cases in the last 5 years.</p>
                </div>
                {% else %}
                <div style="margin-bottom: var(--space-lg);">
                    <div style="font-size: var(--text-xs); font-weight: 600; color: var(--navy-800); margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 0.05em;">Last 5 Years</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-value">{{ tribunal_last_5_years.case_count|default(0) }}</div>
                            <div class="data-label">Cases</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value {% if tribunal_last_5_years.complaints_upheld_pct and tribunal_last_5_years.complaints_upheld_pct > 50 %}red{% endif %}">
                                {% if tribunal_last_5_years.complaints_upheld_pct %}{{ tribunal_last_5_years.complaints_upheld_pct|int }}%{% else %}—{% endif %}
                            </div>
                            <div class="data-label">Upheld</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">{{ "%.1f"|format(tribunal_last_5_years.rate_per_10k) if tribunal_last_5_years.rate_per_10k else '—' }}</div>
                            <div class="data-label">Rate/10k</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value {% if tribunal_last_5_years.pfeo_count and tribunal_last_5_years.pfeo_count > 0 %}red{% endif %}">{{ tribunal_last_5_years.pfeo_count|default(0) }}</div>
                            <div class="data-label">PFEOs</div>
                            <div class="data-benchmark">Enforcement</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value {% if tribunal_last_5_years.compensation and tribunal_last_5_years.compensation > 1000 %}red{% endif %}">£{{ "{:,.0f}".format(tribunal_last_5_years.compensation|default(0)) }}</div>
                            <div class="data-label">Paid</div>
                            <div class="data-benchmark">Compensation</div>
                        </div>
                        {% if complaint_categories and complaint_categories|length > 0 %}
                        <div class="data-item">
                            <div class="data-value" style="font-size: var(--text-sm);">{{ complaint_categories[0].name|replace('_', ' ')|title }}</div>
                            <div class="data-label">Top Issue</div>
                            <div class="data-benchmark">{{ complaint_categories[0].count }} case{{ 's' if complaint_categories[0].count != 1 else '' }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# All Complaint Categories #}
                {% if complaint_categories and complaint_categories|length > 1 %}
                <div style="margin-bottom: var(--space-md);">
                    <div style="font-size: var(--text-xs); font-weight: 600; color: var(--navy-800); margin-bottom: var(--space-sm); text-transform: uppercase; letter-spacing: 0.05em;">All Complaint Types</div>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        {% for cat in complaint_categories %}
                        <span class="complaint-tag tag-{{ cat.name }}">
                            {{ cat.name|replace('_', ' ')|title }} <span style="opacity: 0.7;">({{ cat.count }})</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% endif %}
            </div>
            <div class="card-footer">
                Case summaries from official HPC decisions. <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_property_factor_registrati={{ profile.registration_number }}" target="_blank" rel="noopener">Verify with official records ↗</a>
            </div>
        </div>
        
        <!-- ==================== RECENT DECISIONS ==================== -->
        {% if recent_cases %}
        <div class="card" id="decisions">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_clock(size=18) }}
                    Recent Decisions
                </h2>
                <div class="card-header-links">
                    <a href="/factors/{{ profile.registration_number|lower }}/tribunal/" class="card-link">Full history →</a>
                </div>
            </div>
            <div class="card-body">
                {{ case_card_list(recent_cases, max_visible=3) }}
            </div>
        </div>
        {% endif %}
        
        
        <!-- ==================== COMPANIES HOUSE CARD ==================== -->
        {% if profile.ch_number %}
        <div class="card" id="company">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_building(size=18) }}
                    Company Info
                </h2>
                <a href="https://find-and-update.company-information.service.gov.uk/company/{{ profile.ch_number }}" class="card-link" target="_blank" rel="noopener">Companies House →</a>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div>
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value {% if profile.ch_status == 'active' %}green{% elif profile.ch_status %}red{% endif %}">
                                {{ profile.ch_status|capitalize if profile.ch_status else '—' }}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Incorporated</span>
                            <span class="info-value">{{ profile.ch_incorporated or '—' }}</span>
                        </div>
                        <div class="info-row" style="border-bottom: none;">
                            <span class="info-label">Company No.</span>
                            <span class="info-value">{{ profile.ch_number }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="info-row">
                            <span class="info-label">Accounts</span>
                            <span class="info-value {% if profile.ch_accounts_overdue %}red{% else %}green{% endif %}">
                                {% if profile.ch_accounts_overdue %}Overdue{% else %}Up to date{% endif %}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Directors</span>
                            <span class="info-value">{{ profile.ch_directors or '—' }}</span>
                        </div>
                        <div class="info-row" style="border-bottom: none;">
                            <span class="info-label">Avg. Tenure</span>
                            <span class="info-value">{% if profile.ch_avg_tenure %}{{ "%.1f"|format(profile.ch_avg_tenure) }} yrs{% else %}—{% endif %}</span>
                        </div>
                    </div>
                </div>
                
                {% if profile.ch_insolvency or profile.ch_charges %}
                <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--slate-200); display: flex; gap: var(--space-lg); flex-wrap: wrap;">
                    {% if profile.ch_insolvency %}
                    <div style="display: flex; align-items: center; gap: var(--space-xs); color: var(--red-600); font-size: var(--text-sm);">
                        {{ icon_warning(size=14) }}
                        <span>Insolvency history</span>
                    </div>
                    {% endif %}
                    {% if profile.ch_charges %}
                    <div style="display: flex; align-items: center; gap: var(--space-xs); color: var(--amber-600); font-size: var(--text-sm);">
                        {{ icon_alert_circle(size=14) }}
                        <span>Outstanding charges</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- ==================== FAQ SECTION ==================== -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    {{ icon_info(size=18) }}
                    FAQ
                </h2>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="faq-list">
                    <details class="faq-item">
                        <summary>Has {{ profile.name }} had any tribunal cases?</summary>
                        <div class="faq-answer">
                            {% if tribunal_last_5_years.case_count > 0 %}
                            Yes, {{ profile.name }} has had {{ tribunal_last_5_years.case_count }} tribunal case{{ 's' if tribunal_last_5_years.case_count != 1 else '' }} in the last 5 years, with {{ tribunal_last_5_years.complaints_upheld_pct|int if tribunal_last_5_years.complaints_upheld_pct else 0 }}% of complaints upheld.
                            {% else %}
                            No, {{ profile.name }} has had no tribunal cases in the last 5 years according to our records.
                            {% endif %}
                        </div>
                    </details>
                    
                    <details class="faq-item">
                        <summary>How do I make a complaint about {{ profile.name }}?</summary>
                        <div class="faq-answer">
                            First, raise your complaint directly with {{ profile.name }} using their formal complaints procedure (required by law to be in their Written Statement of Services). If unresolved after 8 weeks, you can apply to the Housing & Property Chamber. Visit <a href="https://housingandpropertychamber.scot" target="_blank" rel="noopener">housingandpropertychamber.scot</a> to start an application.
                        </div>
                    </details>
                    
                    {% if is_switchable %}
                    <details class="faq-item">
                        <summary>How do I switch away from {{ profile.name }}?</summary>
                        <div class="faq-answer">
                            To change property factors, you'll need a majority vote from property owners in your development (typically at an AGM or EGM). The new factor must be registered with the Scottish Property Factor Register. Our <a href="/guides/switching-factors/">switching guide</a> explains the full process step-by-step.
                        </div>
                    </details>
                    {% endif %}
                </div>
            </div>
        </div>
        
        </main>
        
    </div><!-- /.profile-layout -->
</div><!-- /.container -->

<!-- Page-specific footer disclaimer -->
<div class="footer-disclaimer">
    Some summaries and statistics on this page are AI-generated from official sources. Always verify important information with <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions?field_property_factor_registrati={{ profile.registration_number }}" target="_blank" rel="noopener">official HPC records</a>.
</div>
{% endblock %}

{% block scripts %}
{{ case_toggle_script() }}
<script>
function toggleLocations(btn) {
    const container = btn.closest('.review-locations-list');
    const hiddenLocations = container.querySelector('.hidden-locations');
    const isHidden = hiddenLocations.style.display === 'none';
    
    hiddenLocations.style.display = isHidden ? 'block' : 'none';
    btn.querySelector('span').textContent = isHidden ? 'Show fewer locations' : 'Show {{ google_locations|length - 2 }} more location{{ "s" if google_locations|length - 2 > 1 else "" }}';
    btn.querySelector('svg').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
}
</script>
{% endblock %}