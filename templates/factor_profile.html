{#
Factor Profile Template v5.19 - Refactored to extend base.html
Inherits: header, footer, navigation, base styles from base.html

v5.19 Changes:
- Refactored to use Jinja2 template inheritance with base.html
- Removed duplicate header/footer/nav (now inherited from base.html)
- Removed duplicate CSS variables and base styles
- Page-specific styles moved to {% block styles %}
- Main content wrapped in {% block content %}
- Page-specific scripts moved to {% block scripts %}

Previous versions: see git history for v5.18.x changes

Required data context:
- profile: Row from v_factor_profiles view
- at_a_glance: Parsed JSON {bullets: [...], overall_sentiment: ..., summary: ...}
- wss: Row from wss table
- recent_reviews: List of reviews (with review_text for snippets)
- google_places: Dict with contact info (phone, address, place_id)
- google_locations: List of Google locations [{name, rating, review_count, place_id, address}]
- trustpilot: Dict with url
- fee_examples: List of fee examples
- fee_summary: Dict with aggregated stats
- case_fees: List of extracted fees from tribunal
- tribunal_last_5_years: Dict stats
- tribunal_full_history: Dict stats
- cases_by_year: List for trend chart
- recent_cases: List of cases
- complaint_categories: Dict
- similar_factors: List
- generated_date: Date string
- current_year: Current year for footer copyright
#}

{% extends "base.html" %}

{% block title %}{{ profile.name }} | Compare Factors Scotland{% endblock %}

{% block meta %}
    <meta name="description" content="{% if profile.status != 'registered' %}Historical profile for {{ profile.name }} (registration expired). {% else %}Independent profile for {{ profile.name }}. Tribunal rating: {{ profile.risk_band|default('CLEAN') }}. {% endif %}Reviews, fees, and registration status. Compare Scottish property factors.">
    <link rel="canonical" href="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/">
    <meta property="og:title" content="{{ profile.name }} - Property Factor Profile | Compare Factors">
    <meta property="og:description" content="{% if profile.risk_band %}{{ profile.risk_band }} tribunal rating. {% endif %}{% if profile.combined_rating %}{{ "%.1f"|format(profile.combined_rating) }}★ average review rating. {% endif %}Independent comparison data for Scottish property factors.">
    <meta property="og:image" content="https://comparefactors.co.uk/images/og-factor-profile.png">
    <meta name="twitter:card" content="summary_large_image">

    <!-- ==================== DYNAMIC SEO SCHEMA ==================== -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "RealEstateAgent",
          "@id": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/#organization",
          "name": "{{ profile.name }}",
          {% if profile.registration_number %}
          "image": "https://comparefactors.co.uk/images/factors/{{ profile.registration_number|lower }}.jpg",
          {% endif %}
          "description": "Property factor profile for {{ profile.name }} ({{ profile.registration_number }}). Risk rating: {{ profile.risk_band }}. Managed properties: {{ profile.property_count }}. Services include block management, insurance administration, and repairs.",
          "url": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/",
          {% if google_places and google_places.phone %}
          "telephone": "{{ google_places.phone }}",
          {% endif %}
          {% if google_places and google_places.address %}
          "address": {
            "@type": "PostalAddress",
            "streetAddress": "{{ google_places.address.split(',')[0] if ',' in google_places.address else google_places.address }}",
            "addressLocality": "{{ google_places.address.split(',')[-2].strip() if google_places.address.split(',')|length > 2 else 'Scotland' }}",
            "postalCode": "{{ google_places.address.split(',')[-1].strip() if ',' in google_places.address else '' }}",
            "addressCountry": "GB"
          },
          {% endif %}
          
          {% if profile.coverage_areas %}
          "areaServed": [
            {% for area in profile.coverage_areas.split(',')[:15] %}
            {% set clean_area = area.strip().replace('"', '').replace('&#34;', '') %}
            {"@type": "City", "name": "{{ clean_area }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          {% endif %}

          "memberOf": [
            {% if profile.tpi_member %}
            {
              "@type": "Organization",
              "name": "The Property Institute of Scotland",
              "url": "https://tpi.org.uk"
            }
            {% endif %}
          ],

          "hasOfferCatalog": {
            "@type": "OfferCatalog",
            "name": "Property Factoring Services",
            "itemListElement": [
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Block Management" } },
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Building Insurance Administration" } },
              { "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Emergency Repairs" } }
            ]
          },

          "priceRange": "££",

          {% set total_reviews = (profile.google_review_count|default(0)) + (profile.trustpilot_review_count|default(0)) %}
          {% if profile.combined_rating and total_reviews > 0 %}
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ "%.1f"|format(profile.combined_rating) }}",
            "reviewCount": "{{ total_reviews }}",
            "bestRating": "5",
            "worstRating": "1"
          },
          {% endif %}

          "knowsAbout": "Property Factoring Act (Scotland) 2011"
        },
        
        {
          "@type": "BreadcrumbList",
          "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://comparefactors.co.uk/" },
            { "@type": "ListItem", "position": 2, "name": "Factors", "item": "https://comparefactors.co.uk/factors/" },
            { "@type": "ListItem", "position": 3, "name": "{{ profile.name }}", "item": "https://comparefactors.co.uk/factors/{{ profile.registration_number|lower }}/" }
          ]
        },

        {
          "@type": "FAQPage",
          "mainEntity": [
            {
              "@type": "Question",
              "name": "Has {{ profile.name }} had any tribunal cases?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "{% if tribunal_full_history.case_count > 0 %}Yes, {{ profile.name }} has had {{ tribunal_full_history.case_count }} tribunal cases on record{% if tribunal_full_history.first_case_year %} since {{ tribunal_full_history.first_case_year }}{% endif %}. {% if tribunal_last_5_years.case_count > 0 %}In the last 5 years, they've had {{ tribunal_last_5_years.case_count }} cases with {{ tribunal_last_5_years.complaints_upheld_pct|default(0)|int }}% of complaints upheld.{% endif %}{% else %}No, {{ profile.name }} has no tribunal cases on record with the Housing & Property Chamber.{% endif %}"
              }
            },
            {
                "@type": "Question",
                "name": "How much does {{ profile.name }} charge?",
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": "{% if wss.management_fee_amount %}According to their Written Statement of Services, the standard management fee is £{{ wss.management_fee_amount }} {% if wss.management_fee_frequency %}({{ wss.management_fee_frequency }}){% endif %}. Fees vary by development.{% else %}Fee information for {{ profile.name }} is not currently publicly available in our database. Factors typically charge between £120 and £350 per year.{% endif %}"
                }
            },
            {
              "@type": "Question",
              "name": "How do I make a complaint about {{ profile.name }}?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "First, raise your complaint directly with {{ profile.name }} using their formal complaints procedure (required by law to be in their Written Statement of Services). If unresolved after 8 weeks, you can apply to the Housing & Property Chamber. Visit housingandpropertychamber.scot to start an application."
              }
            }
            {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
            ,{
                "@type": "Question",
                "name": "How do I switch away from {{ profile.name }}?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "To change property factors, you'll need a majority vote from property owners in your development (typically at an AGM or EGM). The new factor must be registered with the Scottish Property Factor Register. Our switching guide explains the full process step-by-step."
                }
            }
            {% endif %}
          ]
        }
      ]
    }
    </script>
{% endblock %}

{% block styles %}
<style>
    /* ==================== PAGE-SPECIFIC CSS VARIABLES ==================== */
    :root {
        /* Additional status colors not in base */
        --indigo-600: #4f46e5;
        --indigo-100: #e0e7ff;
        --indigo-50: #eef2ff;
        
        /* Grey for expired/inactive */
        --gray-600: #4b5563;
        --gray-500: #6b7280;
        --gray-100: #f3f4f6;
        
        /* Amber additions */
        --amber-50: #fffbeb;
        --amber-200: #fde68a;
        --amber-800: #92400e;
        
        /* Text sizes */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        /* Borders */
        --radius-sm: 8px;
        --radius-md: 10px;
        --radius-lg: 16px;
    }
    
    /* ==================== LAYOUT ==================== */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    
    .profile-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: var(--space-xl);
        align-items: start;
        padding: var(--space-xl) 0;
    }
    
    @media (max-width: 968px) {
        .profile-layout {
            grid-template-columns: 1fr;
        }
        .sidebar { order: 2; }
        .main-content { order: 1; }
    }
    
    /* ==================== BREADCRUMB OVERRIDE ==================== */
    .breadcrumb {
        padding: var(--space-md) 0;
        font-size: var(--text-sm);
        color: var(--slate-600);
    }
    .breadcrumb a { color: var(--slate-600); }
    .breadcrumb a:hover { color: var(--navy-900); }
    .breadcrumb span { margin: 0 var(--space-sm); }
    
    /* ==================== ALERT BANNERS ==================== */
    .alert-banner {
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        font-size: var(--text-sm);
        line-height: 1.5;
    }
    
    .alert-banner svg {
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .alert-banner-content {
        flex: 1;
    }
    
    .alert-banner-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .alert-banner--expired {
        background: var(--gray-100);
        border: 1px solid var(--slate-300);
        color: var(--gray-600);
    }
    
    .alert-banner--info {
        background: var(--blue-100);
        border: 1px solid #93c5fd;
        color: var(--blue-700);
    }
    
    /* ==================== PROFILE HEADER ==================== */
    .profile-header {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--space-xl) 28px;
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--slate-200);
    }
    
    .profile-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
    }
    
    .profile-identity h1 {
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--navy-950);
        margin-bottom: var(--space-xs);
    }
    
    .profile-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
        color: var(--slate-600);
    }
    
    .profile-meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }
    
    /* Risk Badge - Page-specific override */
    .risk-badge {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-sm);
        font-weight: 600;
        text-align: center;
        min-width: 100px;
    }
    
    .risk-badge-main {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    
    .risk-badge-reason {
        font-size: var(--text-xs);
        font-weight: 500;
        opacity: 0.85;
        margin-top: 2px;
        text-transform: none;
        letter-spacing: 0;
    }
    
    .risk-badge.clean, .risk-badge--clean { background: var(--emerald-100); color: var(--emerald-700); }
    .risk-badge.green, .risk-badge--green { background: var(--green-100); color: var(--green-700); }
    .risk-badge.amber, .risk-badge--amber { background: var(--amber-100); color: var(--amber-600); }
    .risk-badge.orange, .risk-badge--orange { background: var(--orange-100); color: var(--orange-600); }
    .risk-badge.red, .risk-badge--red { background: var(--red-100); color: var(--red-700); }
    .risk-badge.expired, .risk-badge--expired { background: var(--gray-100); color: var(--gray-500); }
    
    /* ==================== VERDICT BOX ==================== */
    .verdict-box {
        background: var(--slate-50);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
        position: relative;
    }

    .verdict-box::before {
        content: '';
        position: absolute;
        left: 0;
        top: 20px;
        bottom: 20px;
        width: 4px;
        background: var(--navy-700);
        border-radius: 0 4px 4px 0;
    }
    
    .verdict-box.red::before { background: var(--red-600); }
    .verdict-box.orange::before { background: var(--orange-600); }
    .verdict-box.amber::before { background: var(--amber-600); }
    .verdict-box.green::before { background: var(--green-600); }
    .verdict-box.clean::before { background: var(--emerald-600); }
    
    .verdict-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-family: var(--font-display);
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--navy-900);
        margin-bottom: var(--space-sm);
    }
    
    .verdict-text {
        font-size: 0.95rem;
        color: var(--slate-600);
        margin: 0;
        line-height: 1.6;
    }
    
    .verdict-highlight {
        font-weight: 600;
        color: var(--navy-800);
    }
    
    /* ==================== TOOLTIPS ==================== */
    .tooltip-trigger {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: var(--slate-200);
        color: var(--slate-600);
        border-radius: 50%;
        font-size: 10px;
        font-weight: 600;
        cursor: help;
        position: relative;
        border: none;
        padding: 0;
        vertical-align: middle;
        margin-left: 4px;
    }
    
    .tooltip-content {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--navy-900);
        color: white;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 400;
        line-height: 1.4;
        white-space: normal;
        width: 220px;
        text-align: left;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s, visibility 0.15s;
        z-index: 100;
        pointer-events: none;
    }
    
    .tooltip-content::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: var(--navy-900);
    }
    
    .tooltip-trigger:hover .tooltip-content,
    .tooltip-trigger:focus .tooltip-content {
        opacity: 1;
        visibility: visible;
    }
    
    /* ==================== AT A GLANCE ==================== */
    .at-a-glance {
        background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
    }
    
    .at-a-glance-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-md);
    }
    
    .at-a-glance-title {
        font-family: var(--font-display);
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--navy-900);
    }
    
    .at-a-glance-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: var(--text-xs);
        color: var(--slate-600);
        background: var(--white);
        padding: 2px 8px;
        border-radius: 100px;
        border: 1px solid var(--slate-200);
    }
    
    .at-a-glance-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .at-a-glance-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-sm) 0;
        font-size: var(--text-sm);
        color: var(--slate-700);
        border-bottom: 1px solid var(--slate-200);
    }
    
    .at-a-glance-item:last-child {
        border-bottom: none;
    }
    
    .at-a-glance-icon {
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .at-a-glance-icon.positive { color: var(--green-600); }
    .at-a-glance-icon.neutral { color: var(--slate-400); }
    .at-a-glance-icon.negative { color: var(--red-600); }
    
    /* ==================== CARDS ==================== */
    .card {
        background: var(--white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--slate-200);
        margin-bottom: var(--space-lg);
        overflow: hidden;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--slate-100);
        background: var(--slate-50);
    }
    
    .card-header-links {
        display: flex;
        gap: var(--space-md);
        align-items: center;
    }
    
    .card-title {
        font-family: var(--font-display);
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--navy-900);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    
    .card-link {
        font-size: var(--text-sm);
        color: var(--blue-600);
    }
    
    .card-body {
        padding: var(--space-lg);
    }
    
    .card-footer {
        padding: var(--space-md) var(--space-lg);
        background: var(--slate-50);
        border-top: 1px solid var(--slate-100);
        font-size: var(--text-xs);
        color: var(--slate-600);
    }
    
    /* ==================== DATA GRID ==================== */
    .data-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
    }
    
    @media (max-width: 640px) {
        .data-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .data-item {
        text-align: center;
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
    }
    
    .data-value {
        font-family: var(--font-display);
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--navy-900);
    }
    
    .data-value.green { color: var(--green-600); }
    .data-value.amber { color: var(--amber-600); }
    .data-value.red { color: var(--red-600); }
    
    .data-label {
        font-size: var(--text-xs);
        color: var(--slate-600);
        margin-top: var(--space-xs);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    
    /* ==================== CASE LIST ==================== */
    .case-card {
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-bottom: var(--space-sm);
        background: var(--white);
    }
    
    .case-card.hidden {
        display: none;
    }
    
    .case-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-sm);
    }
    
    .case-ref {
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--navy-800);
    }
    
    .case-date {
        font-size: var(--text-xs);
        color: var(--slate-600);
    }
    
    .case-outcome {
        display: inline-block;
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
    }
    
    .case-outcome.upheld { background: var(--red-100); color: var(--red-700); }
    .case-outcome.dismissed { background: var(--green-100); color: var(--green-700); }
    .case-outcome.partial { background: var(--amber-100); color: var(--amber-600); }
    .case-outcome.withdrawn { background: var(--slate-100); color: var(--slate-600); }
    .case-outcome.settled { background: var(--blue-100); color: var(--blue-700); }
    .case-outcome.neutral { background: var(--slate-100); color: var(--slate-600); }
    
    .case-summary {
        font-size: var(--text-sm);
        color: var(--slate-600);
        line-height: 1.5;
    }
    
    .case-meta {
        display: flex;
        gap: var(--space-md);
        margin-top: var(--space-sm);
        font-size: var(--text-xs);
        color: var(--slate-600);
    }
    
    .case-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        padding: var(--space-sm);
        margin-top: var(--space-sm);
        background: var(--slate-50);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-sm);
        color: var(--slate-600);
        transition: background 0.15s;
    }
    
    .case-toggle:hover {
        background: var(--slate-100);
    }
    
    .case-toggle svg {
        transition: transform 0.2s;
    }
    
    .case-toggle.expanded svg {
        transform: rotate(180deg);
    }
    
    /* ==================== FEES ==================== */
    .fee-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-xs);
        font-size: var(--text-sm);
    }
    
    .fee-label { color: var(--slate-700); }
    .fee-value { font-weight: 600; color: var(--navy-800); }
    .fee-frequency {
        font-size: var(--text-xs);
        color: var(--slate-600);
        margin-left: var(--space-sm);
    }
    
    .fee-note {
        font-size: var(--text-sm);
        color: var(--slate-600);
        margin-top: 4px;
        line-height: 1.3;
        font-style: italic;
    }
    
    /* Fees Caveat Banner */
    .fees-caveat {
        display: flex;
        gap: var(--space-sm);
        padding: var(--space-md);
        background: var(--amber-50);
        border: 1px solid var(--amber-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        color: var(--amber-800);
        font-size: var(--text-sm);
    }
    
    .fees-caveat svg {
        flex-shrink: 0;
        color: var(--amber-500);
    }
    
    .fees-caveat p {
        margin: 0;
    }
    
    /* Fees Source Sections */
    .fees-source-section {
        margin-bottom: var(--space-lg);
    }
    
    .fees-source-section--separated {
        padding-top: var(--space-lg);
        border-top: 1px solid var(--slate-200);
    }
    
    .fees-source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
    }
    
    .fees-source-header h4 {
        margin: 0;
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--navy-800);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .fees-source-link {
        font-size: var(--text-sm);
        color: var(--blue-600);
        text-decoration: none;
    }
    
    .fees-source-link:hover {
        text-decoration: underline;
    }
    
    .fees-context {
        font-size: var(--text-sm);
        color: var(--slate-600);
        margin-bottom: var(--space-md);
        font-style: italic;
    }
    
    .tribunal-fees-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }
    
    .tribunal-fee-group {
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }
    
    .tribunal-fee-group.expandable .tribunal-fee-header {
        cursor: pointer;
    }
    
    .tribunal-fee-group.expandable .tribunal-fee-header:hover {
        background: var(--slate-100);
    }
    
    .tribunal-fee-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
        gap: var(--space-md);
    }
    
    .tribunal-fee-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
    }
    
    .tribunal-fee-type {
        color: var(--slate-700);
        font-weight: 500;
    }
    
    .tribunal-fee-count {
        font-size: var(--text-xs);
        color: var(--slate-600);
    }
    
    .tribunal-fee-details {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        flex-shrink: 0;
    }
    
    .tribunal-fee-amount {
        font-weight: 600;
        color: var(--navy-800);
    }
    
    .tribunal-fee-frequency {
        font-size: var(--text-xs);
        color: var(--slate-600);
        background: var(--slate-200);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
    }
    
    .tribunal-fee-chevron {
        color: var(--slate-400);
        transition: transform 0.2s;
        flex-shrink: 0;
    }
    
    .tribunal-fee-group.expanded .tribunal-fee-chevron {
        transform: rotate(180deg);
    }
    
    .tribunal-fee-details-list {
        display: none;
        border-top: 1px solid var(--slate-200);
        background: var(--white);
    }
    
    .tribunal-fee-group.expanded .tribunal-fee-details-list {
        display: block;
    }
    
    .tribunal-fee-detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-xs) var(--space-md);
        font-size: var(--text-xs);
        border-bottom: 1px solid var(--slate-100);
    }
    
    .tribunal-fee-detail-row:last-child {
        border-bottom: none;
    }
    
    .tribunal-fee-case-link {
        color: var(--blue-600);
    }
    
    .tribunal-fee-detail-amount {
        color: var(--slate-600);
    }
    
    /* ==================== REVIEWS ==================== */
    .review-snippet {
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-sm);
        border-left: 3px solid var(--slate-300);
    }
    
    .review-snippet-text {
        font-size: var(--text-sm);
        color: var(--slate-700);
        line-height: 1.5;
        font-style: italic;
        margin-bottom: var(--space-sm);
    }
    
    .review-snippet-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: var(--text-xs);
        color: var(--slate-600);
    }
    
    .review-rating {
        display: flex;
        align-items: center;
        gap: 2px;
        color: var(--amber-500);
    }
    
    /* Review Source Links */
    .review-sources {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    
    .review-source-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-sm) var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-sm);
        text-decoration: none;
        transition: background 0.15s;
    }
    
    .review-source-row:hover {
        background: var(--slate-100);
        text-decoration: none;
    }
    
    .review-source-info {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }
    
    .platform-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
    }
    
    .platform-icon--google {
        background: #E8F0FE;
        color: #4285F4;
    }
    
    .review-locations-summary {
        font-weight: 600;
        color: var(--navy-800);
        font-size: var(--text-sm);
    }
    
    .review-locations-list {
        display: flex;
        flex-direction: column;
    }
    
    .review-location-row {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        text-decoration: none;
        border-bottom: 1px solid var(--slate-100);
        transition: background 0.15s;
    }
    
    .review-location-row:last-child {
        border-bottom: none;
    }
    
    .review-location-row:hover {
        background: var(--white);
    }
    
    .review-location-name {
        flex: 1;
        font-size: var(--text-sm);
        color: var(--navy-800);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .review-location-stats {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--text-sm);
    }
    
    .review-location-rating {
        font-weight: 600;
        color: var(--amber-600);
    }
    
    .review-location-count {
        color: var(--slate-600);
    }
    
    .review-location-arrow {
        color: var(--slate-400);
        flex-shrink: 0;
    }
    
    .review-location-row:hover .review-location-arrow {
        color: var(--blue-600);
    }
    
    /* ==================== INFO GRID ==================== */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-md) var(--space-xl);
    }
    
    @media (max-width: 480px) {
        .info-grid { grid-template-columns: 1fr; }
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--slate-100);
        font-size: var(--text-sm);
    }
    
    .info-label {
        color: var(--slate-600);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }
    
    .info-value {
        font-weight: 500;
        text-align: right;
    }
    
    .info-value.green { color: var(--green-600); }
    .info-value.red { color: var(--red-600); }
    .info-value.amber { color: var(--amber-600); }
    
    /* ==================== COVERAGE ==================== */
    .coverage-areas-grid {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
    }
    
    .area-tag {
        display: inline-flex;
        align-items: center;
        padding: var(--space-xs) var(--space-sm);
        background: var(--slate-100);
        color: var(--slate-700);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        font-weight: 500;
    }
    
    .coverage-stats {
        display: flex;
        gap: var(--space-xl);
        margin-top: var(--space-lg);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--slate-200);
    }
    
    .coverage-stat {
        text-align: center;
    }
    
    .coverage-stat-value {
        font-family: var(--font-display);
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--navy-800);
    }
    
    .coverage-stat-label {
        font-size: var(--text-sm);
        color: var(--slate-600);
        margin-top: var(--space-xs);
    }
    
    /* ==================== SIMILAR FACTORS ==================== */
    .similar-factors-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-md);
    }
    
    @media (max-width: 768px) {
        .similar-factors-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 480px) {
        .similar-factors-grid { grid-template-columns: 1fr; }
    }
    
    .similar-factor-card {
        padding: var(--space-md);
        background: var(--slate-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--slate-100);
        transition: border-color 0.15s, box-shadow 0.15s;
    }
    
    .similar-factor-card:hover {
        border-color: var(--blue-600);
        box-shadow: var(--shadow-sm);
    }
    
    .similar-factor-name {
        font-weight: 600;
        font-size: var(--text-sm);
        margin-bottom: var(--space-xs);
        color: var(--navy-800);
    }
    
    .similar-factor-name a { color: inherit; }
    
    .similar-factor-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .similar-factor-meta {
        font-size: var(--text-xs);
        color: var(--slate-600);
        margin-top: var(--space-xs);
    }
    
    /* ==================== SIDEBAR ==================== */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    
    .sidebar-card {
        background: var(--white);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .sidebar-section {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--slate-100);
    }
    
    .sidebar-section:last-child {
        border-bottom: none;
    }
    
    .sidebar-title {
        font-family: var(--font-display);
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--navy-900);
        margin-bottom: var(--space-md);
    }
    
    .contact-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
        padding: var(--space-xs) 0;
        font-size: var(--text-sm);
    }
    
    .contact-icon {
        color: var(--slate-400);
        margin-top: 2px;
        flex-shrink: 0;
    }
    
    .contact-value {
        color: var(--slate-700);
        word-break: break-word;
    }
    
    .contact-value a {
        color: var(--blue-600);
    }
    
    /* Source List */
    .source-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .source-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) 0;
        font-size: var(--text-sm);
    }
    
    .source-check {
        width: 16px;
        height: 16px;
    }
    .source-check.available { color: var(--green-600); }
    .source-check.unavailable { color: var(--slate-400); }
    
    /* CTA Box */
    .cta-box {
        background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-950) 100%);
        color: white;
        padding: var(--space-lg);
        text-align: center;
    }
    
    .cta-title {
        font-family: var(--font-display);
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--space-sm);
    }
    
    .cta-text {
        font-size: var(--text-sm);
        opacity: 0.9;
        margin-bottom: var(--space-md);
    }
    
    .cta-highlight {
        font-size: var(--text-xs);
        background: rgba(255,255,255,0.2);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-md);
        display: inline-block;
    }
    
    .cta-button {
        display: inline-block;
        background: white;
        color: var(--navy-900);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .cta-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        text-decoration: none;
    }
    
    .correction-link {
        display: block;
        padding: var(--space-md) var(--space-lg);
        text-align: center;
        font-size: var(--text-sm);
        color: var(--slate-600);
        background: var(--slate-50);
    }
    
    /* Mobile sticky CTA */
    .mobile-cta {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--navy-900);
        color: white;
        padding: var(--space-md);
        text-align: center;
        z-index: 100;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
    }
    
    @media (max-width: 968px) {
        .mobile-cta { display: block; }
        body.has-mobile-cta { padding-bottom: 70px; }
    }
    
    /* ==================== FOOTER ADDITIONS ==================== */
    .footer-disclaimer {
        max-width: 1200px;
        margin: 32px auto 0;
        padding: 16px 24px;
        background: rgba(255,255,255,0.05);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        color: rgba(255,255,255,0.7);
        text-align: center;
    }
    
    .footer-disclaimer a {
        color: rgba(255,255,255,0.9);
        text-decoration: underline;
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
        .profile-header-top {
            flex-direction: column;
        }
        .profile-identity h1 {
            font-size: var(--text-xl);
        }
        .risk-badge {
            align-self: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- ==================== BREADCRUMB ==================== -->
<div class="container">
    <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span>›</span>
        <a href="/factors/">Factors</a>
        <span>›</span>
        <span>{{ profile.name }}</span>
    </nav>
</div>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="container">
    <div class="profile-layout">

    <main class="main-content">
        
        <!-- ==================== ALERT BANNERS ==================== -->
        {% if profile.status != 'registered' %}
        <div class="alert-banner alert-banner--expired" role="alert">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <div class="alert-banner-content">
                <div class="alert-banner-title">Registration Expired</div>
                This profile is included for historical completeness. {{ profile.name }} is no longer registered with the Scottish Property Factor Register and cannot legally provide factoring services.
            </div>
        </div>
        {% endif %}
        
        {% if profile.status == 'registered' and profile.factor_type in ['RSL', 'Housing Association', 'Local Authority'] %}
        <div class="alert-banner alert-banner--info" role="alert">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <div class="alert-banner-content">
                <div class="alert-banner-title">Switching Not Available</div>
                This factor is a {{ profile.factor_type }}. Homeowners in properties managed by this organisation typically cannot choose an alternative factor—the factoring arrangement is tied to the property ownership or tenancy structure.
            </div>
        </div>
        {% endif %}
        
        <!-- ==================== PROFILE HEADER ==================== -->
        {% set band = profile.risk_band|default('CLEAN') %}
        {% set band_lower = band|lower %}
        {% set band_class = 'expired' if profile.status != 'registered' else {'CLEAN': 'clean', 'GREEN': 'green', 'AMBER': 'amber', 'ORANGE': 'orange', 'RED': 'red'}.get(band, 'clean') %}
        
        <div class="profile-header">
            <div class="profile-header-top">
                <div class="profile-identity">
                    <h1>{{ profile.name }}</h1>
                    <div class="profile-meta">
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            {{ profile.registration_number }}
                        </span>
                        {% if profile.factor_type %}
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            {{ profile.factor_type }}
                            <span class="tooltip-trigger" tabindex="0" role="button" aria-describedby="factor-type-tooltip">i<span class="tooltip-content" id="factor-type-tooltip">{% if profile.factor_type == 'Commercial' %}A private company providing factoring services for profit.{% elif profile.factor_type == 'RSL' or profile.factor_type == 'Housing Association' %}A Registered Social Landlord or housing association, typically non-profit.{% elif profile.factor_type == 'Sole Proprietor' %}An individual operating as a property factor.{% elif profile.factor_type == 'Local Authority' %}A council or local government body.{% else %}{{ profile.factor_type }}{% endif %}</span></span>
                        </span>
                        {% endif %}
                        <span class="profile-meta-item">
                            {% if profile.status == 'registered' %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--green-600)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span style="color: var(--green-600); font-weight: 500;">Active</span>
                            {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gray-500)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span style="color: var(--gray-500); font-weight: 500;">Expired</span>
                            {% endif %}
                        </span>
                        {% if profile.property_count %}
                        <span class="profile-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                            {{ "{:,}".format(profile.property_count) }} properties
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Risk Badge with Composite Score -->
                {% set score = profile.tribunal_composite_score|default(100) %}
                <div class="risk-badge {{ band_class }}" role="status" aria-label="{% if profile.status != 'registered' %}Historical tribunal rating{% else %}Tribunal risk rating: {{ band }}{% endif %}">
                    <div class="risk-badge-main">
                        {% if profile.status != 'registered' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        {{ band }}
                        {% elif band == 'CLEAN' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        {{ band }}
                        {% elif band == 'RED' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        {{ band }}
                        {% else %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        {{ band }}
                        {% endif %}
                    </div>
                    <div class="risk-badge-reason">
                        {% if profile.status != 'registered' %}Historical record{% elif band == 'CLEAN' %}No upheld cases{% elif profile.tribunal_pfeo_penalty and profile.tribunal_pfeo_penalty > 0 %}Includes PFEO penalty{% else %}Tribunal record{% endif %}
                    </div>
                </div>
            </div>
            
            <!-- ==================== VERDICT BOX ==================== -->
            <div class="verdict-box {{ band_lower }}">
                <div class="verdict-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    Our Verdict
                </div>
                <p class="verdict-text">
                    {% if at_a_glance and at_a_glance.summary %}
                        {{ at_a_glance.summary }}
                    {% else %}
                        {{ profile.name }} is a <strong>
                        {% if profile.property_count and profile.property_count > 5000 %}large{% elif profile.property_count and profile.property_count > 1000 %}mid-sized{% else %}small{% endif %}
                        </strong> factor{% if profile.coverage_areas %} operating primarily in <strong>{{ profile.coverage_areas.split(',')[0].strip().replace('"', '').replace('&#34;', '') }}</strong> and surrounding areas{% endif %}.
                        
                        Based on our data, they hold a <strong>{{ band }}</strong> risk rating.
                        {% if band == 'CLEAN' %}
                        They have no significant tribunal history, suggesting a reliable service record.
                        {% elif band == 'AMBER' %}
                        Potential clients should be aware of a moderate frequency of tribunal disputes relative to their size.
                        {% elif band == 'RED' %}
                        They have a higher-than-average volume of tribunal cases or enforcement orders, which is a significant concern.
                        {% endif %}
                    {% endif %}
                </p>
            </div>
            
            <!-- ==================== AT A GLANCE ==================== -->
            {% if at_a_glance and at_a_glance.bullets %}
            <div class="at-a-glance">
                <div class="at-a-glance-header">
                    <span class="at-a-glance-title">At a Glance</span>
                    <span class="at-a-glance-badge">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        AI Summary
                    </span>
                </div>
                <ul class="at-a-glance-list">
                    {% for bullet in at_a_glance.bullets %}
                    <li class="at-a-glance-item">
                        {% if bullet.sentiment == 'positive' %}
                        <svg class="at-a-glance-icon positive" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        {% elif bullet.sentiment == 'negative' %}
                        <svg class="at-a-glance-icon negative" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        {% else %}
                        <svg class="at-a-glance-icon neutral" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        {% endif %}
                        <span>{{ bullet.text }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        
        <!-- ==================== REST OF CONTENT ==================== -->
        <!-- TRIBUNAL RECORD CARD -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Tribunal Record (Last 5 Years)
                </h2>
                <div class="card-header-links">
                    {% if tribunal_full_history.case_count > 0 %}
                    <a href="/factors/{{ profile.registration_number|lower }}/tribunal/" class="card-link">Full history →</a>
                    {% endif %}
                    <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" class="card-link" target="_blank" rel="noopener">View on HPC →</a>
                </div>
            </div>
            <div class="card-body">
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-value">{{ tribunal_last_5_years.case_count }}</div>
                        <div class="data-label">Cases</div>
                    </div>
                    <div class="data-item">
                        <div class="data-value {% if tribunal_last_5_years.pfeo_count > 0 %}red{% endif %}">{{ tribunal_last_5_years.pfeo_count }}</div>
                        <div class="data-label">PFEOs Issued</div>
                    </div>
                    <div class="data-item">
                        <div class="data-value {% if tribunal_last_5_years.complaints_upheld_pct and tribunal_last_5_years.complaints_upheld_pct > 50 %}red{% elif tribunal_last_5_years.complaints_upheld_pct and tribunal_last_5_years.complaints_upheld_pct > 30 %}amber{% else %}green{% endif %}">{{ tribunal_last_5_years.complaints_upheld_pct|default(0)|int }}%</div>
                        <div class="data-label">Upheld Rate</div>
                    </div>
                    <div class="data-item">
                        <div class="data-value">£{{ "{:,.0f}".format(tribunal_last_5_years.compensation|default(0)) }}</div>
                        <div class="data-label">Compensation</div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                Data extracted by AI from official Housing & Property Chamber records. <a href="/methodology/#tribunal" target="_blank">Learn about our methodology</a>.
            </div>
        </div>
        
        <!-- RECENT DECISIONS -->
        {% if recent_cases %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Recent Decisions
                </h2>
                <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" class="card-link" target="_blank" rel="noopener">View all on HPC →</a>
            </div>
            <div class="card-body">
                <div id="cases-list">
                    {% for case in recent_cases %}
                    <div class="case-card {% if loop.index > 3 %}hidden{% endif %}">
                        <div class="case-header">
                            <div>
                                <a href="{{ case.pdf_url or 'https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions' }}" class="case-ref" target="_blank" rel="noopener">{{ case.case_reference }}</a>
                                <span class="case-date">{{ case.decision_date }}</span>
                            </div>
                            {% set outcome = case.outcome|default('Unknown') %}
                            {% set outcome_class = 'upheld' if 'upheld' in outcome|lower or 'granted' in outcome|lower else 'dismissed' if 'dismissed' in outcome|lower or 'refused' in outcome|lower else 'partial' if 'partial' in outcome|lower else 'withdrawn' if 'withdrawn' in outcome|lower else 'settled' if 'settled' in outcome|lower else 'neutral' %}
                            <span class="case-outcome {{ outcome_class }}">{{ outcome }}</span>
                        </div>
                        {% if case.key_quote %}
                        <p class="case-summary">"{{ case.key_quote }}"</p>
                        {% endif %}
                        <div class="case-meta">
                            {% if case.compensation_awarded and case.compensation_awarded > 0 %}
                            <span>Compensation: £{{ "{:,.0f}".format(case.compensation_awarded) }}</span>
                            {% endif %}
                            {% if case.pfeo_issued %}
                            <span style="color: var(--red-600); font-weight: 600;">PFEO Issued</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if recent_cases|length > 3 %}
                <div class="case-toggle" id="cases-toggle" onclick="toggleCases()">
                    <span id="toggle-text">Show {{ recent_cases|length - 3 }} more recent cases</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                Case data extracted by AI from official Housing & Property Chamber decision PDFs. Verify important details with <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener">official records</a>.
            </div>
        </div>
        {% endif %}
        
        <!-- REVIEWS CARD -->
        {% if profile.google_rating or profile.trustpilot_rating %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    Reviews
                </h2>
            </div>
            <div class="card-body">
                <div class="review-sources">
                    {% if google_locations and google_locations|length > 1 %}
                    <!-- Multiple Google locations -->
                    <div class="review-locations-breakdown">
                        <div class="review-locations-summary" style="margin-bottom: var(--space-sm);">
                            <span class="platform-icon platform-icon--google">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            </span>
                            Google ({{ google_locations|length }} locations)
                        </div>
                        <div class="review-locations-list">
                            {% for loc in google_locations %}
                            <a href="https://search.google.com/local/reviews?placeid={{ loc.place_id }}" class="review-location-row" target="_blank" rel="noopener">
                                <span class="review-location-name">{{ loc.name or 'Location' }}</span>
                                <div class="review-location-stats">
                                    <span class="review-location-rating">{{ "%.1f"|format(loc.rating) if loc.rating else '—' }}★</span>
                                    <span class="review-location-count">({{ loc.review_count or 0 }})</span>
                                </div>
                                <svg class="review-location-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif google_places %}
                    <!-- Single Google location -->
                    <a href="https://search.google.com/local/reviews?placeid={{ google_places.place_id }}" class="review-source-row" target="_blank" rel="noopener">
                        <div class="review-source-info">
                            <span class="platform-icon platform-icon--google">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            </span>
                            <span style="font-weight: 600; color: var(--navy-800);">Google Reviews</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <span style="font-weight: 600; color: var(--amber-600);">{{ "%.1f"|format(profile.google_rating) if profile.google_rating else '—' }}★</span>
                            <span style="color: var(--slate-600);">({{ profile.google_review_count|default(0) }})</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </a>
                    {% endif %}
                    
                    {% if trustpilot and trustpilot.url %}
                    <a href="{{ trustpilot.url }}" class="review-source-row" target="_blank" rel="noopener">
                        <div class="review-source-info">
                            <span class="platform-icon" style="background: #E6F4E6; color: #00B67A;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </span>
                            <span style="font-weight: 600; color: var(--navy-800);">Trustpilot</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <span style="font-weight: 600; color: var(--amber-600);">{{ "%.1f"|format(profile.trustpilot_rating) if profile.trustpilot_rating else '—' }}★</span>
                            <span style="color: var(--slate-600);">({{ profile.trustpilot_review_count|default(0) }})</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- FEES CARD -->
        {% if wss or case_fees %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Fee Information
                </h2>
            </div>
            <div class="card-body">
                <div class="fees-caveat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    <p>Fees shown are examples and may vary based on your specific development, property size, and service requirements. Always request a detailed quote.</p>
                </div>
                
                {% if wss %}
                <div class="fees-source-section">
                    <div class="fees-source-header">
                        <h4>From Written Statement of Services</h4>
                    </div>
                    {% if wss.management_fee_amount %}
                    <div class="fee-row">
                        <span class="fee-label">Management Fee</span>
                        <span>
                            {% if wss.management_fee_amount|string|has_numbers %}
                            <span class="fee-value">£{{ wss.management_fee_amount }}</span>
                            {% if wss.management_fee_frequency %}<span class="fee-frequency">{{ wss.management_fee_frequency }}</span>{% endif %}
                            {% else %}
                            <span class="fee-value">Varies</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if not wss.management_fee_amount|string|has_numbers %}
                    <p class="fee-note">{{ wss.management_fee_amount }}</p>
                    {% endif %}
                    {% endif %}
                    {% if wss.late_payment_fee %}
                    <div class="fee-row">
                        <span class="fee-label">Late Payment Fee</span>
                        <span class="fee-value">£{{ wss.late_payment_fee }}</span>
                    </div>
                    {% endif %}
                    {% if wss.insurance_commission_pct %}
                    <div class="fee-row">
                        <span class="fee-label">Insurance Commission</span>
                        <span class="fee-value">{{ wss.insurance_commission_pct }}%</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if case_fees %}
                <div class="fees-source-section {% if wss %}fees-source-section--separated{% endif %}">
                    <div class="fees-source-header">
                        <h4>From Tribunal Records</h4>
                    </div>
                    <p class="fees-context">Fee amounts disclosed in tribunal proceedings:</p>
                    <div class="tribunal-fees-list">
                        {% for fee in case_fees %}
                        <div class="tribunal-fee-group {% if fee.example_count > 1 %}expandable{% endif %}" onclick="{% if fee.example_count > 1 %}this.classList.toggle('expanded'){% endif %}">
                            <div class="tribunal-fee-header">
                                <div class="tribunal-fee-info">
                                    <span class="tribunal-fee-type">{{ fee.fee_type }}</span>
                                    {% if fee.example_count > 1 %}
                                    <span class="tribunal-fee-count">{{ fee.example_count }} examples</span>
                                    {% endif %}
                                </div>
                                <div class="tribunal-fee-details">
                                    <span class="tribunal-fee-amount">
                                        {% if fee.amount_min == fee.amount_max %}
                                        £{{ "{:,.0f}".format(fee.amount_min) }}
                                        {% else %}
                                        £{{ "{:,.0f}".format(fee.amount_min) }}–£{{ "{:,.0f}".format(fee.amount_max) }}
                                        {% endif %}
                                    </span>
                                    {% if fee.frequency %}
                                    <span class="tribunal-fee-frequency">{{ fee.frequency }}</span>
                                    {% endif %}
                                    {% if fee.example_count > 1 %}
                                    <svg class="tribunal-fee-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    {% elif fee.details and fee.details[0].pdf_url %}
                                    <a href="{{ fee.details[0].pdf_url }}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="color: var(--blue-600); font-size: var(--text-xs);">{{ fee.details[0].case_reference }}</a>
                                    {% endif %}
                                </div>
                            </div>
                            {% if fee.example_count > 1 and fee.details %}
                            <div class="tribunal-fee-details-list">
                                {% for detail in fee.details %}
                                <div class="tribunal-fee-detail-row">
                                    {% if detail.pdf_url %}
                                    <a href="{{ detail.pdf_url }}" class="tribunal-fee-case-link" target="_blank" rel="noopener" onclick="event.stopPropagation()">{{ detail.case_reference }}</a>
                                    {% else %}
                                    <span>{{ detail.case_reference }}</span>
                                    {% endif %}
                                    <span class="tribunal-fee-detail-amount">£{{ "{:,.0f}".format(detail.amount) }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- COVERAGE CARD -->
        {% if profile.coverage_areas or profile.property_count or profile.postcode_count %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    Coverage Area
                </h2>
            </div>
            <div class="card-body">
                {% if profile.coverage_areas %}
                <div class="coverage-areas-grid">
                    {% for area in profile.coverage_areas.split(',')[:20] %}
                    {% set clean_area = area.strip().replace('"', '').replace('&#34;', '') %}
                    {% if clean_area %}
                    <span class="area-tag">{{ clean_area }}</span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if profile.property_count or profile.postcode_count %}
                <div class="coverage-stats">
                    {% if profile.property_count %}
                    <div class="coverage-stat">
                        <div class="coverage-stat-value">{{ "{:,}".format(profile.property_count) }}</div>
                        <div class="coverage-stat-label">Properties Managed</div>
                    </div>
                    {% endif %}
                    {% if profile.postcode_count %}
                    <div class="coverage-stat">
                        <div class="coverage-stat-value">{{ profile.postcode_count }}</div>
                        <div class="coverage-stat-label">Postcode Sectors</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- QUICK ACTIONS CTA -->
        {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
        <div class="card" style="background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-950) 100%); color: white; border: none;">
            <div class="card-body" style="text-align: center; padding: var(--space-xl);">
                <h3 style="font-family: var(--font-display); font-size: 1.25rem; margin-bottom: var(--space-sm); color: white;">Considering a switch?</h3>
                <p style="margin-bottom: var(--space-lg); opacity: 0.9;">Compare quotes from vetted factors serving your area. Free, no obligation.</p>
                <a href="/get-quotes/?from={{ profile.registration_number }}" class="cta-button">Get Free Quotes →</a>
            </div>
        </div>
        {% endif %}
        
    </main>
    
    <!-- ==================== SIDEBAR ==================== -->
    <aside class="sidebar">
        <div class="sidebar-card">
            <!-- CTA Box (if switchable) -->
            {% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
            <div class="cta-box">
                <h3 class="cta-title">Unhappy with {{ profile.name.split()[0] }}?</h3>
                <p class="cta-text">Compare quotes from better-rated factors in your area</p>
                <a href="/get-quotes/?from={{ profile.registration_number }}" class="cta-button">Get Free Quotes</a>
            </div>
            {% endif %}
            
            <!-- Quick Links -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Quick Links</h3>
                <ul class="source-list">
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        <a href="https://www.gov.scot/publications/property-factor-register/" target="_blank" rel="noopener">View on Official Register</a>
                    </li>
                    {% if profile.website %}
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                        <a href="{{ profile.website }}" target="_blank" rel="noopener">Official Website</a>
                    </li>
                    {% endif %}
                    <li class="source-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        <a href="/guides/how-to-switch-factors-scotland/">How to Switch Factors</a>
                    </li>
                </ul>
            </div>
            
            <!-- Contact Info -->
            {% if google_places or profile.website %}
            <div class="sidebar-section">
                <h3 class="sidebar-title">Contact</h3>
                {% if profile.website %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span class="contact-value"><a href="{{ profile.website }}" target="_blank" rel="noopener">{{ profile.website|replace('https://', '')|replace('http://', '')|replace('www.', '')|truncate(30) }}</a></span>
                </div>
                {% endif %}
                {% if google_places and google_places.phone %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    <span class="contact-value">{{ google_places.phone }}</span>
                </div>
                {% endif %}
                {% if google_places and google_places.address %}
                <div class="contact-item">
                    <svg class="contact-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <span class="contact-value">{{ google_places.address }}</span>
                </div>
                {% endif %}
                {% if not google_places and not profile.website %}
                <p style="color: var(--slate-600); font-size: var(--text-sm);">No contact information available.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Data Sources -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Data Sources</h3>
                <ul class="source-list">
                    <li class="source-item">
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <a href="https://www.gov.scot/publications/property-factor-register/" target="_blank" rel="noopener">Property Factor Register</a>
                    </li>
                    <li class="source-item">
                        {% if tribunal_full_history.case_count > 0 %}
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        {% else %}
                        <svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        {% endif %}
                        <span>Tribunal ({{ tribunal_full_history.case_count|default(0) }} cases)</span>
                    </li>
                    <li class="source-item">
                        {% if profile.ch_number %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Companies House</span>
                    </li>
                    <li class="source-item">
                        {% if profile.google_rating %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Google ({{ profile.google_review_count|default(0) }} reviews)</span>
                    </li>
                    <li class="source-item">
                        {% if profile.trustpilot_rating %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>Trustpilot ({{ profile.trustpilot_review_count|default(0) }} reviews)</span>
                    </li>
                </ul>
            </div>
            
            <!-- Accreditation -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Accreditation</h3>
                <ul class="source-list">
                    <li class="source-item">
                        {% if profile.status == 'registered' %}
                        <svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>Scottish PF Register</span>
                        {% else %}
                        <svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        <span>Previously registered</span>
                        {% endif %}
                    </li>
                    <li class="source-item">
                        {% if profile.tpi_member %}<svg class="source-check available" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>{% else %}<svg class="source-check unavailable" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>{% endif %}
                        <span>TPI Scotland Member</span>
                    </li>
                </ul>
            </div>
        </div>
        
    </aside>
    
</div>

</div>

<!-- Mobile Sticky CTA (hidden for non-switchable factor types and expired registrations) -->
{% if profile.status == 'registered' and profile.factor_type not in ['RSL', 'Housing Association', 'Local Authority'] %}
<div class="mobile-cta">
    <a href="/get-quotes/?from={{ profile.registration_number }}" style="color: white; font-weight: 600;">Get Free Quotes from Better-Rated Factors →</a>
</div>
{% endif %}

<!-- Page-specific footer disclaimer -->
<div class="footer-disclaimer" style="max-width: 1200px; margin: 0 auto var(--space-lg); padding: 16px 24px; background: var(--slate-100); border-radius: var(--radius-md); font-size: var(--text-sm); color: var(--slate-600); text-align: center;">
    Some summaries and statistics on this page are AI-generated from official sources. Always verify important information with <a href="https://housingandpropertychamber.scot/apply-tribunal/property-factors/property-factors-decisions" target="_blank" rel="noopener" style="color: var(--blue-600);">official HPC records</a>.
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCases() {
    const casesList = document.getElementById('cases-list');
    const toggle = document.getElementById('cases-toggle');
    const toggleText = document.getElementById('toggle-text');
    const hiddenCases = casesList.querySelectorAll('.case-card.hidden');
    const visibleCases = casesList.querySelectorAll('.case-card:not(.hidden)');
    
    if (hiddenCases.length > 0) {
        hiddenCases.forEach(card => card.classList.remove('hidden'));
        toggleText.textContent = 'Show fewer cases';
        toggle.classList.add('expanded');
    } else {
        const cards = casesList.querySelectorAll('.case-card');
        cards.forEach((card, i) => {
            if (i >= 3) card.classList.add('hidden');
        });
        toggleText.textContent = 'Show ' + (cards.length - 3) + ' more recent cases';
        toggle.classList.remove('expanded');
    }
}
</script>
{% endblock %}